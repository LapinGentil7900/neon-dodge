<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON DODGE - PRO NETWORK</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>

<canvas id="bgCanvas"></canvas>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-menu" class="screen">
    <div id="user-tag" onclick="UI.show('layer-profile')">
        <div id="user-tag-avatar"></div>
        <span id="user-tag-name">Non connectÃ©</span>
    </div>
    <div class="menu-logo">
        <h1 class="neon-title" id="main-title" onclick="DevTools.titleClick()">NEON</h1>
        <h1 class="neon-title neon-title-2">DODGE</h1>
        <div class="title-sub">PRO NETWORK v2.0</div>
    </div>
    <p id="dev-hint">CLIQUEZ ENCORE... <span id="dev-hint-count">0</span>/5</p>
    <div id="menu-hs-block">
        <div class="hs-label">MEILLEUR SCORE</div>
        <div class="hs-value" id="hs-val">0</div>
    </div>
    <div class="menu-grid">
        <button class="btn btn-play" onclick="Game.start()"><span class="btn-icon">â–¶</span> JOUER</button>
        <button class="btn btn-blue" onclick="UI.show('layer-shop')"><span class="btn-icon">â—ˆ</span> BOUTIQUE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-lead')"><span class="btn-icon">â—‰</span> CLASSEMENT</button>
        <button class="btn btn-blue" onclick="UI.show('layer-profile')"><span class="btn-icon">â—</span> COMPTE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-stats')"><span class="btn-icon">â—ˆ</span> STATS</button>
        <button class="btn btn-red"  onclick="UI.confirmQuit()"><span class="btn-icon">âœ•</span> QUITTER</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOUTIQUE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-shop" class="screen" style="display:none;">
    <div class="screen-header">
        <h2 class="screen-title">â—ˆ BOUTIQUE</h2>
        <div class="credits-badge"><span>â—†</span><span id="shop-credits">0</span> crÃ©dits</div>
    </div>
    <div id="skin-list" class="skin-grid"></div>
    <button class="btn btn-red back-btn" onclick="UI.show('layer-menu')">â† RETOUR</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CLASSEMENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-lead" class="screen" style="display:none;">
    <h2 class="screen-title">â—‰ TOP JOUEURS</h2>
    <div id="leaderboard-content" class="leaderboard-list"></div>
    <button class="btn btn-red back-btn" onclick="UI.show('layer-menu')">â† RETOUR</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PROFIL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-profile" class="screen" style="display:none;">
    <div id="profile-connected" style="display:none; flex-direction:column; align-items:center; gap:20px;">
        <div id="profile-avatar-wrap">
            <img id="profile-avatar" src="" alt="" style="display:none;">
            <div id="profile-avatar-fallback">?</div>
            <div class="avatar-ring"></div>
        </div>
        <h2 id="profile-username" class="profile-name">-</h2>
        <div id="profile-role-badge"></div>
        <div class="profile-stats">
            <div class="stat-box"><div class="stat-val" id="profile-credits">0</div><div class="stat-lbl">CRÃ‰DITS</div></div>
            <div class="stat-box stat-box-hs"><div class="stat-val" id="profile-hs">0</div><div class="stat-lbl">HIGH SCORE</div></div>
            <div class="stat-box"><div class="stat-val stat-val-sm" id="profile-level">-</div><div class="stat-lbl">NIVEAU MAX</div></div>
        </div>
        <button class="btn btn-red" onclick="Auth.logout()">DÃ‰CONNEXION</button>
        <button class="btn back-btn" onclick="UI.show('layer-menu')">â† RETOUR</button>
    </div>
    <div id="profile-guest" style="display:none; flex-direction:column; align-items:center; gap:16px;">
        <div class="guest-icon">â—</div>
        <h2>TERMINAL OS</h2>
        <p class="guest-desc">Connecte-toi pour sauvegarder tes scores, acheter des skins et figurer au classement.</p>
        <button class="btn btn-play" onclick="UI.show('layer-auth')">CONNEXION</button>
        <button class="btn back-btn" onclick="UI.show('layer-menu')">â† RETOUR</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-auth" class="screen" style="display:none;">
    <h2 class="screen-title">ACCÃˆS RÃ‰SEAU</h2>
    <div class="auth-tabs">
        <button id="tab-login"    class="tab-btn tab-active" onclick="Auth.switchTab('login')">CONNEXION</button>
        <button id="tab-register" class="tab-btn"            onclick="Auth.switchTab('register')">INSCRIPTION</button>
    </div>
    <div id="form-login" class="auth-form">
        <div class="input-wrap"><span class="input-icon">â—</span><input type="text" id="login-user" placeholder="Pseudo" autocomplete="username"></div>
        <div class="input-wrap"><span class="input-icon">â—†</span><input type="password" id="login-pass" placeholder="Mot de passe" autocomplete="current-password"></div>
        <div id="login-error" class="form-error"></div>
        <button class="btn btn-play" onclick="Auth.login()">SE CONNECTER</button>
    </div>
    <div id="form-register" class="auth-form" style="display:none;">
        <div class="input-wrap"><span class="input-icon">â—</span><input type="text" id="reg-user" placeholder="Pseudo (3-20 caractÃ¨res)" autocomplete="username"></div>
        <div class="input-wrap"><span class="input-icon">â—†</span><input type="password" id="reg-pass" placeholder="Mot de passe (6+ caractÃ¨res)" autocomplete="new-password"></div>
        <label class="file-label" for="reg-avatar">
            <span id="file-label-text">ğŸ“· Photo de profil (optionnel Â· max 2 Mo)</span>
            <input type="file" id="reg-avatar" accept="image/jpeg,image/png,image/webp" onchange="Auth.previewAvatar(this)">
        </label>
        <img id="avatar-preview" class="avatar-preview-img" style="display:none;" alt="">
        <div id="reg-error" class="form-error"></div>
        <button class="btn btn-play" onclick="Auth.register()">CRÃ‰ER LE COMPTE</button>
    </div>
    <button class="btn btn-red back-btn" onclick="UI.show('layer-menu')">â† RETOUR</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-stats" class="screen" style="display:none;">
    <h2 class="screen-title">â—ˆ STATISTIQUES</h2>
    <div id="stats-content" class="stats-grid"></div>
    <button class="btn btn-red back-btn" onclick="UI.show('layer-menu')">â† RETOUR</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JEU â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-game" style="display:none; position:relative; width:100%; height:100%;">
    <canvas id="gameCanvas"></canvas>
    <div id="hud">
        <div id="score-container">SCORE <span id="ui-score">0</span></div>
        <div id="level-hud">
            <span id="ui-level-name">TUTORIAL</span>
            <span id="ui-level-desc"></span>
        </div>
        <div id="ui-tier"></div>
        <div id="next-level-bar"><div id="next-level-fill"></div></div>
        <div id="next-level-label"></div>
    </div>
    <button id="btn-pause" onclick="Game.togglePause()">â¸</button>
    <div id="level-announce"></div>
    <div id="pause-menu" style="display:none;">
        <div class="pause-inner">
            <h2 class="pause-title">â¸ PAUSE</h2>
            <p id="pause-score-info"></p>
            <button class="btn btn-play" onclick="Game.togglePause()">â–¶ REPRENDRE</button>
            <button class="btn btn-red"  onclick="Game.quit()">âœ• QUITTER</button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME OVER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-death" class="screen" style="display:none;">
    <div class="death-container">
        <div class="death-glitch" id="death-glitch-text">GAME OVER</div>
        <h2 class="death-title">GAME OVER</h2>
        <div id="death-stats" class="death-stats-wrap"></div>
        <div class="death-actions">
            <button class="btn btn-play" onclick="Game.start()">â†º REJOUER</button>
            <button class="btn btn-blue" onclick="UI.show('layer-menu')">âŒ‚ MENU</button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONFIRM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-confirm" class="screen" style="display:none;">
    <h2>QUITTER ?</h2>
    <p style="color:#888;font-size:12px;">Ta progression locale sera conservÃ©e.</p>
    <button class="btn btn-red"  onclick="window.close()">OUI, QUITTER</button>
    <button class="btn btn-blue" onclick="UI.show('layer-menu')">ANNULER</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DEV TOOLS SIDEBAR (toujours prÃ©sente) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="devtools-overlay" onclick="DevTools.closeSidebar()"></div>

<!-- Bouton toggle admin toujours visible -->
<button id="admin-toggle-btn" onclick="DevTools.toggleSidebar()" style="display:none;">
    âš™ ADMIN
</button>

<div id="devtools-sidebar">
    <div class="devtools-header">
        <div>
            <div style="font-size:13px; font-weight:700; color:#ffcc00; text-shadow:0 0 10px #ffcc00;">âš™ ADMIN PANEL</div>
            <div id="dev-admin-name" style="font-size:9px; color:#ffcc0066; margin-top:2px;"></div>
        </div>
        <button class="devtools-close" onclick="DevTools.closeSidebar()">âœ•</button>
    </div>

    <!-- TABS -->
    <div class="dev-tabs">
        <button class="dev-tab active" onclick="DevTools.switchTab('tools')" id="dtab-tools">OUTILS</button>
        <button class="dev-tab" onclick="DevTools.switchTab('users')"  id="dtab-users">JOUEURS</button>
        <button class="dev-tab" onclick="DevTools.switchTab('stats')"  id="dtab-stats">STATS</button>
    </div>

    <!-- TAB : OUTILS DEV -->
    <div id="devpanel-tools" class="devtools-body">
        <div class="dev-section-title">INFORMATIONS</div>
        <div id="dev-info" class="dev-info-block">â€”</div>

        <div class="dev-section-title">CRÃ‰DITS (LOCAL)</div>
        <div class="dev-row">
            <input type="number" id="dev-credits" value="0">
            <button class="dev-btn" onclick="DevTools.setCredits()">SET</button>
        </div>

        <div class="dev-section-title">HIGH SCORE (LOCAL)</div>
        <div class="dev-row">
            <input type="number" id="dev-hs" value="0">
            <button class="dev-btn" onclick="DevTools.setHS()">SET</button>
        </div>

        <div class="dev-section-title">SCORE EN JEU</div>
        <div class="dev-row">
            <input type="number" id="dev-score" value="0">
            <button class="dev-btn" onclick="DevTools.setScore()">SET</button>
        </div>

        <div class="dev-section-title">SKINS</div>
        <button class="dev-btn dev-btn-full" onclick="DevTools.unlockAll()">DÃ‰BLOQUER TOUS</button>

        <div class="dev-section-title">INVINCIBILITÃ‰</div>
        <button class="dev-btn dev-btn-full" id="btn-god" onclick="DevTools.toggleGod()">MODE GOD : OFF</button>

        <div class="dev-section-title" style="color:#ff4444;">DANGER</div>
        <button class="dev-btn dev-btn-full dev-btn-red" onclick="DevTools.reset()">âš  RESET LOCAL</button>
    </div>

    <!-- TAB : JOUEURS -->
    <div id="devpanel-users" class="devtools-body" style="display:none;">
        <div style="display:flex; gap:6px; margin-bottom:8px;">
            <input type="text" id="admin-search" placeholder="Rechercher..." style="flex:1; background:#111; border:1px solid #ffcc0033; color:#fff; padding:6px 10px; font-family:Orbitron; font-size:10px; outline:none;" oninput="DevTools.filterUsers()">
            <button class="dev-btn" onclick="DevTools.loadUsers()">â†º</button>
        </div>
        <div id="admin-stats-bar" class="admin-stats-bar"></div>
        <div id="admin-user-list" class="admin-user-list">
            <div class="loading-text">Clique â†º pour charger</div>
        </div>
    </div>

    <!-- TAB : STATS GLOBALES -->
    <div id="devpanel-stats" class="devtools-body" style="display:none;">
        <div id="admin-global-stats" class="admin-global-stats">
            <div class="loading-text">Chargement...</div>
        </div>
        <button class="dev-btn dev-btn-full" onclick="DevTools.loadGlobalStats()" style="margin-top:8px;">â†º ACTUALISER</button>
    </div>
</div>

<script src="levels.js"></script>
<script src="stats_manager.js"></script>
<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKGROUND CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BgCanvas = {
    canvas: document.getElementById('bgCanvas'),
    ctx: null, particles: [], animFrame: null,
    init() {
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        for (let i = 0; i < 120; i++) {
            this.particles.push({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, size: Math.random()*1.5+0.2, speed: Math.random()*0.5+0.1, opacity: Math.random()*0.5+0.1, color: Math.random()>0.7?'#ff3838':'#00f3ff' });
        }
        this.loop();
    },
    resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
    loop() {
        const C = this.ctx;
        C.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.particles.forEach(p => {
            p.y += p.speed; if (p.y > this.canvas.height) { p.y = 0; p.x = Math.random()*this.canvas.width; }
            C.globalAlpha = p.opacity; C.fillStyle = p.color; C.shadowBlur = 6; C.shadowColor = p.color;
            C.beginPath(); C.arc(p.x, p.y, p.size, 0, Math.PI*2); C.fill();
        });
        C.globalAlpha = 1; C.shadowBlur = 0;
        this.animFrame = requestAnimationFrame(() => this.loop());
    },
    show() { this.canvas.style.display = 'block'; },
    hide() { this.canvas.style.display = 'none'; }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = {
    BASE: '/api',
    _headers(multipart=false) {
        const h = {};
        if (Auth.token) h['Authorization'] = 'Bearer ' + Auth.token;
        if (!multipart) h['Content-Type'] = 'application/json';
        return h;
    },
    async post(path, body, multipart=false) {
        try { const r = await fetch(this.BASE+path, { method:'POST', headers:this._headers(multipart), body: multipart?body:JSON.stringify(body) }); return r.json(); }
        catch(e) { return { error: 'Erreur rÃ©seau.' }; }
    },
    async get(path) {
        try { const r = await fetch(this.BASE+path, { headers:this._headers() }); return r.json(); }
        catch(e) { return { error: 'Erreur rÃ©seau.' }; }
    },
    async delete(path, body) {
        try { const r = await fetch(this.BASE+path, { method:'DELETE', headers:this._headers(), body:JSON.stringify(body) }); return r.json(); }
        catch(e) { return { error: 'Erreur rÃ©seau.' }; }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CATALOGUE SKINS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SKINS_CATALOG = [
    { id:'neon_blue', name:'Neon Blue', color:'#00f3ff', price:0,     tier:'FREE'       },
    { id:'emerald',   name:'Emerald',   color:'#00ff88', price:500,   tier:'COMMUN'     },
    { id:'ruby',      name:'Ruby',      color:'#ff3838', price:1500,  tier:'RARE'       },
    { id:'gold',      name:'Gold',      color:'#ffcc00', price:3000,  tier:'Ã‰PIQUE'     },
    { id:'violet',    name:'Violet',    color:'#cc00ff', price:5000,  tier:'Ã‰PIQUE'     },
    { id:'white',     name:'White',     color:'#ffffff', price:8000,  tier:'LÃ‰GENDAIRE' },
    { id:'inferno',   name:'Inferno',   color:'#ff4400', price:12000, tier:'LÃ‰GENDAIRE' },
    { id:'ghost',     name:'Ghost',     color:'#aaaaaa', price:20000, tier:'MYTHIQUE'   }
];
const TIER_COLORS = { 'FREE':'#888','COMMUN':'#00ff88','RARE':'#0088ff','Ã‰PIQUE':'#cc00ff','LÃ‰GENDAIRE':'#ffcc00','MYTHIQUE':'#ff4400' };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Auth = {
    token: localStorage.getItem('nd_token') || null,
    user:  JSON.parse(localStorage.getItem('nd_user') || 'null'),

    isAdmin() { return this.user?.role === 'admin'; },

    switchTab(tab) {
        const isLogin = tab === 'login';
        document.getElementById('form-login').style.display    = isLogin ? 'flex' : 'none';
        document.getElementById('form-register').style.display = isLogin ? 'none' : 'flex';
        document.getElementById('tab-login').classList.toggle('tab-active', isLogin);
        document.getElementById('tab-register').classList.toggle('tab-active', !isLogin);
        document.getElementById('login-error').innerText = '';
        document.getElementById('reg-error').innerText   = '';
    },

    previewAvatar(input) {
        const file = input.files[0]; if (!file) return;
        document.getElementById('file-label-text').innerText = 'âœ… ' + file.name;
        const p = document.getElementById('avatar-preview');
        p.src = URL.createObjectURL(file); p.style.display = 'block';
    },

    async login() {
        const user = document.getElementById('login-user').value.trim();
        const pass = document.getElementById('login-pass').value;
        const err  = document.getElementById('login-error');
        err.innerText = '';
        if (!user || !pass) { err.innerText = 'Remplis tous les champs.'; return; }
        const btn = document.querySelector('#form-login .btn-play');
        btn.innerText = 'âŸ³ CONNEXION...'; btn.disabled = true;
        const data = await API.post('/auth/login', { username:user, password:pass });
        btn.innerText = 'SE CONNECTER'; btn.disabled = false;
        if (data.error) { err.innerText = data.error; return; }
        this._saveSession(data); UI.show('layer-menu');
    },

    async register() {
        const username = document.getElementById('reg-user').value.trim();
        const password = document.getElementById('reg-pass').value;
        const file     = document.getElementById('reg-avatar').files[0];
        const err      = document.getElementById('reg-error');
        err.innerText = '';
        if (!username || !password) { err.innerText = 'Remplis tous les champs.'; return; }
        const btn = document.querySelector('#form-register .btn-play');
        btn.innerText = 'âŸ³ CRÃ‰ATION...'; btn.disabled = true;
        const fd = new FormData();
        fd.append('username', username); fd.append('password', password);
        if (file) fd.append('profilePicture', file);
        const data = await API.post('/auth/register', fd, true);
        btn.innerText = 'CRÃ‰ER LE COMPTE'; btn.disabled = false;
        if (data.error) { err.innerText = data.error; return; }
        this._saveSession(data); UI.show('layer-menu');
    },

    _saveSession(data) {
        this.token = data.token; this.user = data.user;
        localStorage.setItem('nd_token', data.token);
        localStorage.setItem('nd_user', JSON.stringify(data.user));
        const equipped = StatsManager.data.equippedSkin;
        const owned    = data.user.unlockedSkins || [];
        const eq = SKINS_CATALOG.find(s => s.color === equipped && owned.includes(s.id));
        if (eq) Game.player.color = eq.color;
        this._updateUI();
        // Afficher panel admin si admin
        if (this.isAdmin()) DevTools.showAdminPanel();
    },

    logout() {
        this.token = null; this.user = null;
        localStorage.removeItem('nd_token'); localStorage.removeItem('nd_user');
        DevTools.hideAdminPanel();
        this._updateUI(); UI.show('layer-menu');
    },

    async refreshUser() {
        if (!this.token) return;
        const data = await API.get('/auth/me');
        if (data.error) { this.logout(); return; }
        this.user = data; localStorage.setItem('nd_user', JSON.stringify(data));
        this._updateUI();
    },

    _updateUI() {
        const u = this.user;
        const tagName   = document.getElementById('user-tag-name');
        const tagAvatar = document.getElementById('user-tag-avatar');
        const hsEl      = document.getElementById('hs-val');
        if (u) {
            tagName.innerText = u.role === 'admin' ? 'âš™ ' + u.displayName : u.displayName;
            tagName.style.color = u.role === 'admin' ? '#ffcc00' : '';
            if (u.profilePicture) { tagAvatar.style.backgroundImage = `url(${u.profilePicture})`; tagAvatar.style.display = 'block'; }
            else tagAvatar.style.display = 'none';
            if (hsEl) hsEl.innerText = u.highScore.toLocaleString();
        } else {
            tagName.innerText = 'Non connectÃ©'; tagName.style.color = '';
            tagAvatar.style.display = 'none';
            if (hsEl) hsEl.innerText = StatsManager.data.highScore.toLocaleString();
        }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const UI = {
    show(id) {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        const el = document.getElementById(id);
        if (el) { el.style.display = 'flex'; el.classList.add('screen-enter'); setTimeout(() => el.classList.remove('screen-enter'), 400); }
        if (id === 'layer-menu') { BgCanvas.show(); this.renderMenu(); } else BgCanvas.hide();
        if (id === 'layer-shop')    this.renderShop();
        if (id === 'layer-lead')    this.renderLead();
        if (id === 'layer-stats')   this.renderStats();
        if (id === 'layer-profile') this.renderProfile();
        if (id === 'layer-auth')    Auth.switchTab('login');
    },

    renderMenu() { Auth._updateUI(); },

    async renderShop() {
        const list = document.getElementById('skin-list');
        const credEl = document.getElementById('shop-credits');
        list.innerHTML = '<div class="loading-text">âŸ³ Chargement...</div>';
        let unlockedIds = ['neon_blue'];
        if (Auth.token) {
            await Auth.refreshUser();
            credEl.innerText = (Auth.user?.credits ?? 0).toLocaleString();
            unlockedIds = Auth.user?.unlockedSkins ?? ['neon_blue'];
        } else {
            unlockedIds = SKINS_CATALOG.filter(s => (StatsManager.data.unlockedSkins||['#00f3ff']).includes(s.color)).map(s => s.id);
            credEl.innerText = StatsManager.data.credits.toLocaleString();
        }
        list.innerHTML = '';
        SKINS_CATALOG.forEach((s, idx) => {
            const owned    = unlockedIds.includes(s.id);
            const equipped = Game.player.color === s.color;
            const card = document.createElement('div');
            card.className = 'skin-card' + (owned?' skin-unlocked':'') + (equipped?' skin-equipped':'');
            card.style.setProperty('--skin-color', s.color);
            card.style.animationDelay = (idx*0.05)+'s';
            const tc = TIER_COLORS[s.tier] || '#888';
            card.innerHTML = `
                <div class="skin-tier" style="color:${tc}">${s.tier}</div>
                <div class="skin-preview-wrap">
                    <div class="skin-preview" style="background:${s.color};box-shadow:0 0 25px ${s.color}88;"></div>
                    ${equipped?'<div class="skin-equipped-badge">âœ“</div>':''}
                </div>
                <div class="skin-name">${s.name}</div>
                <div class="skin-price" style="color:${owned?'#00ff88':'#ffcc00'}">${owned?'âœ“ DÃ‰BLOQUÃ‰':s.price===0?'GRATUIT':'â—† '+s.price.toLocaleString()}</div>
                <button class="btn-skin-action ${owned?'btn-equip':'btn-buy'}" ${equipped?'disabled':''}>${equipped?'âœ… Ã‰QUIPÃ‰':owned?'Ã‰QUIPER':'ACHETER'}</button>`;
            card.querySelector('.btn-skin-action').addEventListener('click', async () => {
                if (owned) { Game.player.color = s.color; StatsManager.data.equippedSkin = s.color; StatsManager.save(); this.renderShop(); }
                else await this._buySkin(s);
            });
            list.appendChild(card);
        });
    },

    async _buySkin(s) {
        if (!Auth.token) {
            if (StatsManager.data.credits >= s.price) {
                StatsManager.data.credits -= s.price;
                if (!StatsManager.data.unlockedSkins) StatsManager.data.unlockedSkins = ['#00f3ff'];
                StatsManager.data.unlockedSkins.push(s.color);
                Game.player.color = s.color; StatsManager.data.equippedSkin = s.color; StatsManager.save();
                this._toast('Skin dÃ©verrouillÃ© !', 'success'); this.renderShop();
            } else this._toast('Pas assez de crÃ©dits !', 'error');
            return;
        }
        const data = await API.post('/shop/buy', { skinId: s.id });
        if (data.error) { this._toast(data.error, 'error'); return; }
        Auth.user.credits = data.newCredits; Auth.user.unlockedSkins = data.unlockedSkins;
        localStorage.setItem('nd_user', JSON.stringify(Auth.user));
        Game.player.color = s.color; StatsManager.data.equippedSkin = s.color; StatsManager.save();
        this._toast(data.message, 'success'); this.renderShop();
    },

    async renderLead() {
        const content = document.getElementById('leaderboard-content');
        content.innerHTML = '<div class="loading-text">âŸ³ CONNEXION AU RÃ‰SEAU...</div>';
        const data = await API.get('/scores/leaderboard');
        if (data.error || !Array.isArray(data)) { content.innerHTML = '<p class="form-error">Impossible de charger.</p>'; return; }
        if (!data.length) { content.innerHTML = '<div class="empty-lead">// AUCUN SCORE<br>Sois le premier !</div>'; return; }
        content.innerHTML = data.map(e => `
            <div class="lead-row" style="animation-delay:${e.rank*0.05}s">
                <span class="lead-rank ${e.rank<=3?'lead-rank-top':''}">${e.rank<=3?['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][e.rank-1]:e.rank}</span>
                <div class="lead-avatar" style="${e.avatar?'background-image:url('+e.avatar+')':''}">
                    ${!e.avatar?e.displayName[0].toUpperCase():''}
                </div>
                <div class="lead-info">
                    <div class="lead-name">${e.displayName}</div>
                    <div class="lead-level">${e.level}</div>
                </div>
                <div class="lead-score">${e.score.toLocaleString()} <span style="font-size:9px;opacity:0.5">pts</span></div>
            </div>`).join('');
    },

    renderStats() {
        const d = StatsManager.data, u = Auth.user;
        const rows = [
            { label:'Joueur',           value: u?u.displayName:d.username },
            { label:'RÃ´le',             value: u?(u.role==='admin'?'âš™ ADMIN':'JOUEUR'):'â€”' },
            { label:'Meilleur score',   value: (u?u.highScore:d.highScore).toLocaleString()+' pts' },
            { label:'CrÃ©dits',          value: 'â—† '+(u?u.credits:d.credits).toLocaleString() },
            { label:'Parties jouÃ©es',   value: d.gamesPlayed||0 },
            { label:'Morts totales',    value: d.deathCount },
            { label:'Temps de jeu',     value: StatsManager.getFormattedTime() },
            { label:'Meilleur niveau',  value: d.bestLevel||'TUTORIAL' },
            { label:'Skins dÃ©bloquÃ©s',  value: (u?u.unlockedSkins?.length??1:d.unlockedSkins?.length??1)+' / '+SKINS_CATALOG.length }
        ];
        document.getElementById('stats-content').innerHTML = rows.map(r => `
            <div class="stat-row">
                <span class="stat-row-label">${r.label}</span>
                <span class="stat-row-value">${r.value}</span>
            </div>`).join('');
    },

    renderProfile() {
        const conn = document.getElementById('profile-connected');
        const guest = document.getElementById('profile-guest');
        const u = Auth.user;
        if (u) {
            conn.style.display = 'flex'; guest.style.display = 'none';
            const av = document.getElementById('profile-avatar');
            const fb = document.getElementById('profile-avatar-fallback');
            if (u.profilePicture) { av.src = u.profilePicture; av.style.display = 'block'; fb.style.display = 'none'; }
            else { av.style.display = 'none'; fb.style.display = 'flex'; fb.innerText = u.displayName[0].toUpperCase(); }
            document.getElementById('profile-username').innerText = u.displayName;
            document.getElementById('profile-credits').innerText  = u.credits.toLocaleString();
            document.getElementById('profile-hs').innerText       = u.highScore.toLocaleString();
            document.getElementById('profile-level').innerText    = u.highScoreLevel || 'TUTORIAL';
            const badge = document.getElementById('profile-role-badge');
            badge.innerHTML = u.role === 'admin'
                ? '<div class="role-badge role-admin">âš™ ADMINISTRATEUR</div>'
                : '<div class="role-badge role-player">â— JOUEUR</div>';
        } else { conn.style.display = 'none'; guest.style.display = 'flex'; }
    },

    confirmQuit() { this.show('layer-confirm'); },

    _toast(msg, type='success') {
        const t = document.createElement('div');
        t.className = 'toast toast-' + type; t.innerText = msg;
        document.body.appendChild(t);
        setTimeout(() => t.classList.add('toast-show'), 10);
        setTimeout(() => { t.classList.remove('toast-show'); setTimeout(() => t.remove(), 400); }, 3000);
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEV TOOLS + ADMIN PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEV_USERS = ['dev', 'admin', 'root', 'devmode'];
let _allUsers = [];

const DevTools = {
    godMode: false, _clicks: 0, _clickTimer: null, _activeTab: 'tools',

    // â”€â”€ AccÃ¨s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    titleClick() {
        this._clicks++;
        const hint = document.getElementById('dev-hint');
        hint.style.display = 'block';
        document.getElementById('dev-hint-count').innerText = this._clicks;
        clearTimeout(this._clickTimer);
        this._clickTimer = setTimeout(() => { this._clicks = 0; hint.style.display = 'none'; }, 2000);
        if (this._clicks >= 5) { this._clicks = 0; hint.style.display = 'none'; this.toggleSidebar(); }
    },

    showAdminPanel() {
        document.getElementById('admin-toggle-btn').style.display = 'flex';
        document.getElementById('dev-admin-name').innerText = Auth.user?.displayName || '';
        this.refresh();
    },

    hideAdminPanel() {
        document.getElementById('admin-toggle-btn').style.display = 'none';
        this.closeSidebar();
    },

    toggleSidebar() {
        const sidebar = document.getElementById('devtools-sidebar');
        if (sidebar.classList.contains('open')) this.closeSidebar();
        else this.openSidebar();
    },

    openSidebar() {
        this.refresh();
        document.getElementById('devtools-sidebar').classList.add('open');
        document.getElementById('devtools-overlay').classList.add('active');
        // Body padding pour ne pas masquer le contenu
        document.body.classList.add('sidebar-open');
    },

    closeSidebar() {
        document.getElementById('devtools-sidebar').classList.remove('open');
        document.getElementById('devtools-overlay').classList.remove('active');
        document.body.classList.remove('sidebar-open');
    },

    switchTab(tab) {
        this._activeTab = tab;
        ['tools','users','stats'].forEach(t => {
            document.getElementById('dtab-'+t).classList.toggle('active', t===tab);
            document.getElementById('devpanel-'+t).style.display = t===tab ? 'flex' : 'none';
        });
        if (tab === 'users')  this.loadUsers();
        if (tab === 'stats')  this.loadGlobalStats();
    },

    // â”€â”€ Outils dev â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    refresh() {
        const d = StatsManager.data, u = Auth.user;
        const credEl = document.getElementById('dev-credits');
        const hsEl   = document.getElementById('dev-hs');
        const scoreEl = document.getElementById('dev-score');
        const godEl  = document.getElementById('btn-god');
        if (credEl)  credEl.value  = u ? u.credits : d.credits;
        if (hsEl)    hsEl.value    = u ? u.highScore : d.highScore;
        if (scoreEl) scoreEl.value = Game.running ? Game.score : 0;
        if (godEl)   godEl.innerText = this.godMode ? 'MODE GOD : ON âœ“' : 'MODE GOD : OFF';
        const infoEl = document.getElementById('dev-info');
        if (infoEl) infoEl.innerHTML =
            `User    : ${u ? u.displayName : d.username}<br>` +
            `RÃ´le    : ${u ? u.role.toUpperCase() : 'â€”'}<br>` +
            `Morts   : ${d.deathCount}<br>` +
            `Temps   : ${StatsManager.getFormattedTime()}<br>` +
            `Parties : ${d.gamesPlayed||0}<br>` +
            `Auth    : ${Auth.token ? 'âœ… JWT' : 'âŒ local'}`;
    },

    setCredits() {
        const v = parseInt(document.getElementById('dev-credits').value); if (isNaN(v)) return;
        StatsManager.data.credits = v; StatsManager.save();
        if (Auth.user) { Auth.user.credits = v; localStorage.setItem('nd_user', JSON.stringify(Auth.user)); }
        UI._toast('CrÃ©dits mis Ã  jour !', 'success'); this.refresh();
    },
    setHS() {
        const v = parseInt(document.getElementById('dev-hs').value); if (isNaN(v)) return;
        StatsManager.data.highScore = v; StatsManager.save();
        if (Auth.user) { Auth.user.highScore = v; localStorage.setItem('nd_user', JSON.stringify(Auth.user)); }
        UI._toast('High score mis Ã  jour !', 'success'); this.refresh();
    },
    setScore() {
        const v = parseInt(document.getElementById('dev-score').value);
        if (!isNaN(v) && Game.running) { Game.score = v; UI._toast('Score modifiÃ© !', 'success'); }
        else if (!Game.running) UI._toast("Lance une partie d'abord !", 'error');
    },
    unlockAll() {
        StatsManager.data.unlockedSkins = SKINS_CATALOG.map(s => s.color); StatsManager.save();
        if (Auth.user) { Auth.user.unlockedSkins = SKINS_CATALOG.map(s => s.id); localStorage.setItem('nd_user', JSON.stringify(Auth.user)); }
        UI._toast('Tous les skins dÃ©bloquÃ©s !', 'success');
    },
    toggleGod() {
        this.godMode = !this.godMode;
        document.getElementById('btn-god').innerText = this.godMode ? 'MODE GOD : ON âœ“' : 'MODE GOD : OFF';
    },
    reset() {
        if (!confirm('Vraiment tout rÃ©initialiser ?')) return;
        StatsManager.reset(); this.godMode = false; Auth.logout();
        this.refresh(); UI._toast('DonnÃ©es rÃ©initialisÃ©es.', 'success'); this.closeSidebar();
    },

    // â”€â”€ Joueurs (admin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async loadUsers() {
        const list = document.getElementById('admin-user-list');
        list.innerHTML = '<div class="loading-text">âŸ³ Chargement...</div>';
        const data = await API.get('/admin/users');
        if (data.error) { list.innerHTML = `<div class="form-error">${data.error}</div>`; return; }
        _allUsers = data;
        this._renderUserStats(data);
        this._renderUserList(data);
    },

    filterUsers() {
        const q = document.getElementById('admin-search').value.toLowerCase();
        const filtered = _allUsers.filter(u => u.displayName.toLowerCase().includes(q) || u.username.includes(q));
        this._renderUserList(filtered);
    },

    _renderUserStats(users) {
        const bar = document.getElementById('admin-stats-bar');
        const total  = users.length;
        const banned = users.filter(u => u.banned).length;
        const admins = users.filter(u => u.role === 'admin').length;
        bar.innerHTML = `
            <div class="admin-stat-pill">${total} <span>joueurs</span></div>
            <div class="admin-stat-pill pill-red">${banned} <span>bannis</span></div>
            <div class="admin-stat-pill pill-gold">${admins} <span>admins</span></div>`;
    },

    _renderUserList(users) {
        const list = document.getElementById('admin-user-list');
        if (!users.length) { list.innerHTML = '<div class="loading-text">Aucun rÃ©sultat</div>'; return; }
        list.innerHTML = users.map(u => `
            <div class="admin-user-card ${u.banned?'user-banned':''} ${u.role==='admin'?'user-admin':''}">
                <div class="admin-user-header">
                    <div class="admin-user-avatar" style="${u.avatar?'background-image:url('+u.avatar+')':''}">
                        ${!u.avatar?u.displayName[0].toUpperCase():''}
                    </div>
                    <div class="admin-user-info">
                        <div class="admin-user-name">
                            ${u.role==='admin'?'âš™ ':''}${u.displayName}
                            ${u.banned?'<span class="banned-tag">BANNI</span>':''}
                        </div>
                        <div class="admin-user-sub">â—†${u.credits.toLocaleString()} Â· ${u.highScore.toLocaleString()} pts Â· ${u.highScoreLevel}</div>
                        <div class="admin-user-sub" style="color:#333">${new Date(u.createdAt).toLocaleDateString('fr-FR')}</div>
                    </div>
                </div>
                ${u.banned && u.bannedReason ? `<div class="admin-ban-reason">âš  ${u.bannedReason}</div>` : ''}
                <div class="admin-user-actions">
                    ${u.banned
                        ? `<button class="dev-btn" onclick="DevTools.unban('${u.id}')">DÃ‰BANNIR</button>`
                        : u.role!=='admin' ? `<button class="dev-btn dev-btn-red" onclick="DevTools.banUser('${u.id}','${u.displayName}')">BAN</button>` : ''}
                    ${u.role!=='admin' ? `<button class="dev-btn" onclick="DevTools.kickScore('${u.id}','${u.displayName}')">KICK SCORE</button>` : ''}
                    <button class="dev-btn" onclick="DevTools.editCredits('${u.id}','${u.displayName}',${u.credits})">CRÃ‰DITS</button>
                    ${u.role!=='admin'
                        ? `<button class="dev-btn pill-gold-btn" onclick="DevTools.promoteUser('${u.id}','${u.displayName}','admin')">PROMOUVOIR</button>`
                        : Auth.user?.id !== u.id ? `<button class="dev-btn" onclick="DevTools.promoteUser('${u.id}','${u.displayName}','player')">RÃ‰TROGRADER</button>` : ''}
                    ${u.role!=='admin' ? `<button class="dev-btn dev-btn-red" onclick="DevTools.deleteUser('${u.id}','${u.displayName}')">SUPPR.</button>` : ''}
                </div>
            </div>`).join('');
    },

    async banUser(userId, name) {
        const reason = prompt(`Raison du ban de ${name} :`, 'Violation des rÃ¨gles');
        if (reason === null) return;
        const data = await API.post('/admin/ban', { userId, reason });
        if (data.error) { UI._toast(data.error, 'error'); return; }
        UI._toast(data.message, 'success'); this.loadUsers();
    },

    async unban(userId) {
        const data = await API.post('/admin/unban', { userId });
        if (data.error) { UI._toast(data.error, 'error'); return; }
        UI._toast(data.message, 'success'); this.loadUsers();
    },

    async kickScore(userId, name) {
        if (!confirm(`Remettre le score de ${name} Ã  zÃ©ro ?`)) return;
        const data = await API.post('/admin/kick-score', { userId });
        if (data.error) { UI._toast(data.error, 'error'); return; }
        UI._toast(data.message, 'success'); this.loadUsers();
    },

    async editCredits(userId, name, current) {
        const val = prompt(`Nouveaux crÃ©dits pour ${name} (actuel: ${current}) :`, current);
        if (val === null) return;
        const credits = parseInt(val);
        if (isNaN(credits) || credits < 0) { UI._toast('Valeur invalide.', 'error'); return; }
        const data = await API.post('/admin/set-credits', { userId, credits });
        if (data.error) { UI._toast(data.error, 'error'); return; }
        UI._toast(data.message, 'success'); this.loadUsers();
    },

    async promoteUser(userId, name, role) {
        const label = role === 'admin' ? `Promouvoir ${name} en ADMIN ?` : `RÃ©trograder ${name} en JOUEUR ?`;
        if (!confirm(label)) return;
        const data = await API.post('/admin/promote', { userId, role });
        if (data.error) { UI._toast(data.error, 'error'); return; }
        UI._toast(data.message, 'success'); this.loadUsers();
    },

    async deleteUser(userId, name) {
        if (!confirm(`âš  Supprimer DÃ‰FINITIVEMENT le compte de ${name} ? Cette action est irrÃ©versible.`)) return;
        const data = await API.delete('/admin/delete-user', { userId });
        if (data.error) { UI._toast(data.error, 'error'); return; }
        UI._toast(data.message, 'success'); this.loadUsers();
    },

    async loadGlobalStats() {
        const el = document.getElementById('admin-global-stats');
        el.innerHTML = '<div class="loading-text">âŸ³ Chargement...</div>';
        const data = await API.get('/admin/stats');
        if (data.error) { el.innerHTML = `<div class="form-error">${data.error}</div>`; return; }
        el.innerHTML = `
            <div class="global-stat"><div class="global-stat-val">${data.totalUsers}</div><div class="global-stat-lbl">JOUEURS TOTAL</div></div>
            <div class="global-stat"><div class="global-stat-val" style="color:#ff4444">${data.totalBanned}</div><div class="global-stat-lbl">BANNIS</div></div>
            <div class="global-stat"><div class="global-stat-val" style="color:#ffcc00">${data.totalAdmins}</div><div class="global-stat-lbl">ADMINS</div></div>
            ${data.topScore ? `<div class="global-stat" style="grid-column:1/-1">
                <div class="global-stat-val" style="color:var(--gold)">${data.topScore.score.toLocaleString()} pts</div>
                <div class="global-stat-lbl">RECORD Â· ${data.topScore.name}</div>
            </div>` : ''}
        `;
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOTEUR DE JEU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Game = {
    canvas: document.getElementById('gameCanvas'),
    ctx: null, running: false, paused: false, score: 0,
    player: { x:0, y:0, color:'#00f3ff' },
    enemies: [], trails: [],
    currentLevelName:'', burstTimer:0, glitchTimer:0, timeTimer:0,
    bgParticles: [], animFrame: null,

    init() {
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        StatsManager.init();
        if (StatsManager.data.equippedSkin) this.player.color = StatsManager.data.equippedSkin;
        for (let i=0; i<80; i++) this.bgParticles.push({ x:Math.random()*window.innerWidth, y:Math.random()*window.innerHeight, size:Math.random()*1.5+0.3, speed:Math.random()*0.4+0.1 });
        window.addEventListener('resize', () => this.resize());
        window.addEventListener('keydown', (e) => { if ((e.key==='Escape'||e.key==='p'||e.key==='P') && this.running) this.togglePause(); });
        this.canvas.addEventListener('touchmove', (e) => { e.preventDefault(); this.player.x = e.touches[0].clientX-15; }, { passive:false });
        // Restaurer session
        if (Auth.token && Auth.user) {
            if (Auth.isAdmin()) DevTools.showAdminPanel();
        }
        Auth._updateUI();
        BgCanvas.init();
    },

    resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },

    start() {
        if (this.animFrame) cancelAnimationFrame(this.animFrame);
        this.running=true; this.paused=false; this.score=0;
        this.enemies=[]; this.trails=[];
        this.burstTimer=0; this.glitchTimer=0; this.timeTimer=0; this.currentLevelName='';
        this.player.x = this.canvas.width/2-15; this.player.y = this.canvas.height-80;
        document.querySelectorAll('.screen').forEach(s => s.style.display='none');
        document.getElementById('layer-game').style.display = 'block';
        document.getElementById('pause-menu').style.display = 'none';
        BgCanvas.hide();
        StatsManager.data.gamesPlayed = (StatsManager.data.gamesPlayed||0)+1; StatsManager.save();
        window.onmousemove = (ev) => { this.player.x = ev.clientX-15; };
        this.loop();
    },

    async stop() {
        if (!this.running) return;
        this.running=false; this.paused=false; window.onmousemove=null;
        if (this.animFrame) cancelAnimationFrame(this.animFrame);
        const fs = this.score, lvl = LevelSystem.getCurrentLevel(fs), lvlName = lvl.name;
        StatsManager.data.deathCount++;
        const isNewLocal = fs > StatsManager.data.highScore;
        if (isNewLocal) { StatsManager.data.highScore=fs; StatsManager.data.bestLevel=lvlName; }
        StatsManager.save();
        let creditsEarned = Math.floor(fs/10), isNewHs = isNewLocal;
        if (Auth.token) {
            const res = await API.post('/scores/submit', { score:fs, level:lvlName });
            if (!res.error) {
                creditsEarned=res.creditsEarned; isNewHs=res.isNewHighScore;
                Auth.user.credits=res.newCredits; Auth.user.highScore=res.highScore;
                if (isNewHs) Auth.user.highScoreLevel=lvlName;
                localStorage.setItem('nd_user', JSON.stringify(Auth.user));
            }
        } else { StatsManager.data.credits+=creditsEarned; StatsManager.save(); }

        document.getElementById('layer-game').style.display='none';
        document.getElementById('layer-death').style.display='flex';
        BgCanvas.show();
        document.getElementById('death-stats').innerHTML = `
            <div class="death-score">${fs.toLocaleString()}</div>
            <div class="death-score-label">POINTS</div>
            <div class="death-info-grid">
                <div class="death-info-item"><div class="death-info-val" style="color:${lvl.color}">${lvlName}</div><div class="death-info-lbl">NIVEAU</div></div>
                <div class="death-info-item"><div class="death-info-val" style="color:#ffcc00">+${creditsEarned.toLocaleString()}</div><div class="death-info-lbl">CRÃ‰DITS</div></div>
                <div class="death-info-item"><div class="death-info-val">${LevelSystem.getTierName(fs)}</div><div class="death-info-lbl">TIER</div></div>
            </div>
            ${isNewHs?'<div class="new-record">ğŸ† NOUVEAU RECORD !</div>':''}
            ${!Auth.token?'<div class="death-login-hint">Connecte-toi pour sauvegarder !</div>':''}`;
        const gl = document.getElementById('death-glitch-text');
        let c=0; const gi = setInterval(() => {
            gl.style.transform=`translate(${(Math.random()-.5)*6}px,${(Math.random()-.5)*6}px)`;
            gl.style.opacity=Math.random()>.3?'0.5':'0';
            if(++c>12){clearInterval(gi);gl.style.transform='';gl.style.opacity='0.15';}
        }, 80);
    },

    quit() {
        if (this.running) { StatsManager.data.credits+=Math.floor(this.score/10); if(this.score>StatsManager.data.highScore)StatsManager.data.highScore=this.score; StatsManager.save(); }
        this.running=false; this.paused=false;
        if(this.animFrame)cancelAnimationFrame(this.animFrame);
        window.onmousemove=null;
        document.getElementById('layer-game').style.display='none';
        document.getElementById('pause-menu').style.display='none';
        UI.show('layer-menu');
    },

    togglePause() {
        if(!this.running&&!this.paused)return;
        this.paused=!this.paused;
        document.getElementById('pause-menu').style.display=this.paused?'flex':'none';
        document.getElementById('btn-pause').innerText=this.paused?'â–¶':'â¸';
        document.getElementById('pause-score-info').innerText=`Score : ${this.score.toLocaleString()} pts`;
        if(!this.paused)this.loop();
    },

    loop() { if(!this.running||this.paused)return; this.update(); this.draw(); this.animFrame=requestAnimationFrame(()=>this.loop()); },

    update() {
        const lvl = LevelSystem.getCurrentLevel(this.score);
        if (lvl.name!==this.currentLevelName) {
            this.currentLevelName=lvl.name;
            document.getElementById('ui-level-name').innerText=lvl.name;
            document.getElementById('ui-level-name').style.color=lvl.color||'#00f3ff';
            document.getElementById('ui-level-desc').innerText=lvl.description||'';
            document.getElementById('ui-tier').innerText=LevelSystem.getTierName(this.score);
            this._announceLevel(lvl.name,lvl.color,lvl.description);
            if(this.score>0)StatsManager.data.bestLevel=lvl.name;
        }
        const next=LevelSystem.getNextLevel(this.score);
        if(next){
            const pct=Math.min(100,((this.score-lvl.scoreReq)/(next.scoreReq-lvl.scoreReq))*100);
            document.getElementById('next-level-fill').style.width=pct+'%';
            document.getElementById('next-level-fill').style.background=lvl.color||'#00f3ff';
            document.getElementById('next-level-label').innerText=`â†’ ${next.name} dans ${(next.scoreReq-this.score).toLocaleString()} pts`;
        } else { document.getElementById('next-level-fill').style.width='100%'; document.getElementById('next-level-label').innerText='âˆ MAX NIVEAU'; }
        if(Math.random()<lvl.rate)this._spawnEnemy(lvl);
        if(lvl.burst){this.burstTimer++;if(this.burstTimer>=90){this.burstTimer=0;for(let i=0;i<5;i++)setTimeout(()=>{if(this.running&&!this.paused)this._spawnEnemy(lvl);},i*80);}}
        if(lvl.glitch){this.glitchTimer++;if(this.glitchTimer>=160){this.glitchTimer=0;this.canvas.style.filter=`hue-rotate(${Math.random()*360}deg) brightness(2)`;setTimeout(()=>{this.canvas.style.filter='';},120);for(let a=0;a<6;a++){const angle=(a/6)*Math.PI*2;const e=this._createEnemy(lvl);e.x=this.canvas.width/2+Math.cos(angle)*250;e.y=-30;e.vx=Math.cos(angle)*2;this.enemies.push(e);}}}
        this.timeTimer++;if(this.timeTimer>=60){this.timeTimer=0;StatsManager.incrementTime();}
        const W=this.canvas.width,H=this.canvas.height;
        this.bgParticles.forEach(p=>{p.y+=p.speed;if(p.y>H){p.y=0;p.x=Math.random()*W;}});
        this.trails.push({x:this.player.x+15,y:this.player.y+15,alpha:0.4,color:this.player.color});
        if(this.trails.length>8)this.trails.shift();
        this.trails.forEach(t=>{t.alpha-=0.04;});
        for(let i=this.enemies.length-1;i>=0;i--){
            const e=this.enemies[i];
            if(e.tracker){const dx=(this.player.x+15)-(e.x+12);const dy=(this.player.y+15)-(e.y+12);const d=Math.hypot(dx,dy)||1;e.x+=(dx/d)*e.trackSpeed;e.y+=(dy/d)*e.trackSpeed;}
            else{if(e.zigzag)e.x+=Math.sin(e.y*0.05+e.phase)*3;e.x+=e.vx||0;e.y+=e.speed;}
            if(!DevTools.godMode){if(Math.hypot(this.player.x+15-(e.x+12),this.player.y+15-(e.y+12))<24){this.stop();return;}}
            if(e.y>H+60||e.x<-100||e.x>W+100){this.enemies.splice(i,1);this.score+=10;}
        }
        document.getElementById('ui-score').innerText=this.score.toLocaleString();
    },

    _createEnemy(lvl){return{x:Math.random()*this.canvas.width,y:-50,speed:lvl.speed+(Math.random()*2-1),tracker:lvl.tracker&&Math.random()<0.4,trackSpeed:lvl.speed*0.35,zigzag:lvl.zigzag&&Math.random()<0.5,phase:Math.random()*Math.PI*2,color:lvl.color||'#ff3838',vx:0,size:18+Math.random()*10};},
    _spawnEnemy(lvl){this.enemies.push(this._createEnemy(lvl));},

    _announceLevel(name,color,desc){
        const el=document.getElementById('level-announce');
        el.style.color=color||'#00f3ff';el.style.opacity='1';el.style.transform='scale(1.15)';
        el.innerHTML=name+(desc?`<div class="announce-sub">${desc}</div>`:'');
        clearTimeout(this._announceTO);
        this._announceTO=setTimeout(()=>{el.style.opacity='0';el.style.transform='scale(1)';},2200);
    },

    draw(){
        const lvl=LevelSystem.getCurrentLevel(this.score),C=this.ctx;
        C.fillStyle=lvl.bgColor||'#050505';C.fillRect(0,0,this.canvas.width,this.canvas.height);
        C.shadowBlur=0;
        this.bgParticles.forEach(p=>{C.fillStyle=(lvl.color||'#00f3ff')+'18';C.beginPath();C.arc(p.x,p.y,p.size,0,Math.PI*2);C.fill();});
        this.trails.forEach(t=>{if(t.alpha<=0)return;C.globalAlpha=t.alpha;C.fillStyle=t.color;C.shadowBlur=8;C.shadowColor=t.color;C.fillRect(t.x-4,t.y-4,8,8);});
        C.globalAlpha=1;
        C.shadowBlur=25;C.shadowColor=this.player.color;C.fillStyle=this.player.color;
        C.fillRect(this.player.x,this.player.y,30,30);
        C.fillStyle='#ffffff66';C.fillRect(this.player.x+6,this.player.y+6,10,10);
        if(DevTools.godMode){C.strokeStyle='#ffcc00';C.lineWidth=2;C.shadowColor='#ffcc00';C.shadowBlur=15;C.strokeRect(this.player.x-5,this.player.y-5,40,40);}
        this.enemies.forEach(e=>{const c=e.color||'#ff3838';C.shadowBlur=16;C.shadowColor=c;C.fillStyle=c;C.fillRect(e.x,e.y,e.size,e.size);if(e.tracker){C.strokeStyle='#ffffff66';C.lineWidth=1;C.strokeRect(e.x-3,e.y-3,e.size+6,e.size+6);}});
        C.shadowBlur=0;
    }
};

window.onload = () => Game.init();
</script>
</body>
</html>
