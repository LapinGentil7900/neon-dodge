<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON DODGE - PRO NETWORK</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
<canvas id="bgCanvas"></canvas>

<!-- â•â• MENU â•â• -->
<div id="layer-menu" class="screen">
    <div id="user-tag" onclick="UI.show('layer-profile')">
        <div id="user-tag-avatar"></div>
        <span id="user-tag-name">Non connectÃ©</span>
    </div>
    <div class="menu-logo">
        <h1 class="neon-title" id="main-title" onclick="DevTools.titleClick()">NEON</h1>
        <h1 class="neon-title neon-title-2">DODGE</h1>
        <div class="title-sub">PRO NETWORK v2.0</div>
    </div>
    <p id="dev-hint">CLIQUEZ ENCORE... <span id="dev-hint-count">0</span>/5</p>
    <div id="menu-hs-block">
        <div class="hs-label">MEILLEUR SCORE</div>
        <div class="hs-value" id="hs-val">0</div>
    </div>
    <div class="menu-grid">
        <button class="btn btn-play" onclick="Game.start()"><span class="btn-icon">â–¶</span> JOUER</button>
        <button class="btn btn-blue" onclick="UI.show('layer-shop')"><span class="btn-icon">â—ˆ</span> BOUTIQUE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-lead')"><span class="btn-icon">â—‰</span> CLASSEMENT</button>
        <button class="btn btn-blue" onclick="UI.show('layer-profile')"><span class="btn-icon">â—</span> COMPTE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-stats')"><span class="btn-icon">â–£</span> STATS</button>
        <button class="btn btn-red"  onclick="UI.confirmQuit()"><span class="btn-icon">âœ•</span> QUITTER</button>
    </div>
</div>

<!-- â•â• BOUTIQUE â•â• -->
<div id="layer-shop" class="screen" style="display:none;">
    <div class="screen-header">
        <h2 class="screen-title">â—ˆ BOUTIQUE</h2>
        <div class="credits-badge"><span>â—†</span><span id="shop-credits">0</span> crÃ©dits</div>
    </div>
    <div id="skin-list" class="skin-grid"></div>
    <button class="btn btn-red back-btn" onclick="UI.show('layer-menu')">â† RETOUR</button>
</div>

<!-- â•â• CLASSEMENT â•â• -->
<div id="layer-lead" class="screen" style="display:none;">
    <h2 class="screen-title">â—‰ TOP JOUEURS</h2>
    <div id="leaderboard-content" class="leaderboard-list"></div>
    <button class="btn btn-red back-btn" onclick="UI.show('layer-menu')">â† RETOUR</button>
</div>

<!-- â•â• PROFIL â•â• -->
<div id="layer-profile" class="screen" style="display:none;">
    <div id="profile-connected" style="display:none;flex-direction:column;align-items:center;gap:20px;">
        <div id="profile-avatar-wrap">
            <img id="profile-avatar" src="" alt="" style="display:none;">
            <div id="profile-avatar-fallback">?</div>
            <div class="avatar-ring"></div>
        </div>
        <h2 id="profile-username" class="profile-name">-</h2>
        <div id="profile-role-badge"></div>
        <div class="profile-stats">
            <div class="stat-box"><div class="stat-val" id="profile-credits">0</div><div class="stat-lbl">CRÃ‰DITS</div></div>
            <div class="stat-box stat-box-hs"><div class="stat-val" id="profile-hs">0</div><div class="stat-lbl">HIGH SCORE</div></div>
            <div class="stat-box"><div class="stat-val stat-val-sm" id="profile-level">-</div><div class="stat-lbl">NIVEAU MAX</div></div>
        </div>
        <button class="btn btn-red" onclick="Auth.logout()">DÃ‰CONNEXION</button>
        <button class="btn back-btn" onclick="UI.show('layer-menu')">â† RETOUR</button>
    </div>
    <div id="profile-guest" style="display:none;flex-direction:column;align-items:center;gap:16px;">
        <div class="guest-icon">â—</div><h2>TERMINAL OS</h2>
        <p class="guest-desc">Connecte-toi pour sauvegarder tes scores.</p>
        <button class="btn btn-play" onclick="UI.show('layer-auth')">CONNEXION</button>
        <button class="btn back-btn" onclick="UI.show('layer-menu')">â† RETOUR</button>
    </div>
</div>

<!-- â•â• AUTH â•â• -->
<div id="layer-auth" class="screen" style="display:none;">
    <h2 class="screen-title">ACCÃˆS RÃ‰SEAU</h2>
    <div class="auth-tabs">
        <button id="tab-login" class="tab-btn tab-active" onclick="Auth.switchTab('login')">CONNEXION</button>
        <button id="tab-register" class="tab-btn" onclick="Auth.switchTab('register')">INSCRIPTION</button>
    </div>
    <div id="form-login" class="auth-form">
        <div class="input-wrap"><span class="input-icon">â—</span><input type="text" id="login-user" placeholder="Pseudo"></div>
        <div class="input-wrap"><span class="input-icon">â—†</span><input type="password" id="login-pass" placeholder="Mot de passe"></div>
        <div id="login-error" class="form-error"></div>
        <button class="btn btn-play" onclick="Auth.login()">SE CONNECTER</button>
    </div>
    <div id="form-register" class="auth-form" style="display:none;">
        <div class="input-wrap"><span class="input-icon">â—</span><input type="text" id="reg-user" placeholder="Pseudo (3-20 car.)"></div>
        <div class="input-wrap"><span class="input-icon">â—†</span><input type="password" id="reg-pass" placeholder="Mot de passe (6+)"></div>
        <label class="file-label" for="reg-avatar"><span id="file-label-text">ğŸ“· Photo de profil (optionnel)</span><input type="file" id="reg-avatar" accept="image/jpeg,image/png,image/webp" onchange="Auth.previewAvatar(this)"></label>
        <img id="avatar-preview" class="avatar-preview-img" style="display:none;" alt="">
        <div id="reg-error" class="form-error"></div>
        <button class="btn btn-play" onclick="Auth.register()">CRÃ‰ER LE COMPTE</button>
    </div>
    <button class="btn btn-red back-btn" onclick="UI.show('layer-menu')">â† RETOUR</button>
</div>

<!-- â•â• STATS â•â• -->
<div id="layer-stats" class="screen" style="display:none;">
    <h2 class="screen-title">â–£ STATISTIQUES</h2>
    <div id="stats-content" class="stats-grid"></div>
    <button class="btn btn-red back-btn" onclick="UI.show('layer-menu')">â† RETOUR</button>
</div>

<!-- â•â• JEU â•â• -->
<div id="layer-game" style="display:none;position:relative;width:100%;height:100%;">
    <canvas id="gameCanvas"></canvas>
    <div id="hud">
        <div id="score-container">SCORE <span id="ui-score">0</span></div>
        <div id="level-hud"><span id="ui-level-name">TUTORIAL</span><span id="ui-level-desc"></span></div>
        <div id="ui-tier"></div>
        <div id="next-level-bar"><div id="next-level-fill"></div></div>
        <div id="next-level-label"></div>
    </div>
    <div id="bonus-hud">
        <div id="bonus-shield" class="bonus-indicator" style="display:none;">ğŸ›¡ BOUCLIER</div>
        <div id="bonus-slow"   class="bonus-indicator" style="display:none;">âš¡ SLOW</div>
        <div id="bonus-magnet" class="bonus-indicator" style="display:none;">ğŸ§² AIMANT</div>
    </div>
    <button id="btn-pause" onclick="Game.togglePause()">â¸</button>
    <div id="level-announce"></div>
    <div id="pause-menu" style="display:none;">
        <div class="pause-inner">
            <h2 class="pause-title">â¸ PAUSE</h2>
            <p id="pause-score-info"></p>
            <button class="btn btn-play" onclick="Game.togglePause()">â–¶ REPRENDRE</button>
            <button class="btn btn-red" onclick="Game.quit()">âœ• QUITTER</button>
        </div>
    </div>
</div>

<!-- â•â• GAME OVER â•â• -->
<div id="layer-death" class="screen" style="display:none;">
    <div class="death-container">
        <div class="death-glitch">GAME OVER</div>
        <h2 class="death-title">GAME OVER</h2>
        <div id="death-stats" class="death-stats-wrap"></div>
        <div class="death-actions">
            <button class="btn btn-play" onclick="Game.start()">â†º REJOUER</button>
            <button class="btn btn-blue" onclick="UI.show('layer-menu')">âŒ‚ MENU</button>
        </div>
    </div>
</div>

<!-- â•â• CONFIRM â•â• -->
<div id="layer-confirm" class="screen" style="display:none;">
    <h2>QUITTER ?</h2>
    <button class="btn btn-red" onclick="window.close()">OUI</button>
    <button class="btn btn-blue" onclick="UI.show('layer-menu')">ANNULER</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ADMIN PANEL â€” bouton fixe + sidebar complÃ¨te
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="devtools-overlay" onclick="Admin.close()"></div>
<button id="admin-toggle-btn" onclick="Admin.toggle()" style="display:none;">âš™ ADMIN</button>

<div id="admin-panel">
    <!-- HEADER -->
    <div class="ap-header">
        <div>
            <div class="ap-title">âš™ ADMIN PANEL</div>
            <div id="ap-username" class="ap-sub"></div>
        </div>
        <button class="ap-close" onclick="Admin.close()">âœ•</button>
    </div>

    <!-- TABS -->
    <div class="ap-tabs">
        <button class="ap-tab active" onclick="Admin.tab('joueurs')"  id="aptab-joueurs">ğŸ‘¥ JOUEURS</button>
        <button class="ap-tab"        onclick="Admin.tab('classement')" id="aptab-classement">ğŸ† CLASSEMENT</button>
        <button class="ap-tab"        onclick="Admin.tab('jeu')"      id="aptab-jeu">ğŸ® JEU</button>
        <button class="ap-tab"        onclick="Admin.tab('stats')"    id="aptab-stats">ğŸ“Š STATS</button>
    </div>

    <!-- â•â•â• TAB JOUEURS â•â•â• -->
    <div id="ap-joueurs" class="ap-body">
        <div class="ap-search-row">
            <input type="text" id="ap-search" placeholder="ğŸ” Rechercher un joueur..." oninput="Admin.filter()">
            <button class="ap-btn ap-btn-gold" onclick="Admin.loadUsers()">â†º</button>
        </div>
        <div id="ap-user-pills" class="ap-pills"></div>
        <div id="ap-user-list" class="ap-list">
            <div class="ap-empty">Clique â†º pour charger les joueurs</div>
        </div>
    </div>

    <!-- â•â•â• TAB CLASSEMENT â•â•â• -->
    <div id="ap-classement" class="ap-body" style="display:none;">
        <div class="ap-section-title">CLASSEMENT ACTUEL</div>
        <div class="ap-row">
            <button class="ap-btn ap-btn-gold" onclick="Admin.loadLeaderboard()">â†º ACTUALISER</button>
            <button class="ap-btn ap-btn-red" onclick="Admin.resetLeaderboard()">âš  TOUT RESET</button>
        </div>
        <div id="ap-lead-list" class="ap-list">
            <div class="ap-empty">Clique â†º pour charger</div>
        </div>
    </div>

    <!-- â•â•â• TAB JEU â•â•â• -->
    <div id="ap-jeu" class="ap-body" style="display:none;">
        <!-- Vitesse globale -->
        <div class="ap-section-title">âš¡ VITESSE GLOBALE</div>
        <div class="ap-row">
            <span class="ap-val-label">Ã—<span id="ap-speed-val">1.0</span></span>
            <input type="range" id="ap-speed" min="0.1" max="5" step="0.1" value="1" oninput="Admin.setSpeed()" class="ap-slider">
        </div>
        <div class="ap-row" style="gap:6px;">
            <button class="ap-btn" onclick="Admin.speedPreset(0.3)">0.3Ã— ğŸ¢</button>
            <button class="ap-btn" onclick="Admin.speedPreset(1)">1Ã— âš–</button>
            <button class="ap-btn" onclick="Admin.speedPreset(2)">2Ã— âš¡</button>
            <button class="ap-btn ap-btn-red" onclick="Admin.speedPreset(5)">5Ã— ğŸ’€</button>
        </div>

        <!-- Taux d'apparition -->
        <div class="ap-section-title">ğŸ‘¾ TAUX ENNEMIS</div>
        <div class="ap-row">
            <span class="ap-val-label">Ã—<span id="ap-rate-val">1.0</span></span>
            <input type="range" id="ap-rate" min="0" max="5" step="0.1" value="1" oninput="Admin.setRate()" class="ap-slider">
        </div>
        <div class="ap-row" style="gap:6px;">
            <button class="ap-btn" onclick="Admin.ratePreset(0)">0 (STOP)</button>
            <button class="ap-btn" onclick="Admin.ratePreset(1)">Normal</button>
            <button class="ap-btn ap-btn-red" onclick="Admin.ratePreset(5)">FLOOD</button>
        </div>

        <!-- Spawn manuel -->
        <div class="ap-section-title">ğŸ’¥ SPAWN MANUEL</div>
        <div class="ap-row" style="gap:6px;flex-wrap:wrap;">
            <button class="ap-btn" onclick="Admin.spawnEnemy('normal',1)">+1 Normal</button>
            <button class="ap-btn" onclick="Admin.spawnEnemy('normal',5)">+5 Normal</button>
            <button class="ap-btn ap-btn-red" onclick="Admin.spawnEnemy('tracker',3)">+3 Tracker</button>
            <button class="ap-btn ap-btn-red" onclick="Admin.spawnEnemy('tracker',10)">+10 Tracker</button>
            <button class="ap-btn" onclick="Admin.spawnEnemy('zigzag',5)">+5 Zigzag</button>
            <button class="ap-btn ap-btn-gold" onclick="Admin.spawnCircle()">Cercle Ã—8</button>
        </div>

        <!-- Bonus forcÃ©s -->
        <div class="ap-section-title">ğŸ ACTIVER BONUS</div>
        <div class="ap-row" style="gap:6px;flex-wrap:wrap;">
            <button class="ap-btn" onclick="Admin.forceBonus('shield')">ğŸ›¡ Bouclier</button>
            <button class="ap-btn" onclick="Admin.forceBonus('slow')">âš¡ Slow</button>
            <button class="ap-btn" onclick="Admin.forceBonus('magnet')">ğŸ§² Aimant</button>
            <button class="ap-btn ap-btn-gold" onclick="Admin.forceBonus('all')">Tous</button>
        </div>

        <!-- Score en jeu -->
        <div class="ap-section-title">ğŸ¯ SCORE EN JEU</div>
        <div class="ap-row">
            <input type="number" id="ap-score-set" value="0" class="ap-input">
            <button class="ap-btn ap-btn-gold" onclick="Admin.setGameScore()">SET</button>
        </div>

        <!-- Game over forcÃ© -->
        <div class="ap-section-title">ğŸ’€ CONTRÃ”LES</div>
        <div class="ap-row" style="gap:6px;">
            <button class="ap-btn ap-btn-red" onclick="Admin.forceGameOver()">GAME OVER</button>
            <button class="ap-btn" id="ap-god-btn" onclick="Admin.toggleGod()">GOD : OFF</button>
        </div>

        <!-- CrÃ©dits locaux -->
        <div class="ap-section-title">â—† CRÃ‰DITS LOCAUX</div>
        <div class="ap-row">
            <input type="number" id="ap-credits-local" value="0" class="ap-input">
            <button class="ap-btn ap-btn-gold" onclick="Admin.setLocalCredits()">SET</button>
        </div>
    </div>

    <!-- â•â•â• TAB STATS â•â•â• -->
    <div id="ap-stats" class="ap-body" style="display:none;">
        <div id="ap-global-stats" class="ap-global-stats">
            <div class="ap-empty">Chargement...</div>
        </div>
        <button class="ap-btn ap-btn-gold" onclick="Admin.loadGlobalStats()" style="width:100%;margin-top:8px;">â†º ACTUALISER</button>
    </div>
</div>

<script src="levels.js"></script>
<script src="stats_manager.js"></script>
<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BG CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BgCanvas = {
    canvas:document.getElementById('bgCanvas'), ctx:null, particles:[], animFrame:null,
    init() {
        this.ctx=this.canvas.getContext('2d'); this.resize();
        window.addEventListener('resize',()=>this.resize());
        for(let i=0;i<120;i++) this.particles.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,size:Math.random()*1.5+0.2,speed:Math.random()*0.5+0.1,opacity:Math.random()*0.5+0.1,color:Math.random()>.7?'#ff3838':'#00f3ff'});
        this.loop();
    },
    resize(){this.canvas.width=window.innerWidth;this.canvas.height=window.innerHeight;},
    loop(){
        const C=this.ctx; C.clearRect(0,0,this.canvas.width,this.canvas.height);
        this.particles.forEach(p=>{p.y+=p.speed;if(p.y>this.canvas.height){p.y=0;p.x=Math.random()*this.canvas.width;}C.globalAlpha=p.opacity;C.fillStyle=p.color;C.shadowBlur=6;C.shadowColor=p.color;C.beginPath();C.arc(p.x,p.y,p.size,0,Math.PI*2);C.fill();});
        C.globalAlpha=1;C.shadowBlur=0;
        this.animFrame=requestAnimationFrame(()=>this.loop());
    },
    show(){this.canvas.style.display='block';},
    hide(){this.canvas.style.display='none';}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = {
    BASE:'/api',
    _h(mp=false){const h={};if(Auth.token)h['Authorization']='Bearer '+Auth.token;if(!mp)h['Content-Type']='application/json';return h;},
    async post(p,b,mp=false){try{const r=await fetch(this.BASE+p,{method:'POST',headers:this._h(mp),body:mp?b:JSON.stringify(b)});return r.json();}catch{return{error:'Erreur rÃ©seau'};}},
    async get(p){try{const r=await fetch(this.BASE+p,{headers:this._h()});return r.json();}catch{return{error:'Erreur rÃ©seau'};}},
    async del(p,b){try{const r=await fetch(this.BASE+p,{method:'DELETE',headers:this._h(),body:JSON.stringify(b)});return r.json();}catch{return{error:'Erreur rÃ©seau'};}}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SKINS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SKINS = [
    {id:'neon_blue',name:'Neon Blue',color:'#00f3ff',price:0,    tier:'FREE'},
    {id:'emerald',  name:'Emerald',  color:'#00ff88',price:500,  tier:'COMMUN'},
    {id:'ruby',     name:'Ruby',     color:'#ff3838',price:1500, tier:'RARE'},
    {id:'gold',     name:'Gold',     color:'#ffcc00',price:3000, tier:'Ã‰PIQUE'},
    {id:'violet',   name:'Violet',   color:'#cc00ff',price:5000, tier:'Ã‰PIQUE'},
    {id:'white',    name:'White',    color:'#ffffff',price:8000, tier:'LÃ‰GENDAIRE'},
    {id:'inferno',  name:'Inferno',  color:'#ff4400',price:12000,tier:'LÃ‰GENDAIRE'},
    {id:'ghost',    name:'Ghost',    color:'#aaaaaa',price:20000,tier:'MYTHIQUE'}
];
const TIER_COLORS={'FREE':'#888','COMMUN':'#00ff88','RARE':'#0088ff','Ã‰PIQUE':'#cc00ff','LÃ‰GENDAIRE':'#ffcc00','MYTHIQUE':'#ff4400'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Auth = {
    token:localStorage.getItem('nd_token')||null,
    user:JSON.parse(localStorage.getItem('nd_user')||'null'),
    isAdmin(){return this.user?.role==='admin';},
    switchTab(t){
        const il=t==='login';
        document.getElementById('form-login').style.display=il?'flex':'none';
        document.getElementById('form-register').style.display=il?'none':'flex';
        document.getElementById('tab-login').classList.toggle('tab-active',il);
        document.getElementById('tab-register').classList.toggle('tab-active',!il);
        document.getElementById('login-error').innerText='';
        document.getElementById('reg-error').innerText='';
    },
    previewAvatar(input){const f=input.files[0];if(!f)return;document.getElementById('file-label-text').innerText='âœ… '+f.name;const p=document.getElementById('avatar-preview');p.src=URL.createObjectURL(f);p.style.display='block';},
    async login(){
        const u=document.getElementById('login-user').value.trim(),p=document.getElementById('login-pass').value;
        const err=document.getElementById('login-error');err.innerText='';
        if(!u||!p){err.innerText='Remplis tous les champs.';return;}
        const btn=document.querySelector('#form-login .btn-play');btn.innerText='âŸ³...';btn.disabled=true;
        const d=await API.post('/auth/login',{username:u,password:p});
        btn.innerText='SE CONNECTER';btn.disabled=false;
        if(d.error){err.innerText=d.error;return;}
        this._save(d);UI.show('layer-menu');
    },
    async register(){
        const u=document.getElementById('reg-user').value.trim(),p=document.getElementById('reg-pass').value;
        const f=document.getElementById('reg-avatar').files[0];
        const err=document.getElementById('reg-error');err.innerText='';
        if(!u||!p){err.innerText='Remplis tous les champs.';return;}
        const btn=document.querySelector('#form-register .btn-play');btn.innerText='âŸ³...';btn.disabled=true;
        const fd=new FormData();fd.append('username',u);fd.append('password',p);if(f)fd.append('profilePicture',f);
        const d=await API.post('/auth/register',fd,true);
        btn.innerText='CRÃ‰ER LE COMPTE';btn.disabled=false;
        if(d.error){err.innerText=d.error;return;}
        this._save(d);UI.show('layer-menu');
    },
    _save(d){
        this.token=d.token;this.user=d.user;
        localStorage.setItem('nd_token',d.token);localStorage.setItem('nd_user',JSON.stringify(d.user));
        const eq=SKINS.find(s=>s.color===StatsManager.data.equippedSkin&&(d.user.unlockedSkins||[]).includes(s.id));
        if(eq)Game.player.color=eq.color;
        this._ui();if(this.isAdmin())Admin.show();
    },
    logout(){
        this.token=null;this.user=null;
        localStorage.removeItem('nd_token');localStorage.removeItem('nd_user');
        Admin.hide();this._ui();UI.show('layer-menu');
    },
    async refresh(){
        if(!this.token)return;
        const d=await API.get('/auth/me');
        if(d.error){this.logout();return;}
        this.user=d;localStorage.setItem('nd_user',JSON.stringify(d));this._ui();
    },
    _ui(){
        const u=this.user;
        const tn=document.getElementById('user-tag-name'),ta=document.getElementById('user-tag-avatar'),hs=document.getElementById('hs-val');
        if(u){tn.innerText=u.role==='admin'?'âš™ '+u.displayName:u.displayName;tn.style.color=u.role==='admin'?'#ffcc00':'';if(u.profilePicture){ta.style.backgroundImage=`url(${u.profilePicture})`;ta.style.display='block';}else ta.style.display='none';if(hs)hs.innerText=u.highScore.toLocaleString();}
        else{tn.innerText='Non connectÃ©';tn.style.color='';ta.style.display='none';if(hs)hs.innerText=StatsManager.data.highScore.toLocaleString();}
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const UI = {
    show(id){
        document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
        const el=document.getElementById(id);
        if(el){el.style.display='flex';el.classList.add('screen-enter');setTimeout(()=>el.classList.remove('screen-enter'),400);}
        if(id==='layer-menu'){BgCanvas.show();Auth._ui();}else BgCanvas.hide();
        if(id==='layer-shop')this.renderShop();
        if(id==='layer-lead')this.renderLead();
        if(id==='layer-stats')this.renderStats();
        if(id==='layer-profile')this.renderProfile();
        if(id==='layer-auth')Auth.switchTab('login');
    },
    async renderShop(){
        const list=document.getElementById('skin-list'),credEl=document.getElementById('shop-credits');
        list.innerHTML='<div class="loading-text">âŸ³ Chargement...</div>';
        let uids=['neon_blue'];
        if(Auth.token){await Auth.refresh();credEl.innerText=(Auth.user?.credits??0).toLocaleString();uids=Auth.user?.unlockedSkins??['neon_blue'];}
        else{uids=SKINS.filter(s=>(StatsManager.data.unlockedSkins||['#00f3ff']).includes(s.color)).map(s=>s.id);credEl.innerText=StatsManager.data.credits.toLocaleString();}
        list.innerHTML='';
        SKINS.forEach((s,i)=>{
            const owned=uids.includes(s.id),eq=Game.player.color===s.color;
            const card=document.createElement('div');
            card.className='skin-card'+(owned?' skin-unlocked':'')+(eq?' skin-equipped':'');
            card.style.setProperty('--skin-color',s.color);card.style.animationDelay=(i*.05)+'s';
            const tc=TIER_COLORS[s.tier]||'#888';
            card.innerHTML=`<div class="skin-tier" style="color:${tc}">${s.tier}</div><div class="skin-preview-wrap"><div class="skin-preview" style="background:${s.color};box-shadow:0 0 25px ${s.color}88;"></div>${eq?'<div class="skin-equipped-badge">âœ“</div>':''}</div><div class="skin-name">${s.name}</div><div class="skin-price" style="color:${owned?'#00ff88':'#ffcc00'}">${owned?'âœ“ DÃ‰BLOQUÃ‰':s.price===0?'GRATUIT':'â—† '+s.price.toLocaleString()}</div><button class="btn-skin-action ${owned?'btn-equip':'btn-buy'}" ${eq?'disabled':''}>${eq?'âœ… Ã‰QUIPÃ‰':owned?'Ã‰QUIPER':'ACHETER'}</button>`;
            card.querySelector('.btn-skin-action').addEventListener('click',async()=>{
                if(owned){Game.player.color=s.color;StatsManager.data.equippedSkin=s.color;StatsManager.save();this.renderShop();}
                else await this._buy(s);
            });
            list.appendChild(card);
        });
    },
    async _buy(s){
        if(!Auth.token){
            if(StatsManager.data.credits>=s.price){StatsManager.data.credits-=s.price;if(!StatsManager.data.unlockedSkins)StatsManager.data.unlockedSkins=['#00f3ff'];StatsManager.data.unlockedSkins.push(s.color);Game.player.color=s.color;StatsManager.data.equippedSkin=s.color;StatsManager.save();toast('Skin dÃ©verrouillÃ© !','success');this.renderShop();}
            else toast('Pas assez de crÃ©dits !','error');return;
        }
        const d=await API.post('/shop/buy',{skinId:s.id});
        if(d.error){toast(d.error,'error');return;}
        Auth.user.credits=d.newCredits;Auth.user.unlockedSkins=d.unlockedSkins;localStorage.setItem('nd_user',JSON.stringify(Auth.user));
        Game.player.color=s.color;StatsManager.data.equippedSkin=s.color;StatsManager.save();
        toast(d.message,'success');this.renderShop();
    },
    async renderLead(){
        const c=document.getElementById('leaderboard-content');
        c.innerHTML='<div class="loading-text">âŸ³ CONNEXION...</div>';
        const d=await API.get('/scores/leaderboard');
        if(d.error||!Array.isArray(d)){c.innerHTML='<p class="form-error">Impossible de charger.</p>';return;}
        if(!d.length){c.innerHTML='<div class="empty-lead">// AUCUN SCORE</div>';return;}
        c.innerHTML=d.map(e=>`<div class="lead-row" style="animation-delay:${e.rank*.05}s"><span class="lead-rank ${e.rank<=3?'lead-rank-top':''}">${e.rank<=3?['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][e.rank-1]:e.rank}</span><div class="lead-avatar" style="${e.avatar?'background-image:url('+e.avatar+')':''}">${!e.avatar?e.displayName[0].toUpperCase():''}</div><div class="lead-info"><div class="lead-name">${e.displayName}</div><div class="lead-level">${e.level}</div></div><div class="lead-score">${e.score.toLocaleString()} <span style="font-size:9px;opacity:.5">pts</span></div></div>`).join('');
    },
    renderStats(){
        const d=StatsManager.data,u=Auth.user;
        const rows=[{label:'Joueur',value:u?u.displayName:d.username},{label:'RÃ´le',value:u?(u.role==='admin'?'âš™ ADMIN':'JOUEUR'):'â€”'},{label:'Meilleur score',value:(u?u.highScore:d.highScore).toLocaleString()+' pts'},{label:'CrÃ©dits',value:'â—† '+(u?u.credits:d.credits).toLocaleString()},{label:'Parties jouÃ©es',value:d.gamesPlayed||0},{label:'Morts totales',value:d.deathCount},{label:'Temps de jeu',value:StatsManager.getFormattedTime()},{label:'Meilleur niveau',value:d.bestLevel||'TUTORIAL'},{label:'Skins dÃ©bloquÃ©s',value:(u?u.unlockedSkins?.length??1:d.unlockedSkins?.length??1)+' / '+SKINS.length}];
        document.getElementById('stats-content').innerHTML=rows.map(r=>`<div class="stat-row"><span class="stat-row-label">${r.label}</span><span class="stat-row-value">${r.value}</span></div>`).join('');
    },
    renderProfile(){
        const conn=document.getElementById('profile-connected'),guest=document.getElementById('profile-guest'),u=Auth.user;
        if(u){conn.style.display='flex';guest.style.display='none';const av=document.getElementById('profile-avatar'),fb=document.getElementById('profile-avatar-fallback');if(u.profilePicture){av.src=u.profilePicture;av.style.display='block';fb.style.display='none';}else{av.style.display='none';fb.style.display='flex';fb.innerText=u.displayName[0].toUpperCase();}document.getElementById('profile-username').innerText=u.displayName;document.getElementById('profile-credits').innerText=u.credits.toLocaleString();document.getElementById('profile-hs').innerText=u.highScore.toLocaleString();document.getElementById('profile-level').innerText=u.highScoreLevel||'TUTORIAL';document.getElementById('profile-role-badge').innerHTML=u.role==='admin'?'<div class="role-badge role-admin">âš™ ADMINISTRATEUR</div>':'<div class="role-badge role-player">â— JOUEUR</div>';}
        else{conn.style.display='none';guest.style.display='flex';}
    },
    confirmQuit(){this.show('layer-confirm');}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg,type='success'){
    const t=document.createElement('div');t.className='toast toast-'+type;t.innerText=msg;
    document.body.appendChild(t);setTimeout(()=>t.classList.add('toast-show'),10);
    setTimeout(()=>{t.classList.remove('toast-show');setTimeout(()=>t.remove(),400);},3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEV TOOLS (accÃ¨s clandestin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DevTools={
    _clicks:0,_ct:null,
    titleClick(){
        this._clicks++;const h=document.getElementById('dev-hint');h.style.display='block';
        document.getElementById('dev-hint-count').innerText=this._clicks;
        clearTimeout(this._ct);this._ct=setTimeout(()=>{this._clicks=0;h.style.display='none';},2000);
        if(this._clicks>=5){this._clicks=0;h.style.display='none';Admin.toggle();}
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _allUsers=[];
const Admin = {
    _tab:'joueurs',

    show(){
        document.getElementById('admin-toggle-btn').style.display='flex';
        document.getElementById('ap-username').innerText=Auth.user?.displayName||'';
    },
    hide(){document.getElementById('admin-toggle-btn').style.display='none';this.close();},

    toggle(){const p=document.getElementById('admin-panel');p.classList.contains('open')?this.close():this.open();},
    open(){
        document.getElementById('admin-panel').classList.add('open');
        document.getElementById('devtools-overlay').classList.add('active');
        this.refreshTab();
    },
    close(){
        document.getElementById('admin-panel').classList.remove('open');
        document.getElementById('devtools-overlay').classList.remove('active');
    },

    tab(name){
        this._tab=name;
        ['joueurs','classement','jeu','stats'].forEach(t=>{
            document.getElementById('aptab-'+t).classList.toggle('active',t===name);
            document.getElementById('ap-'+t).style.display=t===name?'flex':'none';
        });
        this.refreshTab();
    },

    refreshTab(){
        if(this._tab==='joueurs') this.loadUsers();
        if(this._tab==='classement') this.loadLeaderboard();
        if(this._tab==='stats') this.loadGlobalStats();
        if(this._tab==='jeu') this._refreshJeu();
    },

    _refreshJeu(){
        document.getElementById('ap-credits-local').value=Auth.user?Auth.user.credits:StatsManager.data.credits;
        document.getElementById('ap-score-set').value=Game.running?Game.score:0;
        document.getElementById('ap-god-btn').innerText='GOD : '+(Game.godMode?'ON âœ“':'OFF');
    },

    // â”€â”€ JOUEURS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async loadUsers(){
        const list=document.getElementById('ap-user-list');
        list.innerHTML='<div class="ap-loading">âŸ³ Chargement...</div>';
        const data=await API.get('/admin/users');
        if(data.error){list.innerHTML=`<div class="ap-error">${data.error}</div>`;return;}
        _allUsers=data;
        this._renderPills(data);
        this._renderUsers(data);
    },

    filter(){
        const q=document.getElementById('ap-search').value.toLowerCase();
        this._renderUsers(_allUsers.filter(u=>u.displayName.toLowerCase().includes(q)||u.username.includes(q)));
    },

    _renderPills(users){
        document.getElementById('ap-user-pills').innerHTML=`
            <div class="ap-pill">${users.length} <span>joueurs</span></div>
            <div class="ap-pill pill-red">${users.filter(u=>u.banned).length} <span>bannis</span></div>
            <div class="ap-pill pill-gold">${users.filter(u=>u.role==='admin').length} <span>admins</span></div>`;
    },

    _renderUsers(users){
        const list=document.getElementById('ap-user-list');
        if(!users.length){list.innerHTML='<div class="ap-empty">Aucun rÃ©sultat</div>';return;}
        list.innerHTML=users.map(u=>`
        <div class="ap-user-card ${u.banned?'card-banned':''} ${u.role==='admin'?'card-admin':''}">
            <div class="ap-user-top">
                <div class="ap-user-av" style="${u.avatar?'background-image:url('+u.avatar+')':''}">${!u.avatar?u.displayName[0].toUpperCase():''}</div>
                <div class="ap-user-info">
                    <div class="ap-user-name">${u.role==='admin'?'âš™ ':''}${u.displayName} ${u.pinned?'ğŸ“Œ':''} ${u.banned?'<span class="tag-banned">BANNI</span>':''}</div>
                    <div class="ap-user-sub">â—†${u.credits.toLocaleString()} Â· ${u.highScore.toLocaleString()}pts Â· ${u.highScoreLevel}</div>
                    <div class="ap-user-sub" style="color:#333">${new Date(u.createdAt).toLocaleDateString('fr-FR')}</div>
                </div>
            </div>
            ${u.banned&&u.bannedReason?`<div class="ap-ban-reason">âš  ${u.bannedReason}</div>`:''}
            <div class="ap-user-actions">
                ${u.banned
                    ?`<button class="ap-btn" onclick="Admin.unban('${u.id}')">DÃ‰BANNIR</button>`
                    :u.role!=='admin'?`<button class="ap-btn ap-btn-red" onclick="Admin.ban('${u.id}','${u.displayName}')">BAN</button>`:''
                }
                ${u.role!=='admin'?`<button class="ap-btn" onclick="Admin.editScore('${u.id}','${u.displayName}',${u.highScore})">SCORE</button>`:''}
                <button class="ap-btn" onclick="Admin.editCredits('${u.id}','${u.displayName}',${u.credits})">CRÃ‰DITS</button>
                ${u.role!=='admin'
                    ?`<button class="ap-btn ap-btn-gold" onclick="Admin.promote('${u.id}','${u.displayName}','admin')">â†‘ ADMIN</button>`
                    :(Auth.user?.id!==u.id?`<button class="ap-btn" onclick="Admin.promote('${u.id}','${u.displayName}','player')">â†“ JOUEUR</button>`:'')
                }
                ${u.role!=='admin'?`<button class="ap-btn ap-btn-red" onclick="Admin.deleteUser('${u.id}','${u.displayName}')">SUPPR</button>`:''}
            </div>
        </div>`).join('');
    },

    async ban(id,name){
        const r=prompt(`Raison du ban de ${name}:`,'Violation des rÃ¨gles');if(r===null)return;
        const d=await API.post('/admin/ban',{userId:id,reason:r});
        d.error?toast(d.error,'error'):(toast(d.message,'success'),this.loadUsers());
    },
    async unban(id){const d=await API.post('/admin/unban',{userId:id});d.error?toast(d.error,'error'):(toast(d.message,'success'),this.loadUsers());},
    async editCredits(id,name,cur){
        const v=prompt(`CrÃ©dits de ${name} (actuel: ${cur}):`,cur);if(v===null)return;
        const c=parseInt(v);if(isNaN(c)||c<0){toast('Valeur invalide','error');return;}
        const d=await API.post('/admin/set-credits',{userId:id,credits:c});
        d.error?toast(d.error,'error'):(toast(d.message,'success'),this.loadUsers());
    },
    async editScore(id,name,cur){
        const v=prompt(`Score de ${name} (actuel: ${cur}):`,cur);if(v===null)return;
        const s=parseInt(v);if(isNaN(s)||s<0){toast('Valeur invalide','error');return;}
        const d=await API.post('/admin/set-score',{userId:id,score:s});
        d.error?toast(d.error,'error'):(toast(d.message,'success'),this.loadUsers());
    },
    async promote(id,name,role){
        if(!confirm(`${role==='admin'?'Promouvoir':'RÃ©trograder'} ${name} ?`))return;
        const d=await API.post('/admin/promote',{userId:id,role});
        d.error?toast(d.error,'error'):(toast(d.message,'success'),this.loadUsers());
    },
    async deleteUser(id,name){
        if(!confirm(`âš  Supprimer DÃ‰FINITIVEMENT ${name} ?`))return;
        const d=await API.del('/admin/delete-user',{userId:id});
        d.error?toast(d.error,'error'):(toast(d.message,'success'),this.loadUsers());
    },

    // â”€â”€ CLASSEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async loadLeaderboard(){
        const list=document.getElementById('ap-lead-list');
        list.innerHTML='<div class="ap-loading">âŸ³ Chargement...</div>';
        const data=await API.get('/admin/users');
        if(data.error){list.innerHTML=`<div class="ap-error">${data.error}</div>`;return;}
        const sorted=[...data].sort((a,b)=>{if(b.pinned&&!a.pinned)return 1;if(a.pinned&&!b.pinned)return-1;return b.highScore-a.highScore;});
        list.innerHTML=sorted.map((u,i)=>`
        <div class="ap-lead-row ${u.pinned?'lead-pinned':''}">
            <span class="ap-lead-rank">${u.pinned?'ğŸ“Œ':i+1}</span>
            <div class="ap-user-av small" style="${u.avatar?'background-image:url('+u.avatar+')':''}">${!u.avatar?u.displayName[0].toUpperCase():''}</div>
            <div class="ap-lead-info">
                <div class="ap-user-name">${u.displayName}</div>
                <div class="ap-user-sub">${u.highScoreLevel}</div>
            </div>
            <div class="ap-lead-score">${u.highScore.toLocaleString()}</div>
            <div class="ap-lead-actions">
                <button class="ap-btn ap-btn-xs" onclick="Admin.pin('${u.id}',${!u.pinned})">${u.pinned?'ğŸ“Œ OFF':'ğŸ“Œ PIN'}</button>
                <button class="ap-btn ap-btn-xs ap-btn-red" onclick="Admin.kickScore('${u.id}','${u.displayName}')">KICK</button>
                <button class="ap-btn ap-btn-xs ap-btn-gold" onclick="Admin.editScore('${u.id}','${u.displayName}',${u.highScore})">EDIT</button>
            </div>
        </div>`).join('');
    },

    async kickScore(id,name){
        if(!confirm(`Remettre le score de ${name} Ã  zÃ©ro ?`))return;
        const d=await API.post('/admin/kick-score',{userId:id});
        d.error?toast(d.error,'error'):(toast(d.message,'success'),this.loadLeaderboard());
    },
    async pin(id,pin){
        const d=await API.post('/admin/pin',{userId:id,pin});
        d.error?toast(d.error,'error'):(toast(d.message,'success'),this.loadLeaderboard());
    },
    async resetLeaderboard(){
        if(!confirm('âš  Remettre TOUS les scores Ã  zÃ©ro ? IrrÃ©versible.'))return;
        const d=await API.post('/admin/reset-leaderboard',{});
        d.error?toast(d.error,'error'):(toast(d.message,'success'),this.loadLeaderboard());
    },

    // â”€â”€ JEU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    setSpeed(){
        const v=parseFloat(document.getElementById('ap-speed').value);
        document.getElementById('ap-speed-val').innerText=v.toFixed(1);
        Game.speedMultiplier=v;
    },
    speedPreset(v){document.getElementById('ap-speed').value=v;this.setSpeed();},

    setRate(){
        const v=parseFloat(document.getElementById('ap-rate').value);
        document.getElementById('ap-rate-val').innerText=v.toFixed(1);
        Game.rateMultiplier=v;
    },
    ratePreset(v){document.getElementById('ap-rate').value=v;this.setRate();},

    spawnEnemy(type,count){
        if(!Game.running){toast('Lance une partie d\'abord !','error');return;}
        const lvl=LevelSystem.getCurrentLevel(Game.score);
        for(let i=0;i<count;i++){
            const e=Game._mk(lvl);
            if(type==='tracker'){e.tracker=true;}
            else if(type==='zigzag'){e.zigzag=true;e.tracker=false;}
            e.x=Math.random()*Game.canvas.width;
            Game.enemies.push(e);
        }
        toast(`+${count} ennemis ${type} !`,'success');
    },

    spawnCircle(){
        if(!Game.running){toast('Lance une partie d\'abord !','error');return;}
        const lvl=LevelSystem.getCurrentLevel(Game.score);
        for(let a=0;a<8;a++){
            const angle=(a/8)*Math.PI*2;
            const e=Game._mk(lvl);
            e.x=Game.canvas.width/2+Math.cos(angle)*300;e.y=-30;
            e.vx=Math.cos(angle)*1.5;e.tracker=false;
            Game.enemies.push(e);
        }
        toast('Cercle de 8 ennemis !','success');
    },

    forceBonus(type){
        if(!Game.running){toast('Lance une partie d\'abord !','error');return;}
        if(type==='all'||type==='shield'){BonusSystem.active.shield=true;BonusSystem.timers.shield=600;}
        if(type==='all'||type==='slow'){BonusSystem.active.slow=true;BonusSystem.timers.slow=600;}
        if(type==='all'||type==='magnet'){BonusSystem.active.magnet=true;BonusSystem.timers.magnet=600;}
        BonusSystem._updateHUD();
        toast(type==='all'?'Tous les bonus activÃ©s !':type+' activÃ© !','success');
    },

    setGameScore(){
        const v=parseInt(document.getElementById('ap-score-set').value);
        if(isNaN(v)||v<0){toast('Valeur invalide','error');return;}
        if(!Game.running){toast('Lance une partie d\'abord !','error');return;}
        Game.score=v;toast('Score â†’ '+v,'success');
    },

    forceGameOver(){
        if(!Game.running){toast('Pas de partie en cours','error');return;}
        Game.stop();toast('Game over forcÃ©','success');
    },

    toggleGod(){
        Game.godMode=!Game.godMode;
        document.getElementById('ap-god-btn').innerText='GOD : '+(Game.godMode?'ON âœ“':'OFF');
        toast('Mode god : '+(Game.godMode?'ON':'OFF'),'success');
    },

    setLocalCredits(){
        const v=parseInt(document.getElementById('ap-credits-local').value);
        if(isNaN(v)||v<0){toast('Valeur invalide','error');return;}
        StatsManager.data.credits=v;StatsManager.save();
        if(Auth.user){Auth.user.credits=v;localStorage.setItem('nd_user',JSON.stringify(Auth.user));}
        toast('CrÃ©dits â†’ '+v,'success');
    },

    // â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async loadGlobalStats(){
        const el=document.getElementById('ap-global-stats');
        el.innerHTML='<div class="ap-loading">âŸ³ Chargement...</div>';
        const d=await API.get('/admin/stats');
        if(d.error){el.innerHTML=`<div class="ap-error">${d.error}</div>`;return;}
        el.innerHTML=`
            <div class="ap-stat-card"><div class="ap-stat-big">${d.totalUsers}</div><div class="ap-stat-lbl">JOUEURS</div></div>
            <div class="ap-stat-card"><div class="ap-stat-big" style="color:#ff4444">${d.totalBanned}</div><div class="ap-stat-lbl">BANNIS</div></div>
            <div class="ap-stat-card"><div class="ap-stat-big" style="color:#ffcc00">${d.totalAdmins}</div><div class="ap-stat-lbl">ADMINS</div></div>
            <div class="ap-stat-card"><div class="ap-stat-big" style="color:#00f3ff">${d.totalUsers-d.totalBanned}</div><div class="ap-stat-lbl">ACTIFS</div></div>
            ${d.topScore?`<div class="ap-stat-card ap-stat-full"><div class="ap-stat-big" style="color:#ffd700">${d.topScore.score.toLocaleString()} pts</div><div class="ap-stat-lbl">RECORD MONDIAL Â· ${d.topScore.name} Â· ${d.topScore.level}</div></div>`:''}
        `;
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BONUS SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BonusSystem = {
    items:[],active:{shield:false,slow:false,magnet:false},timers:{shield:0,slow:0,magnet:0},spawnTimer:0,SPAWN_INTERVAL:1800,
    reset(){this.items=[];this.active={shield:false,slow:false,magnet:false};this.timers={shield:0,slow:0,magnet:0};this.spawnTimer=0;this._updateHUD();},
    update(px,py,score,canvas){
        this.spawnTimer++;
        if(this.spawnTimer>=this.SPAWN_INTERVAL+Math.floor(Math.random()*600)){
            this.spawnTimer=0;
            const types=[{type:'shield',label:'ğŸ›¡',color:'#00ff88'},{type:'slow',label:'âš¡',color:'#00f3ff'},{type:'magnet',label:'ğŸ§²',color:'#ff00ff'},{type:'credits',label:'â—†',color:'#ffcc00'}];
            const t=types[Math.floor(Math.random()*types.length)];
            this.items.push({x:50+Math.random()*(canvas.width-100),y:-30,...t,speed:2,pulse:0});
        }
        ['shield','slow','magnet'].forEach(k=>{if(this.active[k]){this.timers[k]--;if(this.timers[k]<=0){this.active[k]=false;this._updateHUD();}}});
        if(this.active.magnet){this.items.forEach(b=>{const dx=(px+15)-b.x,dy=(py+15)-b.y,dist=Math.hypot(dx,dy)||1;if(dist<300){b.x+=dx/dist*4;b.y+=dy/dist*4;}});}
        for(let i=this.items.length-1;i>=0;i--){
            const b=this.items[i];b.y+=b.speed;b.pulse+=.1;
            if(Math.hypot(px+15-b.x,py+15-b.y)<28){this._collect(b);this.items.splice(i,1);continue;}
            if(b.y>canvas.height+50)this.items.splice(i,1);
        }
    },
    _collect(b){
        if(b.type==='shield'){this.active.shield=true;this.timers.shield=300;}
        else if(b.type==='slow'){this.active.slow=true;this.timers.slow=300;}
        else if(b.type==='magnet'){this.active.magnet=true;this.timers.magnet=420;}
        else if(b.type==='credits'){const e=50;StatsManager.data.credits+=e;StatsManager.save();if(Auth.user){Auth.user.credits+=e;localStorage.setItem('nd_user',JSON.stringify(Auth.user));}}
        toast(b.type==='credits'?'â—† +50 crÃ©dits':b.label+' '+b.type,'success');this._updateHUD();
    },
    _updateHUD(){
        document.getElementById('bonus-shield').style.display=this.active.shield?'flex':'none';
        document.getElementById('bonus-slow').style.display=this.active.slow?'flex':'none';
        document.getElementById('bonus-magnet').style.display=this.active.magnet?'flex':'none';
    },
    draw(ctx){
        this.items.forEach(b=>{
            const glow=Math.sin(b.pulse)*8+12;
            ctx.save();ctx.shadowBlur=glow;ctx.shadowColor=b.color;
            ctx.beginPath();ctx.arc(b.x,b.y,14,0,Math.PI*2);ctx.fillStyle=b.color+'33';ctx.fill();ctx.strokeStyle=b.color;ctx.lineWidth=1.5;ctx.stroke();
            ctx.shadowBlur=0;ctx.font='14px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(b.label,b.x,b.y);
            ctx.restore();
        });
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Game = {
    canvas:document.getElementById('gameCanvas'),
    ctx:null,running:false,paused:false,score:0,
    player:{x:0,y:0,color:'#00f3ff'},
    enemies:[],trails:[],bgParticles:[],
    currentLevelName:'',burstTimer:0,glitchTimer:0,timeTimer:0,animFrame:null,
    godMode:false,
    speedMultiplier:1.0,
    rateMultiplier:1.0,

    init(){
        this.ctx=this.canvas.getContext('2d');this.resize();
        StatsManager.init();
        if(StatsManager.data.equippedSkin)this.player.color=StatsManager.data.equippedSkin;
        for(let i=0;i<80;i++)this.bgParticles.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,size:Math.random()*1.5+.3,speed:Math.random()*.4+.1});
        window.addEventListener('resize',()=>this.resize());
        window.addEventListener('keydown',(e)=>{if((e.key==='Escape'||e.key==='p'||e.key==='P')&&this.running)this.togglePause();});
        this.canvas.addEventListener('touchmove',(e)=>{e.preventDefault();this.player.x=e.touches[0].clientX-15;},{passive:false});
        if(Auth.token&&Auth.user&&Auth.isAdmin())Admin.show();
        Auth._ui();BgCanvas.init();
    },

    resize(){this.canvas.width=window.innerWidth;this.canvas.height=window.innerHeight;},

    start(){
        if(this.animFrame)cancelAnimationFrame(this.animFrame);
        this.running=true;this.paused=false;this.score=0;this.enemies=[];this.trails=[];
        this.burstTimer=0;this.glitchTimer=0;this.timeTimer=0;this.currentLevelName='';
        this.speedMultiplier=1.0;this.rateMultiplier=1.0;
        BonusSystem.reset();
        // Reset sliders admin
        if(document.getElementById('ap-speed')){document.getElementById('ap-speed').value=1;document.getElementById('ap-speed-val').innerText='1.0';}
        if(document.getElementById('ap-rate')){document.getElementById('ap-rate').value=1;document.getElementById('ap-rate-val').innerText='1.0';}
        this.player.x=this.canvas.width/2-15;this.player.y=this.canvas.height-80;
        document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
        document.getElementById('layer-game').style.display='block';
        document.getElementById('pause-menu').style.display='none';
        BgCanvas.hide();
        StatsManager.data.gamesPlayed=(StatsManager.data.gamesPlayed||0)+1;StatsManager.save();
        window.onmousemove=(ev)=>{this.player.x=ev.clientX-15;};
        this.loop();
    },

    async stop(){
        if(!this.running)return;
        this.running=false;this.paused=false;window.onmousemove=null;
        if(this.animFrame)cancelAnimationFrame(this.animFrame);
        const fs=this.score,lvl=LevelSystem.getCurrentLevel(fs),lvlName=lvl.name;
        StatsManager.data.deathCount++;
        const isNew=fs>StatsManager.data.highScore;
        if(isNew){StatsManager.data.highScore=fs;StatsManager.data.bestLevel=lvlName;}
        StatsManager.save();
        let ce=Math.floor(fs/10),isNewHs=isNew;
        if(Auth.token){const r=await API.post('/scores/submit',{score:fs,level:lvlName});if(!r.error){ce=r.creditsEarned;isNewHs=r.isNewHighScore;Auth.user.credits=r.newCredits;Auth.user.highScore=r.highScore;if(isNewHs)Auth.user.highScoreLevel=lvlName;localStorage.setItem('nd_user',JSON.stringify(Auth.user));}}
        else{StatsManager.data.credits+=ce;StatsManager.save();}
        document.getElementById('layer-game').style.display='none';
        document.getElementById('layer-death').style.display='flex';
        BgCanvas.show();
        document.getElementById('death-stats').innerHTML=`<div class="death-score">${fs.toLocaleString()}</div><div class="death-score-label">POINTS</div><div class="death-info-grid"><div class="death-info-item"><div class="death-info-val" style="color:${lvl.color}">${lvlName}</div><div class="death-info-lbl">NIVEAU</div></div><div class="death-info-item"><div class="death-info-val" style="color:#ffcc00">+${ce.toLocaleString()}</div><div class="death-info-lbl">CRÃ‰DITS</div></div><div class="death-info-item"><div class="death-info-val">${LevelSystem.getTierName(fs)}</div><div class="death-info-lbl">TIER</div></div></div>${isNewHs?'<div class="new-record">ğŸ† NOUVEAU RECORD !</div>':''}${!Auth.token?'<div class="death-login-hint">Connecte-toi pour sauvegarder !</div>':''}`;
        const gl=document.querySelector('.death-glitch');if(gl){let c=0;const gi=setInterval(()=>{gl.style.transform=`translate(${(Math.random()-.5)*6}px,${(Math.random()-.5)*6}px)`;gl.style.opacity=Math.random()>.3?'.5':'0';if(++c>12){clearInterval(gi);gl.style.transform='';gl.style.opacity='.15';}},80);}
    },

    quit(){
        if(this.running){StatsManager.data.credits+=Math.floor(this.score/10);if(this.score>StatsManager.data.highScore)StatsManager.data.highScore=this.score;StatsManager.save();}
        this.running=false;this.paused=false;
        if(this.animFrame)cancelAnimationFrame(this.animFrame);
        window.onmousemove=null;
        document.getElementById('layer-game').style.display='none';
        document.getElementById('pause-menu').style.display='none';
        UI.show('layer-menu');
    },

    togglePause(){
        if(!this.running&&!this.paused)return;
        this.paused=!this.paused;
        document.getElementById('pause-menu').style.display=this.paused?'flex':'none';
        document.getElementById('btn-pause').innerText=this.paused?'â–¶':'â¸';
        document.getElementById('pause-score-info').innerText=`Score : ${this.score.toLocaleString()} pts`;
        if(!this.paused)this.loop();
    },

    loop(){if(!this.running||this.paused)return;this.update();this.draw();this.animFrame=requestAnimationFrame(()=>this.loop());},

    update(){
        const lvl=LevelSystem.getCurrentLevel(this.score);
        const slowFactor=BonusSystem.active.slow?0.4:1.0;

        if(lvl.name!==this.currentLevelName){
            this.currentLevelName=lvl.name;
            document.getElementById('ui-level-name').innerText=lvl.name;
            document.getElementById('ui-level-name').style.color=lvl.color||'#00f3ff';
            document.getElementById('ui-level-desc').innerText=lvl.description||'';
            document.getElementById('ui-tier').innerText=LevelSystem.getTierName(this.score);
            this._announce(lvl.name,lvl.color,lvl.description);
            if(this.score>0)StatsManager.data.bestLevel=lvl.name;
        }

        const next=LevelSystem.getNextLevel(this.score);
        if(next){const pct=Math.min(100,((this.score-lvl.scoreReq)/(next.scoreReq-lvl.scoreReq))*100);document.getElementById('next-level-fill').style.width=pct+'%';document.getElementById('next-level-fill').style.background=lvl.color||'#00f3ff';document.getElementById('next-level-label').innerText=`â†’ ${next.name} dans ${(next.scoreReq-this.score).toLocaleString()} pts`;}
        else{document.getElementById('next-level-fill').style.width='100%';document.getElementById('next-level-label').innerText='âˆ MAX NIVEAU';}

        // Spawn avec multiplicateur admin
        if(Math.random()<lvl.rate*this.rateMultiplier)this._spawn(lvl);

        if(lvl.burst){this.burstTimer++;if(this.burstTimer>=90){this.burstTimer=0;const count=3+Math.floor(this.score/5000);for(let i=0;i<count;i++)setTimeout(()=>{if(this.running&&!this.paused)this._spawn(lvl);},i*60);}}
        if(lvl.glitch){this.glitchTimer++;if(this.glitchTimer>=160){this.glitchTimer=0;this.canvas.style.filter=`hue-rotate(${Math.random()*360}deg) brightness(2)`;setTimeout(()=>{this.canvas.style.filter='';},120);for(let a=0;a<6;a++){const angle=(a/6)*Math.PI*2;const e=this._mk(lvl);e.x=this.canvas.width/2+Math.cos(angle)*250;e.y=-30;e.vx=Math.cos(angle)*2;this.enemies.push(e);}}}

        this.timeTimer++;if(this.timeTimer>=60){this.timeTimer=0;StatsManager.incrementTime();}

        const W=this.canvas.width,H=this.canvas.height;
        this.bgParticles.forEach(p=>{p.y+=p.speed;if(p.y>H){p.y=0;p.x=Math.random()*W;}});
        this.trails.push({x:this.player.x+15,y:this.player.y+15,alpha:.4,color:this.player.color});
        if(this.trails.length>8)this.trails.shift();
        this.trails.forEach(t=>{t.alpha-=.04;});

        BonusSystem.update(this.player.x,this.player.y,this.score,this.canvas);

        for(let i=this.enemies.length-1;i>=0;i--){
            const e=this.enemies[i];
            const spd=e.speed*this.speedMultiplier*slowFactor;
            if(e.tracker){
                const dx=(this.player.x+15)-(e.x+12),dy=(this.player.y+15)-(e.y+12),dist=Math.hypot(dx,dy)||1;
                e.x+=(dx/dist)*e.trackSpeed*this.speedMultiplier*slowFactor;
                e.y+=((Math.abs(dy/dist)*spd)+e.trackSpeed*this.speedMultiplier*slowFactor)*.5+1;
            } else {
                if(e.zigzag)e.x+=Math.sin(e.y*.05+e.phase)*3;
                e.x+=e.vx||0;e.y+=spd;
            }
            if(!this.godMode&&!BonusSystem.active.shield){
                if(Math.hypot(this.player.x+15-(e.x+12),this.player.y+15-(e.y+12))<24){this.stop();return;}
            } else if(!this.godMode&&BonusSystem.active.shield){
                if(Math.hypot(this.player.x+15-(e.x+12),this.player.y+15-(e.y+12))<24){BonusSystem.active.shield=false;BonusSystem.timers.shield=0;BonusSystem._updateHUD();this.enemies.splice(i,1);toast('Bouclier brisÃ© !','error');continue;}
            }
            if(e.y>H+60||e.x<-100||e.x>W+100){this.enemies.splice(i,1);this.score+=10;}
        }
        document.getElementById('ui-score').innerText=this.score.toLocaleString();
    },

    _mk(lvl){
        const isTracker=lvl.tracker&&Math.random()<(lvl.trackRatio||.3);
        return{x:Math.random()*this.canvas.width,y:-50,speed:lvl.speed+(Math.random()*1.5-.75),tracker:isTracker,trackSpeed:lvl.speed*.25,zigzag:!isTracker&&lvl.zigzag&&Math.random()<.5,phase:Math.random()*Math.PI*2,color:lvl.color||'#ff3838',vx:0,size:18+Math.random()*8};
    },
    _spawn(lvl){this.enemies.push(this._mk(lvl));},

    _announce(name,color,desc){
        const el=document.getElementById('level-announce');
        el.style.color=color||'#00f3ff';el.style.opacity='1';el.style.transform='scale(1.15)';
        el.innerHTML=name+(desc?`<div class="announce-sub">${desc}</div>`:'');
        clearTimeout(this._aTO);this._aTO=setTimeout(()=>{el.style.opacity='0';el.style.transform='scale(1)';},2200);
    },

    draw(){
        const lvl=LevelSystem.getCurrentLevel(this.score),C=this.ctx;
        C.fillStyle=lvl.bgColor||'#050505';C.fillRect(0,0,this.canvas.width,this.canvas.height);
        C.shadowBlur=0;
        this.bgParticles.forEach(p=>{C.fillStyle=(lvl.color||'#00f3ff')+'18';C.beginPath();C.arc(p.x,p.y,p.size,0,Math.PI*2);C.fill();});
        this.trails.forEach(t=>{if(t.alpha<=0)return;C.globalAlpha=t.alpha;C.fillStyle=t.color;C.shadowBlur=8;C.shadowColor=t.color;C.fillRect(t.x-4,t.y-4,8,8);});
        C.globalAlpha=1;
        C.shadowBlur=25;C.shadowColor=this.player.color;C.fillStyle=this.player.color;
        C.fillRect(this.player.x,this.player.y,30,30);
        C.fillStyle='#ffffff66';C.fillRect(this.player.x+6,this.player.y+6,10,10);
        if(BonusSystem.active.shield){C.strokeStyle='#00ff88';C.lineWidth=2;C.shadowColor='#00ff88';C.shadowBlur=20;C.beginPath();C.arc(this.player.x+15,this.player.y+15,24,0,Math.PI*2);C.stroke();}
        if(this.godMode){C.strokeStyle='#ffcc00';C.lineWidth=2;C.shadowColor='#ffcc00';C.shadowBlur=15;C.strokeRect(this.player.x-5,this.player.y-5,40,40);}
        this.enemies.forEach(e=>{const c=e.color||'#ff3838';C.shadowBlur=16;C.shadowColor=c;C.fillStyle=c;C.fillRect(e.x,e.y,e.size,e.size);if(e.tracker){C.strokeStyle='#ffffff88';C.lineWidth=1;C.strokeRect(e.x-3,e.y-3,e.size+6,e.size+6);C.beginPath();C.moveTo(e.x+e.size/2,e.y-8);C.lineTo(e.x+e.size/2,e.y);C.stroke();}});
        BonusSystem.draw(C);
        C.shadowBlur=0;
    }
};

window.onload=()=>Game.init();
</script>
</body>
</html>
