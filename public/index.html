<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON DODGE - PRO NETWORK</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MENU PRINCIPAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-menu" class="screen">
    <div id="user-tag" onclick="UI.show('layer-profile')">
        <div id="user-tag-avatar"></div>
        <span id="user-tag-name">Non connect√©</span>
    </div>
    <h1 class="neon-title">NEON DODGE</h1>
    <div class="menu-grid">
        <button class="btn" onclick="Game.start()">JOUER</button>
        <button class="btn btn-blue" onclick="UI.show('layer-shop')">BOUTIQUE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-lead')">CLASSEMENT</button>
        <button class="btn btn-blue" onclick="UI.show('layer-profile')">COMPTE</button>
    </div>
    <div id="menu-highscore"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOUTIQUE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-shop" class="screen" style="display:none;">
    <h2>BOUTIQUE DE SKINS</h2>
    <p class="credits-display">CR√âDITS : <span id="shop-credits">0</span></p>
    <div id="skin-list" class="skin-grid"></div>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CLASSEMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-lead" class="screen" style="display:none;">
    <h2>TOP JOUEURS</h2>
    <div id="leaderboard-content" class="leaderboard-list"></div>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPTE / TERMINAL OS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-profile" class="screen" style="display:none;">
    <div id="profile-connected" style="display:none;">
        <div id="profile-avatar-wrap">
            <img id="profile-avatar" src="" alt="Avatar">
        </div>
        <h2 id="profile-username">-</h2>
        <div class="profile-stats">
            <div class="stat-box"><div class="stat-val" id="profile-credits">0</div><div class="stat-lbl">CR√âDITS</div></div>
            <div class="stat-box"><div class="stat-val" id="profile-hs">0</div><div class="stat-lbl">HIGH SCORE</div></div>
            <div class="stat-box"><div class="stat-val" id="profile-level">-</div><div class="stat-lbl">NIVEAU MAX</div></div>
        </div>
        <button class="btn btn-red" onclick="Auth.logout()">D√âCONNEXION</button>
        <button class="btn" onclick="UI.show('layer-menu')">RETOUR</button>
    </div>
    <div id="profile-guest" style="display:none;">
        <h2>TERMINAL OS</h2>
        <p style="color:#888; font-size:12px;">Connecte-toi pour sauvegarder tes scores et acc√©der √† la boutique.</p>
        <button class="btn" onclick="UI.show('layer-auth')">CONNEXION</button>
        <button class="btn" onclick="UI.show('layer-menu')">RETOUR</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH (LOGIN + REGISTER) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-auth" class="screen" style="display:none;">
    <h2>ACC√àS R√âSEAU</h2>
    <div class="auth-tabs">
        <button id="tab-login" class="tab-btn tab-active" onclick="Auth.switchTab('login')">CONNEXION</button>
        <button id="tab-register" class="tab-btn" onclick="Auth.switchTab('register')">INSCRIPTION</button>
    </div>

    <!-- Connexion -->
    <div id="form-login">
        <input type="text" id="login-user" placeholder="Pseudo" autocomplete="username">
        <input type="password" id="login-pass" placeholder="Mot de passe" autocomplete="current-password">
        <div id="login-error" class="form-error"></div>
        <button class="btn" onclick="Auth.login()">CONNEXION</button>
    </div>

    <!-- Inscription -->
    <div id="form-register" style="display:none;">
        <input type="text" id="reg-user" placeholder="Pseudo (3-20 caract√®res)" autocomplete="username">
        <input type="password" id="reg-pass" placeholder="Mot de passe (6+ caract√®res)" autocomplete="new-password">
        <label class="file-label" for="reg-avatar">
            <span id="file-label-text">üì∑ Photo de profil (optionnel)</span>
            <input type="file" id="reg-avatar" accept="image/jpeg,image/png,image/webp" onchange="Auth.previewAvatar(this)">
        </label>
        <img id="avatar-preview" style="display:none;" alt="Aper√ßu">
        <div id="reg-error" class="form-error"></div>
        <button class="btn" onclick="Auth.register()">CR√âER LE COMPTE</button>
    </div>

    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JEU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-game" style="display:none;">
    <canvas id="gameCanvas"></canvas>
    <div id="hud">
        <div id="score-container">SCORE: <span id="ui-score">0</span></div>
        <div id="level-display">S√âCURIT√â</div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME OVER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-gameover" class="screen" style="display:none;">
    <h2>GAME OVER</h2>
    <div id="gameover-score"></div>
    <div id="gameover-credits"></div>
    <div id="gameover-hs"></div>
    <button class="btn" onclick="Game.start()">REJOUER</button>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">MENU</button>
</div>

<script src="levels.js"></script>
<script>

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  API CLIENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API = {
  BASE: '/api',

  _headers(multipart = false) {
    const h = {};
    const token = Auth.token;
    if (token) h['Authorization'] = 'Bearer ' + token;
    if (!multipart) h['Content-Type'] = 'application/json';
    return h;
  },

  async post(path, body, multipart = false) {
    const resp = await fetch(this.BASE + path, {
      method: 'POST',
      headers: this._headers(multipart),
      body: multipart ? body : JSON.stringify(body)
    });
    return resp.json();
  },

  async get(path) {
    const resp = await fetch(this.BASE + path, { headers: this._headers() });
    return resp.json();
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Auth = {
  token: localStorage.getItem('nd_token') || null,
  user: JSON.parse(localStorage.getItem('nd_user') || 'null'),

  switchTab(tab) {
    const isLogin = tab === 'login';
    document.getElementById('form-login').style.display = isLogin ? 'flex' : 'none';
    document.getElementById('form-register').style.display = isLogin ? 'none' : 'flex';
    document.getElementById('tab-login').classList.toggle('tab-active', isLogin);
    document.getElementById('tab-register').classList.toggle('tab-active', !isLogin);
    document.getElementById('login-error').innerText = '';
    document.getElementById('reg-error').innerText = '';
  },

  previewAvatar(input) {
    const file = input.files[0];
    if (!file) return;
    const preview = document.getElementById('avatar-preview');
    document.getElementById('file-label-text').innerText = '‚úÖ ' + file.name;
    preview.src = URL.createObjectURL(file);
    preview.style.display = 'block';
  },

  async login() {
    const user = document.getElementById('login-user').value.trim();
    const pass = document.getElementById('login-pass').value;
    const errEl = document.getElementById('login-error');
    errEl.innerText = '';

    if (!user || !pass) { errEl.innerText = 'Remplis tous les champs.'; return; }

    const data = await API.post('/auth/login', { username: user, password: pass });
    if (data.error) { errEl.innerText = data.error; return; }

    this._saveSession(data);
    UI.show('layer-menu');
  },

  async register() {
    const username = document.getElementById('reg-user').value.trim();
    const password = document.getElementById('reg-pass').value;
    const avatarFile = document.getElementById('reg-avatar').files[0];
    const errEl = document.getElementById('reg-error');
    errEl.innerText = '';

    if (!username || !password) { errEl.innerText = 'Remplis tous les champs.'; return; }

    const fd = new FormData();
    fd.append('username', username);
    fd.append('password', password);
    if (avatarFile) fd.append('profilePicture', avatarFile);

    const data = await API.post('/auth/register', fd, true);
    if (data.error) { errEl.innerText = data.error; return; }

    this._saveSession(data);
    UI.show('layer-menu');
  },

  _saveSession(data) {
    this.token = data.token;
    this.user = data.user;
    localStorage.setItem('nd_token', data.token);
    localStorage.setItem('nd_user', JSON.stringify(data.user));
    this._updateUI();
  },

  logout() {
    this.token = null;
    this.user = null;
    localStorage.removeItem('nd_token');
    localStorage.removeItem('nd_user');
    this._updateUI();
    UI.show('layer-menu');
  },

  // Rafra√Æchir les donn√©es utilisateur depuis le serveur
  async refreshUser() {
    if (!this.token) return;
    const data = await API.get('/auth/me');
    if (data.error) { this.logout(); return; }
    this.user = data;
    localStorage.setItem('nd_user', JSON.stringify(data));
    this._updateUI();
  },

  _updateUI() {
    const u = this.user;
    const tag = document.getElementById('user-tag-name');
    const tagAvatar = document.getElementById('user-tag-avatar');
    const menuHs = document.getElementById('menu-highscore');

    if (u) {
      tag.innerText = u.displayName;
      if (u.profilePicture) {
        tagAvatar.style.backgroundImage = `url(${u.profilePicture})`;
        tagAvatar.style.display = 'block';
      } else {
        tagAvatar.style.display = 'none';
      }
      menuHs.innerText = `MEILLEUR SCORE : ${u.highScore} pts`;
    } else {
      tag.innerText = 'Non connect√©';
      tagAvatar.style.display = 'none';
      menuHs.innerText = '';
    }
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const UI = {
  show(id) {
    document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
    document.getElementById(id).style.display = 'flex';

    if (id === 'layer-shop')    this.renderShop();
    if (id === 'layer-lead')    this.renderLead();
    if (id === 'layer-profile') this.renderProfile();
    if (id === 'layer-auth')    Auth.switchTab('login');
    if (id === 'layer-menu')    Auth._updateUI();
  },

  async renderShop() {
    const list = document.getElementById('skin-list');
    const credEl = document.getElementById('shop-credits');
    list.innerHTML = '<p style="color:#888">Chargement...</p>';

    const catalog = await API.get('/shop/catalog');

    if (!Auth.user) {
      credEl.innerText = '‚Äî';
    } else {
      await Auth.refreshUser();
      credEl.innerText = Auth.user.credits;
    }

    if (catalog.error) { list.innerHTML = '<p class="form-error">' + catalog.error + '</p>'; return; }

    list.innerHTML = '';
    catalog.forEach(s => {
      const card = document.createElement('div');
      card.className = 'skin-card' + (s.unlocked ? ' skin-unlocked' : '');
      card.style.setProperty('--skin-color', s.color);

      const isEquipped = Game.player.color === s.color;

      card.innerHTML = `
        <div class="skin-preview" style="background:${s.color};box-shadow:0 0 20px ${s.color}"></div>
        <div class="skin-name">${s.name}</div>
        <div class="skin-price">${s.price === 0 ? 'GRATUIT' : s.price + ' cr√©dits'}</div>
        <button class="btn-skin-action ${s.unlocked ? 'btn-equip' : 'btn-buy'}" 
                data-id="${s.id}" data-color="${s.color}" data-price="${s.price}" 
                data-unlocked="${s.unlocked}">
          ${s.unlocked ? (isEquipped ? '‚úÖ √âQUIP√â' : '√âQUIPER') : 'üîí ACHETER'}
        </button>`;

      card.querySelector('.btn-skin-action').addEventListener('click', async (e) => {
        const { id, color, unlocked } = e.target.dataset;
        if (unlocked === 'true') {
          Game.player.color = color;
          this.renderShop(); // rafra√Æchir pour montrer √©quip√©
        } else {
          await this.buySkin(id);
        }
      });

      list.appendChild(card);
    });
  },

  async buySkin(skinId) {
    if (!Auth.token) { alert('Connecte-toi pour acheter des skins.'); return; }

    const data = await API.post('/shop/buy', { skinId });
    if (data.error) { alert(data.error); return; }

    // Mettre √† jour user local
    Auth.user.credits = data.newCredits;
    Auth.user.unlockedSkins = data.unlockedSkins;
    localStorage.setItem('nd_user', JSON.stringify(Auth.user));

    alert(data.message);
    this.renderShop();
  },

  async renderLead() {
    const el = document.getElementById('leaderboard-content');
    el.innerHTML = '<p style="color:#888">Chargement...</p>';

    const data = await API.get('/scores/leaderboard');
    if (data.error || !Array.isArray(data)) {
      el.innerHTML = '<p class="form-error">Impossible de charger le classement.</p>';
      return;
    }
    if (data.length === 0) {
      el.innerHTML = '<p style="color:#555">Aucun score enregistr√©. Sois le premier !</p>';
      return;
    }

    el.innerHTML = data.map(entry => `
      <div class="lead-row">
        <span class="lead-rank">${entry.rank}</span>
        <div class="lead-avatar" style="background-image:url(${entry.avatar || ''})">
          ${!entry.avatar ? entry.displayName[0].toUpperCase() : ''}
        </div>
        <div class="lead-info">
          <div class="lead-name">${entry.displayName}</div>
          <div class="lead-level">${entry.level}</div>
        </div>
        <div class="lead-score">${entry.score} pts</div>
      </div>
    `).join('');
  },

  renderProfile() {
    const connected = document.getElementById('profile-connected');
    const guest = document.getElementById('profile-guest');
    const u = Auth.user;

    if (u) {
      connected.style.display = 'flex';
      guest.style.display = 'none';

      const avatar = document.getElementById('profile-avatar');
      if (u.profilePicture) {
        avatar.src = u.profilePicture;
        avatar.style.display = 'block';
      } else {
        avatar.style.display = 'none';
      }

      document.getElementById('profile-username').innerText = u.displayName;
      document.getElementById('profile-credits').innerText = u.credits;
      document.getElementById('profile-hs').innerText = u.highScore;
      document.getElementById('profile-level').innerText = u.highScoreLevel || 'S√âCURIT√â';
    } else {
      connected.style.display = 'none';
      guest.style.display = 'flex';
    }
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOTEUR DE JEU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Game = {
  canvas: document.getElementById('gameCanvas'),
  ctx: null,
  running: false,
  score: 0,
  currentLevel: null,
  player: { x: 0, y: 0, size: 30, color: '#00f3ff' },
  enemies: [],
  animFrame: null,

  init() {
    this.ctx = this.canvas.getContext('2d');
    this.resize();
    window.addEventListener('resize', () => this.resize());
    Auth._updateUI();
  },

  resize() {
    this.canvas.width = window.innerWidth;
    this.canvas.height = window.innerHeight;
  },

  start() {
    if (this.animFrame) cancelAnimationFrame(this.animFrame);
    this.running = true;
    this.score = 0;
    this.enemies = [];
    this.player.x = this.canvas.width / 2 - 15;
    this.player.y = this.canvas.height - 80;

    document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
    document.getElementById('layer-game').style.display = 'block';

    window.onmousemove = (e) => { this.player.x = e.clientX - 15; };
    this.loop();
  },

  async stop() {
    this.running = false;
    cancelAnimationFrame(this.animFrame);
    window.onmousemove = null;

    const finalScore = this.score;
    const finalLevel = this.currentLevel?.name || 'S√âCURIT√â';

    // Envoyer le score au serveur si connect√©
    let creditsEarned = 0;
    let isNewHs = false;

    if (Auth.token) {
      const res = await API.post('/scores/submit', { score: finalScore, level: finalLevel });
      if (!res.error) {
        creditsEarned = res.creditsEarned;
        isNewHs = res.isNewHighScore;
        Auth.user.credits = res.newCredits;
        Auth.user.highScore = res.highScore;
        localStorage.setItem('nd_user', JSON.stringify(Auth.user));
      }
    }

    // Afficher Game Over
    document.getElementById('layer-game').style.display = 'none';
    document.getElementById('gameover-score').innerHTML =
      `<span class="go-label">SCORE</span><span class="go-value">${finalScore} pts</span>`;
    document.getElementById('gameover-credits').innerHTML =
      creditsEarned > 0
        ? `<span class="go-label">CR√âDITS GAGN√âS</span><span class="go-value" style="color:#ffd700">+${creditsEarned}</span>`
        : '';
    document.getElementById('gameover-hs').innerHTML =
      isNewHs ? `<div class="new-hs">üèÜ NOUVEAU RECORD !</div>` : '';

    document.getElementById('layer-gameover').style.display = 'flex';
  },

  loop() {
    if (!this.running) return;
    this.update();
    this.draw();
    this.animFrame = requestAnimationFrame(() => this.loop());
  },

  update() {
    const lvl = LevelSystem.getCurrentLevel(this.score);
    this.currentLevel = lvl;
    document.getElementById('level-display').innerText = lvl.name;

    if (Math.random() < lvl.rate) {
      const isTracker = lvl.tracker && Math.random() < 0.3;
      this.enemies.push({
        x: Math.random() * this.canvas.width,
        y: -50,
        speed: lvl.speed,
        tracker: isTracker,
        color: isTracker ? '#ff00ff' : '#ff3838'
      });
    }

    for (let i = this.enemies.length - 1; i >= 0; i--) {
      const e = this.enemies[i];
      // Comportement tracker : l√©g√®re attraction vers le joueur
      if (e.tracker) {
        const dx = this.player.x - e.x;
        e.x += dx * 0.01;
      }
      e.y += e.speed;

      // Collision (hitbox l√©g√®rement r√©duite pour fair-play)
      if (Math.hypot(this.player.x + 15 - (e.x + 12), this.player.y + 15 - (e.y + 12)) < 22) {
        this.stop();
        return;
      }
      if (e.y > this.canvas.height) {
        this.enemies.splice(i, 1);
        this.score += 10;
      }
    }

    document.getElementById('ui-score').innerText = this.score;
  },

  draw() {
    const ctx = this.ctx;
    ctx.fillStyle = '#050505';
    ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

    // Grille de fond subtile
    ctx.strokeStyle = 'rgba(0,243,255,0.03)';
    ctx.lineWidth = 1;
    for (let x = 0; x < this.canvas.width; x += 60) {
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, this.canvas.height); ctx.stroke();
    }

    // Joueur
    ctx.shadowBlur = 20;
    ctx.shadowColor = this.player.color;
    ctx.fillStyle = this.player.color;
    ctx.fillRect(this.player.x, this.player.y, 30, 30);

    // Ennemis
    this.enemies.forEach(e => {
      ctx.shadowColor = e.color;
      ctx.shadowBlur = 15;
      ctx.fillStyle = e.color;
      ctx.fillRect(e.x, e.y, 25, 25);
    });

    ctx.shadowBlur = 0;
  }
};

window.onload = () => Game.init();
</script>
</body>
</html>
