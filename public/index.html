<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>NEON DODGE</title>
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>

<!-- toasts -->
<div id="notif"></div>
<div id="ach-popup"><div class="ap-title">‚òÖ ACHIEVEMENT D√âBLOQU√â</div><div class="ap-name" id="ap-name"></div><div class="ap-desc" id="ap-desc"></div></div>
<div id="fps-el">00 FPS</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MENU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-menu" class="screen">
    <div id="user-tag">NON CONNECT√â</div>
    <h1 class="neon-title">NEON DODGE</h1>
    <p class="subtitle">PRO NETWORK</p>
    <div class="menu-grid">
        <button class="btn"          onclick="Game.start()">‚ñ∂ JOUER</button>
        <button class="btn btn-blue" onclick="UI.show('layer-shop')">BOUTIQUE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-lead')">CLASSEMENT</button>
        <button class="btn btn-blue" id="btn-auth" onclick="UI.gotoAuth()">CONNEXION</button>
    </div>
    <div id="daily-preview" style="margin-top:14px"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-auth" class="screen" style="display:none">
    <h2 class="sc-title">ACC√àS R√âSEAU</h2>
    <div class="auth-tabs">
        <div class="auth-tab active" id="tab-login"    onclick="Auth.tab('login')">CONNEXION</div>
        <div class="auth-tab"        id="tab-register" onclick="Auth.tab('register')">INSCRIPTION</div>
    </div>

    <div id="form-login" class="auth-form">
        <input type="text"     id="l-user" placeholder="Pseudo" autocomplete="username">
        <input type="password" id="l-pass" placeholder="Mot de passe" autocomplete="current-password"
               onkeydown="if(event.key==='Enter') Auth.login()">
        <button class="btn btn-full" id="btn-login" onclick="Auth.login()">SE CONNECTER</button>
    </div>

    <div id="form-register" class="auth-form" style="display:none">
        <input type="text"     id="r-user"    placeholder="Pseudo (3-16 car.)" autocomplete="username">
        <input type="password" id="r-pass"    placeholder="Mot de passe (4 min)" autocomplete="new-password">
        <input type="password" id="r-confirm" placeholder="Confirmer" autocomplete="new-password"
               onkeydown="if(event.key==='Enter') Auth.register()">
        <button class="btn btn-green btn-full" id="btn-register" onclick="Auth.register()">CR√âER MON COMPTE</button>
    </div>

    <button class="btn btn-red btn-full btn-sm" onclick="UI.show('layer-menu')">‚Üê RETOUR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFIL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-profile" class="screen" style="display:none">
    <h2 class="sc-title">MON PROFIL</h2>
    <div id="prof-rank" class="rank-label" style="margin-bottom:3px"></div>
    <div class="rank-bar-wrap"><div class="rank-bar" id="prof-bar"></div></div>
    <div style="font-size:.44rem;color:rgba(255,255,255,.28);text-align:right;width:min(275px,88vw);margin-bottom:5px" id="prof-xp"></div>
    <div class="stats-block" id="prof-stats"></div>
    <div id="prof-daily" style="margin:5px 0"></div>
    <div style="display:flex;gap:8px;margin-top:4px">
        <button class="btn btn-sm btn-violet" onclick="UI.show('layer-ach')">ACHIEVEMENTS</button>
        <button class="btn btn-sm btn-red"    onclick="Auth.logout()">D√âCONNEXION</button>
    </div>
    <button class="btn btn-red btn-full btn-sm" onclick="UI.show('layer-menu')" style="margin-top:6px">‚Üê RETOUR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACHIEVEMENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-ach" class="screen" style="display:none">
    <h2 class="sc-title">ACHIEVEMENTS</h2>
    <div class="ach-grid" id="ach-grid"></div>
    <button class="btn btn-red btn-full btn-sm" onclick="UI.show('layer-profile')" style="margin-top:10px">‚Üê RETOUR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOUTIQUE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-shop" class="screen" style="display:none">
    <h2 class="sc-title">BOUTIQUE DE SKINS</h2>
    <p style="font-size:.58rem;color:rgba(255,255,255,.38);margin:0 0 6px">
        CR√âDITS : <span id="shop-cr" style="color:var(--neon)">0</span>
    </p>
    <div id="skin-list"></div>
    <button class="btn btn-red btn-full btn-sm" onclick="UI.show('layer-menu')" style="margin-top:10px">‚Üê RETOUR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEADERBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-lead" class="screen" style="display:none">
    <h2 class="sc-title">TOP JOUEURS MONDIAUX</h2>
    <div id="lead-list"></div>
    <button class="btn btn-red btn-full btn-sm" onclick="UI.show('layer-menu')" style="margin-top:10px">‚Üê RETOUR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JEU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-game" style="display:none;position:absolute;width:100%;height:100%">
    <canvas id="gameCanvas"></canvas>
    <div id="hud">
        <div class="hud-l">
            <div class="hud-lbl">SCORE</div>
            <div class="hud-val" id="ui-score">0</div>
            <div class="hud-hi">HI: <span id="ui-hi">0</span></div>
        </div>
        <div class="hud-r">
            <div class="hud-lbl">NIVEAU</div>
            <div class="hud-lvl" id="ui-lvl">S√âCURIT√â</div>
            <div class="hud-next" id="ui-next-wrap">‚Üí <span id="ui-next">100</span></div>
        </div>
    </div>
    <div id="combo-hud"><div class="combo-num" id="combo-num">x2</div><div class="combo-lbl">COMBO</div></div>
    <div id="pu-hud"></div>
    <div id="god-badge">‚ö° GOD MODE</div>
    <div id="level-bar-wrap"><div id="level-bar"></div></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê √âCRAN DE MORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-death" style="display:none;position:absolute;inset:0;z-index:20;
     flex-direction:column;justify-content:center;align-items:center;gap:7px;background:rgba(0,0,0,.88)">
    <div class="death-title">GAME OVER</div>
    <div class="death-score">SCORE : <span id="d-score">0</span></div>
    <div class="death-new" id="d-new" style="display:none">‚òÖ NOUVEAU RECORD !</div>
    <div class="death-sub">MEILLEUR : <span id="d-hi">0</span></div>
    <div class="death-rewards">
        <div><div class="d-rew-val" id="d-cr"  style="color:var(--orange)">+0</div><div class="d-rew-lbl">CR√âDITS</div></div>
        <div><div class="d-rew-val" id="d-xp"  style="color:var(--violet)">+0</div><div class="d-rew-lbl">XP</div></div>
        <div><div class="d-rew-val" id="d-cmb" style="color:var(--neon)">x1</div><div class="d-rew-lbl">MAX COMBO</div></div>
    </div>
    <div class="death-daily" id="d-daily"></div>
    <div class="death-btns">
        <button class="btn"          onclick="Game.start()">‚Ü∫ REJOUER</button>
        <button class="btn btn-red"  onclick="UI.show('layer-menu')">MENU</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEV CONSOLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="dev-tab" onclick="Dev.toggle()">‚öô DEV</div>
<div id="dev-panel">
    <div class="dev-header">
        <span class="dev-htitle">‚öô CONSOLE D√âVELOPPEUR</span>
        <button class="dev-hclose" onclick="Dev.toggle()">‚úï</button>
    </div>
    <div id="dev-log"></div>
    <div class="dev-shorts">
        <span class="ds" onclick="Dev.run('god')">GOD</span>
        <span class="ds" onclick="Dev.run('hitbox')">HITBOX</span>
        <span class="ds" onclick="Dev.run('fps')">FPS</span>
        <span class="ds" onclick="Dev.run('slow')">SLOW</span>
        <span class="ds" onclick="Dev.run('credits 500')">+500 CR</span>
        <span class="ds" onclick="Dev.run('xp 300')">+300 XP</span>
        <span class="ds" onclick="Dev.run('score 1000')">SCORE 1K</span>
        <span class="ds" onclick="Dev.run('level 3')">MAX LVL</span>
        <span class="ds" onclick="Dev.run('spawn 15')">SPAWN 15</span>
        <span class="ds" onclick="Dev.run('shield')">SHIELD</span>
        <span class="ds" onclick="Dev.run('unlockall')">UNLOCK ALL</span>
        <span class="ds" onclick="Dev.run('daily')">DAILY ‚úì</span>
        <span class="ds" onclick="Dev.run('stats')">STATS</span>
        <span class="ds" onclick="Dev.run('accounts')">COMPTES</span>
        <span class="ds" onclick="Dev.run('matrix')">MATRIX</span>
        <span class="ds" onclick="Dev.run('help')">HELP</span>
        <span class="ds" onclick="Dev.run('clear')">CLEAR</span>
        <span class="ds danger" onclick="Dev.run('kill')">KILL</span>
        <span class="ds danger" onclick="Dev.run('reset')">RESET</span>
    </div>
    <div class="dev-cmd">
        <span class="dev-prompt">&gt;</span>
        <input id="dev-input" type="text" placeholder="commande..." autocomplete="off"
               onkeydown="Dev.key(event)">
        <button class="dev-send" onclick="Dev.send()">‚Üµ</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCRIPTS
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script src="levels.js"></script>
<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SKINS = [
    { id:'neon_blue', name:'Neon Blue', color:'#00f3ff', price:0    },
    { id:'emerald',   name:'Emerald',   color:'#00ff88', price:500  },
    { id:'ruby',      name:'Ruby',      color:'#ff3838', price:1500 },
    { id:'gold',      name:'Gold',      color:'#ffd700', price:3000 },
    { id:'violet',    name:'Violet',    color:'#cc66ff', price:5000 },
    { id:'phantom',   name:'Phantom',   color:'#ffffff', price:8000 }
];

const ACHIEVEMENTS = [
    { id:'first_death',  label:'Bapt√™me du Feu',    desc:'Mourir une premi√®re fois',          xp:50  },
    { id:'score_100',    label:'D√©butant',           desc:'Atteindre 100 points',              xp:50  },
    { id:'score_500',    label:'Pilote Confirm√©',    desc:'Atteindre 500 points',              xp:100 },
    { id:'score_2000',   label:'V√©t√©ran',            desc:'Atteindre 2000 points',             xp:200 },
    { id:'score_5000',   label:'L√©gende',            desc:'Atteindre 5000 points',             xp:500 },
    { id:'combo_5',      label:'En Rythme',          desc:'Combo x5 en une partie',            xp:75  },
    { id:'combo_10',     label:'Machine de Guerre',  desc:'Combo x10 en une partie',           xp:150 },
    { id:'pu_used',      label:'√âquip√© !',           desc:'Ramasser un power-up',              xp:40  },
    { id:'shield_break', label:'Bouclier Bris√©',     desc:'Bouclier absorb√© un coup',          xp:75  },
    { id:'ten_games',    label:'Assidu',             desc:'Jouer 10 parties',                  xp:100 },
    { id:'survive_60',   label:'Survivant',          desc:'Survivre 60 secondes',              xp:150 },
    { id:'daily_done',   label:'Disciplin√©',         desc:'Compl√©ter une mission journali√®re', xp:100 },
    { id:'frontier',     label:'Franchir la Ligne',  desc:'Atteindre FRONTI√àRE',               xp:75  },
    { id:'red_zone',     label:'Dans le Rouge',      desc:'Atteindre ZONE ROUGE',              xp:150 },
    { id:'singularity',  label:'Point Om√©ga',        desc:'Atteindre SINGULARIT√â',             xp:300 },
    { id:'rich',         label:'Investisseur',       desc:'Avoir 1000 cr√©dits',                xp:100 }
];

const RANKS = [
    { min:0,     label:'RECRUE',      color:'#888'    },
    { min:200,   label:'AGENT',       color:'#00f3ff' },
    { min:600,   label:'OP√âRATEUR',  color:'#00ff88' },
    { min:1500,  label:'SP√âCIALISTE', color:'#ffaa00' },
    { min:4000,  label:'FANT√îME',     color:'#cc66ff' },
    { min:9000,  label:'L√âGENDE',     color:'#ff3838' }
];

const PU_TYPES = {
    shield:  { color:'#ffd700', label:'S', desc:'BOUCLIER' },
    slow:    { color:'#0088ff', label:'T', desc:'SLOW 5s'  },
    credits: { color:'#00ff88', label:'$', desc:'+150 CR'  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE ‚Äî session data (in memory, synced with server)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let S = null;       // account data object
let TOKEN = null;   // auth token

// Guest defaults
function guestState() {
    return {
        username:    'Pilote',
        credits:     0,
        highScore:   0,
        totalTime:   0,
        deathCount:  0,
        gamesPlayed: 0,
        xp:          0,
        ownedSkins:  ['neon_blue'],
        equippedSkin:'neon_blue',
        achievements:{},
        daily:       null
    };
}

function isLogged() { return TOKEN !== null; }

function getRank(xp) {
    for (let i = RANKS.length - 1; i >= 0; i--) {
        if (xp >= RANKS[i].min) return RANKS[i];
    }
    return RANKS[0];
}
function getNextRank(xp) {
    return RANKS.find(r => r.min > xp) || null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  API CLIENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API = {
    async call(method, path, body) {
        try {
            const opts = { method, headers:{'Content-Type':'application/json'} };
            if (body) opts.body = JSON.stringify(body);
            const r = await fetch(path, opts);
            return await r.json();
        } catch(e) {
            Dev.log('e', 'API error: ' + e.message);
            return { ok:false, error:'Erreur r√©seau' };
        }
    },
    register: (u,p)   => API.call('POST', '/api/register', { username:u, password:p }),
    login:    (u,p)   => API.call('POST', '/api/login',    { username:u, password:p }),
    save:     (data)  => TOKEN ? API.call('POST', '/api/save',  { token:TOKEN, data }) : Promise.resolve({ ok:true }),
    score:    (s,c)   => TOKEN ? API.call('POST', '/api/score', { token:TOKEN, score:s, combo:c }) : Promise.resolve({ ok:true }),
    leaderboard:()    => API.call('GET',  '/api/leaderboard'),
    logout:   ()      => TOKEN ? API.call('POST', '/api/logout', { token:TOKEN }) : Promise.resolve({ ok:true })
};

// Debounced save (avoid hammering server)
let _saveTimer = null;
function scheduleSave() {
    clearTimeout(_saveTimer);
    _saveTimer = setTimeout(() => {
        if (isLogged() && S) {
            API.save(S).then(r => {
                if (!r.ok) Dev.log('w', 'Save √©chou√©: ' + (r.error||'?'));
            });
        }
    }, 1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _nt, _at;
function notify(msg, type='neon') {
    const el = document.getElementById('notif');
    const c  = { neon:'var(--neon)', red:'var(--pink)', orange:'var(--orange)', green:'var(--green)' };
    el.innerText = msg;
    el.style.borderColor = c[type] || c.neon;
    el.style.color       = c[type] || c.neon;
    el.style.display     = 'block';
    clearTimeout(_nt);
    _nt = setTimeout(() => el.style.display = 'none', 2800);
}

function achPopup(def) {
    document.getElementById('ap-name').innerText = def.label;
    document.getElementById('ap-desc').innerText = def.desc;
    const el = document.getElementById('ach-popup');
    el.style.display = 'block';
    el.style.animation = 'none';
    void el.offsetWidth;
    el.style.animation = '';
    clearTimeout(_at);
    _at = setTimeout(() => el.style.display = 'none', 3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACHIEVEMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkAch(id) {
    if (!S || S.achievements[id]) return;
    S.achievements[id] = true;
    const def = ACHIEVEMENTS.find(a => a.id === id);
    if (def) {
        S.xp = (S.xp || 0) + def.xp;
        achPopup(def);
        notify('üèÜ ' + def.label, 'orange');
        Dev.log('s', 'üèÜ ' + def.label + ' (+' + def.xp + ' XP)');
        scheduleSave();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Auth = {
    tab(t) {
        const isL = t === 'login';
        document.getElementById('tab-login').classList.toggle('active', isL);
        document.getElementById('tab-register').classList.toggle('active', !isL);
        document.getElementById('form-login').style.display    = isL ? 'flex' : 'none';
        document.getElementById('form-register').style.display = isL ? 'none' : 'flex';
    },

    async login() {
        const u = document.getElementById('l-user').value.trim();
        const p = document.getElementById('l-pass').value;
        if (!u) return notify('Entrez votre pseudo', 'red');
        if (!p) return notify('Entrez votre mot de passe', 'red');
        const btn = document.getElementById('btn-login');
        btn.textContent = '...'; btn.disabled = true;

        const r = await API.login(u, p);
        btn.textContent = 'SE CONNECTER'; btn.disabled = false;

        if (!r.ok) { notify(r.error || 'Erreur connexion', 'red'); return; }
        this._setSession(r.token, r.account);
        Dev.log('s', 'Connexion : ' + r.account.username);
    },

    async register() {
        const u = document.getElementById('r-user').value.trim();
        const p = document.getElementById('r-pass').value;
        const c = document.getElementById('r-confirm').value;
        if (!u) return notify('Entrez un pseudo', 'red');
        if (!p) return notify('Entrez un mot de passe', 'red');
        if (p !== c) return notify('Les mots de passe ne correspondent pas', 'red');
        const btn = document.getElementById('btn-register');
        btn.textContent = '...'; btn.disabled = true;

        const r = await API.register(u, p);
        btn.textContent = 'CR√âER MON COMPTE'; btn.disabled = false;

        if (!r.ok) { notify(r.error || 'Erreur inscription', 'red'); return; }
        this._setSession(r.token, r.account);
        Dev.log('s', 'Nouveau compte : ' + r.account.username);
        notify('Compte cr√©√© ! Bienvenue ' + r.account.username, 'green');
    },

    _setSession(token, account) {
        TOKEN = token;
        S     = account;
        if (!S.achievements) S.achievements = {};
        if (!S.ownedSkins)   S.ownedSkins   = ['neon_blue'];
        // Restore skin color
        const skin = SKINS.find(sk => sk.id === S.equippedSkin) || SKINS[0];
        Game.player.color = skin.color;
        // Update UI
        document.getElementById('user-tag').innerText = '‚óè ' + S.username.toUpperCase();
        document.getElementById('btn-auth').textContent = 'MON PROFIL';
        document.getElementById('btn-auth').onclick = () => UI.show('layer-profile');
        notify('Connect√© : ' + S.username);
        UI.show('layer-menu');
    },

    async logout() {
        await API.logout();
        TOKEN = null;
        S     = guestState();
        Game.player.color = '#00f3ff';
        document.getElementById('user-tag').innerText = 'NON CONNECT√â';
        document.getElementById('btn-auth').textContent = 'CONNEXION';
        document.getElementById('btn-auth').onclick = () => UI.gotoAuth();
        notify('D√©connect√©');
        Dev.log('i', 'D√©connexion');
        UI.show('layer-menu');
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const UI = {
    show(id) {
        document.querySelectorAll('.screen').forEach(el => el.style.display = 'none');
        document.getElementById('layer-death').style.display = 'none';
        document.getElementById('layer-game').style.display  = 'none';
        const el = document.getElementById(id);
        if (el) el.style.display = 'flex';

        const actions = {
            'layer-menu':    () => this._menuRefresh(),
            'layer-shop':    () => this._shop(),
            'layer-lead':    () => this._leaderboard(),
            'layer-profile': () => this._profile(),
            'layer-ach':     () => this._achievements()
        };
        if (actions[id]) actions[id]();
    },

    gotoAuth() {
        if (isLogged()) this.show('layer-profile');
        else            this.show('layer-auth');
    },

    _menuRefresh() {
        if (!S) return;
        const d = S.daily;
        const el = document.getElementById('daily-preview');
        if (!d || !d.mission) { el.innerHTML = ''; return; }
        const pct = Math.min((d.progress || 0) / d.mission.target * 100, 100);
        el.innerHTML = `
        <div class="daily-card">
            <div class="daily-title">üéØ MISSION DU JOUR</div>
            <div class="daily-desc">${d.mission.desc}</div>
            ${d.completed
                ? '<div class="daily-done">‚úì COMPL√âT√âE !</div>'
                : `<div class="daily-prog-wrap"><div class="daily-prog" style="width:${pct}%"></div></div>
                   <div class="daily-prog-text">${d.progress||0} / ${d.mission.target}</div>`}
            <div class="daily-reward">R√©compense : +${d.mission.reward} cr√©dits</div>
        </div>`;
    },

    _shop() {
        if (!S) return;
        document.getElementById('shop-cr').innerText = S.credits || 0;
        const list = document.getElementById('skin-list');
        list.innerHTML = '';
        SKINS.forEach(sk => {
            const owned    = (S.ownedSkins || []).includes(sk.id);
            const equipped = S.equippedSkin === sk.id;
            const btn = document.createElement('button');
            btn.className = 'btn-skin';
            btn.style.borderColor = equipped ? sk.color + '99' : 'rgba(255,255,255,.1)';
            let badge;
            if (equipped)   badge = '<span class="skin-badge badge-equipped">√âQUIP√â</span>';
            else if (owned) badge = '<span class="skin-badge badge-owned">ACHET√â</span>';
            else            badge = `<span class="skin-badge badge-price">‚óà ${sk.price}</span>`;
            btn.innerHTML = `
                <span style="display:flex;align-items:center;gap:8px">
                    <span class="skin-dot" style="background:${sk.color};box-shadow:0 0 8px ${sk.color}"></span>
                    ${sk.name.toUpperCase()}
                </span>${badge}`;
            btn.onclick = () => {
                if (equipped) return;
                if (owned || sk.price === 0) {
                    S.equippedSkin = sk.id;
                    Game.player.color = sk.color;
                    scheduleSave();
                    notify('Skin √©quip√© : ' + sk.name);
                } else if ((S.credits||0) >= sk.price) {
                    S.credits -= sk.price;
                    if (!S.ownedSkins.includes(sk.id)) S.ownedSkins.push(sk.id);
                    S.equippedSkin = sk.id;
                    Game.player.color = sk.color;
                    scheduleSave();
                    notify('Skin achet√© : ' + sk.name);
                    Dev.log('s', `Skin achet√© : ${sk.name} (-${sk.price} cr.)`);
                    if ((S.credits||0) >= 1000) checkAch('rich');
                } else {
                    notify('Pas assez de cr√©dits (besoin : ' + sk.price + ')', 'red');
                }
                this._shop();
            };
            list.appendChild(btn);
        });
    },

    async _leaderboard() {
        const el = document.getElementById('lead-list');
        el.innerHTML = '<div class="lead-empty">Chargement...</div>';
        const r = await API.leaderboard();
        if (!r.ok || !r.scores || !r.scores.length) {
            el.innerHTML = '<div class="lead-empty">AUCUN SCORE ENREGISTR√â</div>';
            return;
        }
        const medals = ['gold','silver','bronze'];
        el.innerHTML = r.scores.map((s, i) => `
            <div class="lead-row">
                <div class="lead-rank ${medals[i]||''}">#${i+1}</div>
                <div class="lead-name">${s.username}</div>
                <div class="lead-score">${s.score} pts</div>
                <div class="lead-date">${s.date}</div>
            </div>`).join('');
    },

    _profile() {
        if (!S) return;
        const xp   = S.xp || 0;
        const rank = getRank(xp);
        const next = getNextRank(xp);
        document.getElementById('prof-rank').innerText = rank.label;
        document.getElementById('prof-rank').style.color = rank.color;
        const pct = next ? Math.min((xp - rank.min) / (next.min - rank.min) * 100, 100) : 100;
        document.getElementById('prof-bar').style.width      = pct + '%';
        document.getElementById('prof-bar').style.background = rank.color;
        document.getElementById('prof-xp').innerText = next
            ? `${xp} XP ‚Üí ${next.label} : ${next.min} XP`
            : `${xp} XP ‚Äî RANG MAXIMUM`;
        const achDone = Object.keys(S.achievements || {}).length;
        document.getElementById('prof-stats').innerHTML = `
            <div class="stat-item"><div class="stat-val">${S.highScore||0}</div><div class="stat-lbl">MEILLEUR</div></div>
            <div class="stat-item"><div class="stat-val">${S.credits||0}</div><div class="stat-lbl">CR√âDITS</div></div>
            <div class="stat-item"><div class="stat-val">${S.deathCount||0}</div><div class="stat-lbl">MORTS</div></div>
            <div class="stat-item"><div class="stat-val">${S.gamesPlayed||0}</div><div class="stat-lbl">PARTIES</div></div>
            <div class="stat-item"><div class="stat-val" style="font-size:.75rem">${fmtTime(S.totalTime||0)}</div><div class="stat-lbl">TEMPS</div></div>
            <div class="stat-item"><div class="stat-val">${achDone}/${ACHIEVEMENTS.length}</div><div class="stat-lbl">ACHIEVEMENTS</div></div>`;
        const d = S.daily;
        const pd = document.getElementById('prof-daily');
        if (d && d.mission) {
            const pct2 = Math.min((d.progress||0) / d.mission.target * 100, 100);
            pd.innerHTML = `
            <div class="daily-card">
                <div class="daily-title">üéØ MISSION DU JOUR</div>
                <div class="daily-desc">${d.mission.desc}</div>
                ${d.completed
                    ? '<div class="daily-done">‚úì COMPL√âT√âE !</div>'
                    : `<div class="daily-prog-wrap"><div class="daily-prog" style="width:${pct2}%"></div></div>
                       <div class="daily-prog-text">${d.progress||0} / ${d.mission.target}</div>`}
                <div class="daily-reward">R√©compense : +${d.mission.reward} cr√©dits</div>
            </div>`;
        } else pd.innerHTML = '';
    },

    _achievements() {
        if (!S) return;
        document.getElementById('ach-grid').innerHTML = ACHIEVEMENTS.map(a => {
            const done = !!(S.achievements||{})[a.id];
            return `<div class="ach-item ${done?'unlocked':''}">
                <div class="ach-icon">${done?'‚ú¶':'‚óã'}</div>
                <div class="ach-name">${a.label}</div>
                <div class="ach-desc">${a.desc}</div>
                <div class="ach-xp">${done?'+'+a.xp+' XP':'?? XP'}</div>
            </div>`;
        }).join('');
    }
};

function fmtTime(t) {
    return Math.floor(t/3600)+'h '+Math.floor((t%3600)/60)+'m '+(t%60)+'s';
}

// Daily progress helper
function dailyProgress(type, value) {
    if (!S || !S.daily || !S.daily.mission || S.daily.completed) return;
    const d = S.daily;
    if (d.mission.type !== type) return;
    if (type === 'score' || type === 'survive' || type === 'combo') {
        if (value > (d.progress||0)) d.progress = value;
    } else {
        d.progress = (d.progress||0) + value;
    }
    if (d.progress >= d.mission.target) {
        d.completed = true;
        S.credits = (S.credits||0) + d.mission.reward;
        checkAch('daily_done');
        notify('üéØ Mission compl√©t√©e ! +' + d.mission.reward + ' cr√©dits', 'orange');
        Dev.log('s', 'Mission journali√®re compl√©t√©e !');
        scheduleSave();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PARTICLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Particles = {
    list: [],
    spawn(x, y, color, n=16) {
        for (let i = 0; i < n; i++) {
            const a = Math.random() * Math.PI * 2;
            const s = 1 + Math.random() * 5;
            this.list.push({ x, y, vx:Math.cos(a)*s, vy:Math.sin(a)*s-1,
                life:1, decay:.02+Math.random()*.03, size:2+Math.random()*4, color });
        }
    },
    update() {
        for (let i = this.list.length-1; i >= 0; i--) {
            const p = this.list[i];
            p.x += p.vx; p.y += p.vy; p.vy += .12; p.life -= p.decay;
            if (p.life <= 0) this.list.splice(i,1);
        }
    },
    draw(ctx) {
        this.list.forEach(p => {
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.shadowBlur = 5; ctx.shadowColor = p.color;
            ctx.fillRect(p.x, p.y, p.size, p.size);
        });
        ctx.globalAlpha = 1; ctx.shadowBlur = 0;
    }
};

// Matrix FX
const Matrix = {
    cols: [],
    init(w) { this.cols = Array.from({length:Math.floor(w/16)},()=>({y:Math.random()*-100,sp:1+Math.random()*2})); },
    draw(ctx, h) {
        ctx.fillStyle = 'rgba(0,255,70,.11)';
        ctx.font = '12px monospace';
        this.cols.forEach((c,i) => {
            ctx.fillText(String.fromCharCode(0x30A0+Math.random()*96), i*16, c.y);
            c.y += c.sp*14;
            if (c.y > h) c.y = -20;
        });
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Game = {
    canvas:  null, ctx: null,
    running: false, score: 0,

    // flags
    _god:         false,
    _hitbox:      false,
    _fps:         false,
    _slowDev:     false,
    _matrix:      false,
    _forceLvl:    null,

    // objects
    player:   { x:0, y:0, size:28, color:'#00f3ff' },
    enemies:  [],
    powerups: [],

    // gameplay
    combo:        0,
    maxCombo:     0,
    _lastDodge:   0,
    _comboReset:  3000, // ms with no dodge before reset
    shield:       false,
    slowActive:   false,
    _slowTimer:   null,

    // tracking
    _timeAcc:     0,
    _surviveMs:   0,
    _lastTs:      0,
    _fpsBuf:      [],
    _puCount:     0,
    _prevLvlIdx:  -1,

    init() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx    = this.canvas.getContext('2d');
        this.resize();
        S = guestState();
        Matrix.init(this.canvas.width);

        window.addEventListener('resize', () => this.resize());

        window.addEventListener('mousemove', e => {
            if (this.running) this.player.x = e.clientX - this.player.size/2;
        });
        window.addEventListener('touchmove', e => {
            if (this.running) { e.preventDefault(); this.player.x = e.touches[0].clientX - this.player.size/2; }
        }, { passive:false });

        window.addEventListener('keydown', e => {
            if (e.shiftKey && e.key === 'D') Dev.toggle();
        });

        Dev.init();
        Dev.log('x', 'NEON DODGE v3 ‚Äî Shift+D = console dev');
    },

    resize() {
        if (!this.canvas) return;
        this.canvas.width  = window.innerWidth;
        this.canvas.height = window.innerHeight;
        if (this.running) this.player.y = this.canvas.height - 80;
        Matrix.init(this.canvas.width);
    },

    start() {
        if (!S) S = guestState();
        this.running = true; this.score = 0;
        this.enemies = []; this.powerups = [];
        Particles.list = [];
        this.combo = 0; this.maxCombo = 0; this._lastDodge = 0;
        this.shield = false; this.slowActive = false;
        this._timeAcc = 0; this._surviveMs = 0;
        this._puCount = 0; this._prevLvlIdx = -1;
        clearTimeout(this._slowTimer);

        // IMPORTANT: forcer les bonnes dimensions du canvas avant tout
        this.canvas.width  = window.innerWidth;
        this.canvas.height = window.innerHeight;

        this.player.x = this.canvas.width  / 2 - this.player.size / 2;
        this.player.y = this.canvas.height - 80;

        document.querySelectorAll('.screen').forEach(el => el.style.display = 'none');
        document.getElementById('layer-death').style.display = 'none';
        document.getElementById('layer-game').style.display  = 'block';
        document.getElementById('ui-hi').innerText = S.highScore || 0;
        document.getElementById('combo-hud').style.display = 'none';
        document.getElementById('pu-hud').style.display    = 'none';
        document.getElementById('god-badge').style.display = this._god ? 'block' : 'none';

        this._lastTs = performance.now();
        Dev.log('g', `Partie d√©marr√©e ‚Äî ${S.username} | skin: ${S.equippedSkin}`);
        requestAnimationFrame(ts => this.loop(ts));
    },

    loop(ts) {
        if (!this.running) return;

        const rawMs = ts - this._lastTs;
        this._lastTs = ts;
        const clampedMs = Math.min(rawMs, 50); // cap at 50ms (20fps min)

        // FPS
        this._fpsBuf.push(1000 / rawMs);
        if (this._fpsBuf.length > 30) this._fpsBuf.shift();
        if (this._fps) {
            const avg = this._fpsBuf.reduce((a,b) => a+b, 0) / this._fpsBuf.length;
            document.getElementById('fps-el').innerText = Math.round(avg) + ' FPS';
        }

        const mult  = (this._slowDev || this.slowActive) ? 0.3 : 1;
        const dtMs  = clampedMs * mult;

        this._timeAcc   += dtMs;
        this._surviveMs += dtMs;

        // Increment totalTime every second
        while (this._timeAcc >= 1000) {
            if (S) S.totalTime = (S.totalTime||0) + 1;
            this._timeAcc -= 1000;
        }

        // Combo timeout: reset if too long since last dodge
        if (this.combo > 0 && (ts - this._lastDodge) > this._comboReset) {
            this.combo = 0;
            document.getElementById('combo-hud').style.display = 'none';
        }

        this.update(dtMs);
        this.draw();
        requestAnimationFrame(ts2 => this.loop(ts2));
    },

    update(dtMs) {
        const dtFrames = dtMs / (1000/60); // 1.0 at 60fps
        const lvlIdx = this._forceLvl !== null
            ? Math.max(0, Math.min(3, this._forceLvl))
            : LevelSystem.getLevelIndex(this.score);
        const lvl = LevelSystem.levels[lvlIdx];

        // Level up notification
        if (lvlIdx > this._prevLvlIdx && this._prevLvlIdx >= 0) {
            Dev.log('w', '‚ö° Niveau : ' + lvl.name);
            notify('‚ö° ' + lvl.name, 'orange');
        }
        this._prevLvlIdx = lvlIdx;

        // Spawn enemies
        if (Math.random() < lvl.rate * dtFrames) {
            const tracker = lvl.tracker && Math.random() < lvl.trackerRatio;
            this.enemies.push({
                x:       Math.random() * (this.canvas.width - 25),
                y:       -55,
                speed:   lvl.speed,
                tracker,
                color:   tracker ? '#ff9900' : '#ff3838'
            });
        }

        // Spawn power-ups
        if (Math.random() < 0.004 * dtFrames) {
            const types = Object.keys(PU_TYPES);
            this.powerups.push({
                x:     Math.random() * (this.canvas.width - 26),
                y:     -35,
                type:  types[Math.floor(Math.random() * types.length)],
                speed: 2
            });
        }

        const ps = this.player.size;

        // Update + collide enemies
        for (let i = this.enemies.length - 1; i >= 0; i--) {
            const e = this.enemies[i];

            // Tracker homing
            if (e.tracker) {
                const dx = (this.player.x + ps/2) - (e.x + 12.5);
                const dy = (this.player.y + ps/2) - (e.y + 12.5);
                const dist = Math.hypot(dx, dy) || 1;
                e.x += (dx/dist) * lvl.speed * 0.16 * dtFrames;
            }

            e.y += e.speed * dtFrames;

            // Collision (AABB, slightly inset for fairness)
            const inset = 3;
            const hit =
                !this._god &&
                this.player.x + inset    < e.x + 22 &&
                this.player.x + ps - inset > e.x &&
                this.player.y + inset    < e.y + 22 &&
                this.player.y + ps - inset > e.y;

            if (hit) {
                if (this.shield) {
                    this.shield = false;
                    this.enemies.splice(i, 1);
                    Particles.spawn(e.x+12, e.y+12, '#ffd700', 20);
                    checkAch('shield_break');
                    document.getElementById('pu-hud').style.display = 'none';
                    notify('BOUCLIER BRIS√â !', 'orange');
                    Dev.log('w', 'Bouclier absorb√© un coup');
                    continue;
                }
                Particles.spawn(e.x+12, e.y+12, e.color, 10);
                this.stop();
                return;
            }

            // Enemy passed ‚Äî score + combo
            if (e.y > this.canvas.height + 55) {
                this.enemies.splice(i, 1);
                const mult = this.combo >= 10 ? 3 : this.combo >= 5 ? 2 : 1;
                this.score += 10 * mult;
                this.combo++;
                this._lastDodge = performance.now();
                if (this.combo > this.maxCombo) this.maxCombo = this.combo;

                dailyProgress('combo', this.combo);

                // Combo HUD
                if (this.combo >= 3) {
                    const ch = document.getElementById('combo-hud');
                    ch.style.display = 'block';
                    ch.style.animation = 'none'; void ch.offsetWidth; ch.style.animation = '';
                    document.getElementById('combo-num').innerText = 'x' + mult;
                }
            }
        }

        // Update power-ups
        for (let i = this.powerups.length - 1; i >= 0; i--) {
            const pu = this.powerups[i];
            pu.y += pu.speed * dtFrames;

            const hit =
                this.player.x        < pu.x + 24 &&
                this.player.x + ps   > pu.x &&
                this.player.y        < pu.y + 24 &&
                this.player.y + ps   > pu.y;

            if (hit) {
                this._activatePU(pu.type);
                Particles.spawn(pu.x+12, pu.y+12, PU_TYPES[pu.type].color, 14);
                this.powerups.splice(i, 1);
                this._puCount++;
                dailyProgress('powerups', 1);
                checkAch('pu_used');
                continue;
            }
            if (pu.y > this.canvas.height + 40) this.powerups.splice(i, 1);
        }

        Particles.update();

        // ‚îÄ‚îÄ HUD ‚îÄ‚îÄ
        const safe = el => document.getElementById(el);
        safe('ui-score').innerText = this.score;

        const nw  = LevelSystem.getNextLevelScore(this.score);
        const lvlEl = safe('ui-lvl');
        if (lvlEl) { lvlEl.innerText = lvl.name; lvlEl.style.color = lvl.color; }
        const nwEl = safe('ui-next-wrap');
        if (nwEl) nwEl.style.display = nw !== null ? '' : 'none';
        if (nw !== null) { safe('ui-next').innerText = nw; }
        const bar = safe('level-bar');
        if (bar) {
            const pct = nw !== null
                ? Math.min((this.score - lvl.scoreReq) / (nw - lvl.scoreReq) * 100, 100)
                : 100;
            bar.style.width = pct + '%';
            bar.style.background = lvl.color;
        }

        // Daily survive
        dailyProgress('survive', Math.floor(this._surviveMs / 1000));
        dailyProgress('score', this.score);
    },

    _activatePU(type) {
        const info  = PU_TYPES[type];
        const puHud = document.getElementById('pu-hud');
        Dev.log('s', 'Power-up : ' + type);

        if (type === 'shield') {
            this.shield = true;
            puHud.style.display = 'block';
            puHud.innerText = 'üõ° BOUCLIER';
            puHud.style.color = info.color;
            notify('üõ° BOUCLIER !', 'orange');
        }
        if (type === 'slow') {
            this.slowActive = true;
            puHud.style.display = 'block';
            puHud.innerText = '‚è≥ SLOWMO 5s';
            puHud.style.color = info.color;
            notify('‚è≥ SLOWMO !', 'neon');
            clearTimeout(this._slowTimer);
            this._slowTimer = setTimeout(() => {
                this.slowActive = false;
                puHud.style.display = 'none';
                Dev.log('i', 'Slowmo termin√©');
            }, 5000);
        }
        if (type === 'credits') {
            if (S) { S.credits = (S.credits||0) + 150; scheduleSave(); }
            notify('üí∞ +150 CR√âDITS', 'green');
        }
    },

    async stop() {
        if (!this.running) return;
        this.running = false;

        Particles.spawn(this.player.x + this.player.size/2, this.player.y + this.player.size/2,
                        this.player.color, 35);
        this.draw(); // final frame

        if (!S) S = guestState();

        const isNew    = this.score > (S.highScore || 0);
        const credits  = Math.floor(this.score / 10) + (this.maxCombo >= 5 ? 50 : 0);
        const xpGain   = Math.floor(this.score / 5) + (this.maxCombo >= 3 ? 10 : 0);

        S.credits    = (S.credits||0)  + credits;
        S.xp         = (S.xp||0)       + xpGain;
        S.deathCount = (S.deathCount||0) + 1;
        S.gamesPlayed= (S.gamesPlayed||0) + 1;
        if (isNew) S.highScore = this.score;

        dailyProgress('deaths', 1);

        // Achievements
        checkAch('first_death');
        if (this.score >= 100)  checkAch('score_100');
        if (this.score >= 500)  checkAch('score_500');
        if (this.score >= 2000) checkAch('score_2000');
        if (this.score >= 5000) checkAch('score_5000');
        if (this.maxCombo >= 5)  checkAch('combo_5');
        if (this.maxCombo >= 10) checkAch('combo_10');
        if ((S.gamesPlayed||0) >= 10) checkAch('ten_games');
        if (this._surviveMs >= 60000)  checkAch('survive_60');
        const li = LevelSystem.getLevelIndex(this.score);
        if (li >= 1) checkAch('frontier');
        if (li >= 2) checkAch('red_zone');
        if (li >= 3) checkAch('singularity');
        if ((S.credits||0) >= 1000) checkAch('rich');

        // Save + submit score to server
        scheduleSave();
        API.score(this.score, this.maxCombo);

        // Death screen
        document.getElementById('d-score').innerText = this.score;
        document.getElementById('d-hi').innerText    = S.highScore;
        document.getElementById('d-new').style.display = isNew ? 'block' : 'none';
        document.getElementById('d-cr').innerText    = '+' + credits;
        document.getElementById('d-xp').innerText    = '+' + xpGain;
        document.getElementById('d-cmb').innerText   = 'x' + this.maxCombo;
        const dd = S.daily;
        document.getElementById('d-daily').innerText = dd && dd.completed && dd.date === new Date().toISOString().slice(0,10)
            ? 'üéØ Mission compl√©t√©e ! +' + dd.mission.reward + ' cr√©dits'
            : '';

        document.getElementById('layer-death').style.display = 'flex';

        Dev.log('e', `üíÄ Mort ‚Äî score:${this.score} | combo:${this.maxCombo} | survive:${Math.floor(this._surviveMs/1000)}s`);
        Dev.log('i', `  +${credits} cr. | +${xpGain} XP`);
    },

    draw() {
        const ctx = this.ctx;
        const W = this.canvas.width, H = this.canvas.height;

        ctx.fillStyle = '#050508';
        ctx.fillRect(0, 0, W, H);

        if (this._matrix) Matrix.draw(ctx, H);

        // Grid
        ctx.strokeStyle = 'rgba(0,243,255,.022)';
        ctx.lineWidth = 1;
        for (let x = 0; x < W; x += 60) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
        for (let y = 0; y < H; y += 60) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

        Particles.draw(ctx);

        // Power-ups
        ctx.textAlign = 'center';
        this.powerups.forEach(pu => {
            const info = PU_TYPES[pu.type];
            ctx.fillStyle   = info.color;
            ctx.shadowBlur  = 14; ctx.shadowColor = info.color;
            ctx.fillRect(pu.x, pu.y, 24, 24);
            ctx.shadowBlur  = 0;
            ctx.fillStyle   = '#000';
            ctx.font        = 'bold 13px Orbitron, sans-serif';
            ctx.fillText(info.label, pu.x+12, pu.y+17);
        });
        ctx.textAlign = 'left';

        // Enemies
        this.enemies.forEach(e => {
            ctx.fillStyle   = e.color;
            ctx.shadowBlur  = 12; ctx.shadowColor = e.color;
            ctx.fillRect(e.x, e.y, 25, 25);
            if (e.tracker) {
                ctx.shadowBlur = 0;
                ctx.strokeStyle = '#ff9900'; ctx.lineWidth = 1;
                ctx.strokeRect(e.x-2, e.y-2, 29, 29);
            }
            if (this._hitbox) {
                ctx.shadowBlur = 0;
                ctx.strokeStyle = 'rgba(255,255,0,.5)'; ctx.lineWidth = 1;
                const inset = 3;
                ctx.strokeRect(e.x+inset, e.y+inset, 22-inset*2, 22-inset*2);
            }
        });

        // Player
        const p = this.player;
        if (this.shield) {
            ctx.shadowBlur = 28; ctx.shadowColor = '#ffd700';
            ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 2;
            ctx.strokeRect(p.x-4, p.y-4, p.size+8, p.size+8);
        }
        ctx.fillStyle  = p.color;
        ctx.shadowBlur = 20; ctx.shadowColor = p.color;
        ctx.fillRect(p.x, p.y, p.size, p.size);
        ctx.fillStyle = 'rgba(255,255,255,.55)'; ctx.shadowBlur = 0;
        ctx.fillRect(p.x+6, p.y+6, 8, 8);

        if (this._hitbox) {
            const inset = 3;
            ctx.strokeStyle = 'rgba(0,255,0,.8)'; ctx.lineWidth = 1;
            ctx.strokeRect(p.x+inset, p.y+inset, p.size-inset*2, p.size-inset*2);
        }
        ctx.shadowBlur = 0;
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEV CONSOLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Dev = {
    _hist: [], _hi: -1,

    init() {
        this.log('x', 'Console pr√™te ‚Äî tapez "help" pour les commandes');
        const inp = document.getElementById('dev-input');
        inp.addEventListener('keydown', e => {
            if (e.key === 'ArrowUp')   { this._hi = Math.min(this._hi+1, this._hist.length-1); inp.value = this._hist[this._hist.length-1-this._hi]||''; e.preventDefault(); }
            if (e.key === 'ArrowDown') { this._hi = Math.max(this._hi-1, -1);                  inp.value = this._hi>=0 ? this._hist[this._hist.length-1-this._hi] : ''; e.preventDefault(); }
        });
    },

    toggle() { document.getElementById('dev-panel').classList.toggle('open'); },

    log(type, msg) {
        const log = document.getElementById('dev-log');
        if (!log) return;
        const ts  = new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
        const cls = {i:'li',g:'lg',w:'lw',s:'ls',e:'le',c:'lc',x:'lx'}[type]||'li';
        const div = document.createElement('div');
        div.className = 'll';
        div.innerHTML = `<span class="ts">[${ts}]</span><span class="${cls}">${msg}</span>`;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    },

    key(e) { if (e.key === 'Enter') this.send(); },

    send() {
        const inp = document.getElementById('dev-input');
        const cmd = inp.value.trim();
        if (!cmd) return;
        inp.value = '';
        this._hist.push(cmd); this._hi = -1;
        this.run(cmd);
    },

    run(raw) {
        const parts = raw.trim().split(/\s+/);
        const cmd   = parts[0].toLowerCase();
        const arg   = parts[1];
        this.log('c', '> ' + raw);

        const cmds = {
            help: () => {
                ['‚îÄ‚îÄ COMMANDES ‚îÄ‚îÄ',
                 'god            ‚Üí invincibilit√© on/off',
                 'hitbox         ‚Üí hitboxes on/off',
                 'fps            ‚Üí compteur FPS on/off',
                 'slow           ‚Üí ralenti dev on/off',
                 'credits <n>    ‚Üí ajouter n cr√©dits',
                 'xp <n>         ‚Üí ajouter n XP',
                 'score <n>      ‚Üí forcer le score (partie active)',
                 'level <0-3>    ‚Üí forcer le niveau (partie active)',
                 'spawn <n>      ‚Üí spawn n ennemis (partie active)',
                 'shield         ‚Üí activer le bouclier',
                 'slow_pu        ‚Üí activer slowmo power-up',
                 'kill           ‚Üí mort instantan√©e',
                 'unlockall      ‚Üí d√©bloquer tous les skins',
                 'daily          ‚Üí compl√©ter la mission du jour',
                 'stats          ‚Üí afficher les stats actuelles',
                 'accounts       ‚Üí voir les comptes (admin)',
                 'matrix         ‚Üí easter egg (5s)',
                 'clear          ‚Üí effacer la console',
                 'reset          ‚Üí RESET TOTAL'].forEach(l => this.log('i', l));
            },

            god: () => {
                Game._god = !Game._god;
                document.getElementById('god-badge').style.display = (Game._god && Game.running) ? 'block' : 'none';
                this.log(Game._god ? 's' : 'w', 'God mode : ' + (Game._god ? 'ON' : 'OFF'));
            },

            hitbox: () => {
                Game._hitbox = !Game._hitbox;
                this.log('i', 'Hitbox : ' + (Game._hitbox ? 'ON' : 'OFF'));
            },

            fps: () => {
                Game._fps = !Game._fps;
                document.getElementById('fps-el').style.display = Game._fps ? 'block' : 'none';
                this.log('i', 'FPS : ' + (Game._fps ? 'ON' : 'OFF'));
            },

            slow: () => {
                Game._slowDev = !Game._slowDev;
                this.log('w', 'Ralenti dev : ' + (Game._slowDev ? 'ON (0.3x)' : 'OFF'));
            },

            credits: () => {
                const n = parseInt(arg) || 100;
                if (S) { S.credits = (S.credits||0) + n; scheduleSave(); }
                this.log('s', `+${n} cr√©dits ‚Üí total : ${S ? S.credits : '?'}`);
                notify('+' + n + ' cr√©dits');
            },

            xp: () => {
                const n = parseInt(arg) || 100;
                if (S) { S.xp = (S.xp||0) + n; scheduleSave(); }
                this.log('s', `+${n} XP ‚Üí total : ${S ? S.xp : '?'}`);
            },

            score: () => {
                if (!Game.running) { this.log('e', 'Lance une partie d\'abord'); return; }
                Game.score = parseInt(arg) || 0;
                this.log('s', 'Score forc√© : ' + Game.score);
            },

            level: () => {
                const n = parseInt(arg);
                Game._forceLvl = (n >= 0 && n <= 3) ? n : null;
                this.log('s', Game._forceLvl !== null
                    ? 'Niveau forc√© : ' + LevelSystem.levels[Game._forceLvl].name
                    : 'Niveau d√©verrouill√© (auto)');
            },

            spawn: () => {
                if (!Game.running) { this.log('e', 'Lance une partie d\'abord'); return; }
                const n = parseInt(arg) || 5;
                const lvl = LevelSystem.getCurrentLevel(Game.score);
                for (let i = 0; i < n; i++) {
                    Game.enemies.push({ x:Math.random()*(Game.canvas.width-25), y:-55-Math.random()*200,
                        speed:lvl.speed, tracker:false, color:'#ff3838' });
                }
                this.log('w', n + ' ennemis spawned');
            },

            shield: () => {
                if (!Game.running) { this.log('e', 'Lance une partie d\'abord'); return; }
                Game._activatePU('shield');
                this.log('s', 'Bouclier activ√©');
            },

            slow_pu: () => {
                if (!Game.running) { this.log('e', 'Lance une partie d\'abord'); return; }
                Game._activatePU('slow');
                this.log('s', 'Slowmo activ√©');
            },

            kill: () => {
                if (!Game.running) { this.log('e', 'Aucune partie en cours'); return; }
                this.log('e', 'Mort forc√©e');
                Game.stop();
            },

            unlockall: () => {
                if (S) {
                    S.ownedSkins = SKINS.map(sk => sk.id);
                    scheduleSave();
                }
                this.log('s', 'Tous les skins d√©bloqu√©s');
                notify('Tous les skins d√©bloqu√©s !', 'orange');
            },

            daily: () => {
                if (!S || !S.daily || !S.daily.mission) { this.log('e', 'Pas de mission'); return; }
                if (S.daily.completed) { this.log('w', 'D√©j√† compl√©t√©e'); return; }
                S.daily.progress = S.daily.mission.target;
                S.daily.completed = true;
                S.credits = (S.credits||0) + S.daily.mission.reward;
                checkAch('daily_done');
                scheduleSave();
                this.log('s', 'Mission compl√©t√©e ! +' + S.daily.mission.reward + ' cr√©dits');
                notify('üéØ Mission compl√©t√©e !', 'orange');
            },

            stats: () => {
                if (!S) { this.log('e', 'Pas de session'); return; }
                [`‚îÄ‚îÄ STATS : ${S.username} ‚îÄ‚îÄ`,
                 `Meilleur  : ${S.highScore}`,
                 `Cr√©dits   : ${S.credits}`,
                 `XP        : ${S.xp} (${getRank(S.xp||0).label})`,
                 `Morts     : ${S.deathCount}`,
                 `Parties   : ${S.gamesPlayed}`,
                 `Temps     : ${fmtTime(S.totalTime||0)}`,
                 `Ach.      : ${Object.keys(S.achievements||{}).length}/${ACHIEVEMENTS.length}`,
                 `Connect√©  : ${isLogged()}`].forEach(l => this.log('i', l));
            },

            accounts: async () => {
                const r = await fetch('/api/admin/stats');
                const d = await r.json();
                this.log('i', `Joueurs : ${d.players} | Scores : ${d.totalScores} | Sessions : ${d.activeSessions}`);
                if (d.topScore) this.log('i', `Top score : ${d.topScore.username} ‚Äî ${d.topScore.score} pts`);
            },

            matrix: () => {
                Game._matrix = true;
                this.log('s', 'Matrix mode ON (5s)');
                setTimeout(() => { Game._matrix = false; this.log('x', 'Matrix mode OFF'); }, 5000);
            },

            clear: () => { document.getElementById('dev-log').innerHTML = ''; },

            reset: async () => {
                if (!confirm('‚ö†Ô∏è Supprimer TOUTES les donn√©es ? (irr√©versible)')) return;
                if (isLogged()) await Auth.logout();
                S = guestState();
                Game.player.color = '#00f3ff';
                this.log('e', 'RESET TOTAL EFFECTU√â');
                UI.show('layer-menu');
            }
        };

        if (cmds[cmd]) { try { cmds[cmd](); } catch(e) { this.log('e', 'Erreur : ' + e.message); } }
        else this.log('e', `Commande inconnue : "${cmd}" ‚Äî tapez "help"`);
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load', () => {
    Game.init();
    console.log('%cNEON DODGE DEV', 'color:#ffaa00;font-size:18px;font-weight:900;font-family:monospace');
    console.log('%cShift+D ‚Üí console dev', 'color:#555;font-family:monospace');
});
</script>
</body>
</html>
