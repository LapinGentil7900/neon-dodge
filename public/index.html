<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON DODGE - PRO NETWORK</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
<canvas id="bgCanvas"></canvas>

<!-- ‚ïê‚ïê MENU ‚ïê‚ïê -->
<div id="layer-menu" class="screen">
    <div id="user-tag" onclick="UI.show('layer-profile')">
        <div id="user-tag-avatar"></div>
        <span id="user-tag-name">Non connect√©</span>
    </div>
    <div class="menu-logo">
        <h1 class="neon-title" id="main-title" onclick="DevTools.titleClick()">NEON</h1>
        <h1 class="neon-title neon-title-2">DODGE</h1>
        <div class="title-sub">PRO NETWORK v2.0</div>
    </div>
    <p id="dev-hint">CLIQUEZ ENCORE... <span id="dev-hint-count">0</span>/5</p>
    <div id="menu-hs-block">
        <div class="hs-label">MEILLEUR SCORE</div>
        <div class="hs-value" id="hs-val">0</div>
    </div>
    <div class="menu-grid">
        <button class="btn btn-play" onclick="Game.start()"><span class="btn-icon">‚ñ∂</span> JOUER</button>
        <button class="btn btn-blue" onclick="UI.show('layer-shop')"><span class="btn-icon">‚óà</span> BOUTIQUE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-lead')"><span class="btn-icon">‚óâ</span> CLASSEMENT</button>
        <button class="btn btn-blue" onclick="UI.show('layer-profile')"><span class="btn-icon">‚óé</span> COMPTE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-stats')"><span class="btn-icon">‚ñ£</span> STATS</button>
        <button class="btn btn-red"  onclick="UI.confirmQuit()"><span class="btn-icon">‚úï</span> QUITTER</button>
    </div>
</div>

<!-- ‚ïê‚ïê BOUTIQUE ‚ïê‚ïê -->
<div id="layer-shop" class="screen" style="display:none;">
    <div class="screen-header">
        <h2 class="screen-title">‚óà BOUTIQUE</h2>
        <div class="credits-badge"><span>‚óÜ</span><span id="shop-credits">0</span> cr√©dits</div>
    </div>
    <div id="skin-list" class="skin-grid"></div>
    <button class="btn btn-red back-btn" onclick="UI.show('layer-menu')">‚Üê RETOUR</button>
</div>

<!-- ‚ïê‚ïê CLASSEMENT ‚ïê‚ïê -->
<div id="layer-lead" class="screen" style="display:none;">
    <h2 class="screen-title">‚óâ TOP JOUEURS</h2>
    <div id="leaderboard-content" class="leaderboard-list"></div>
    <button class="btn btn-red back-btn" onclick="UI.show('layer-menu')">‚Üê RETOUR</button>
</div>

<!-- ‚ïê‚ïê PROFIL ‚ïê‚ïê -->
<div id="layer-profile" class="screen" style="display:none;">
    <div id="profile-connected" style="display:none;flex-direction:column;align-items:center;gap:20px;">
        <div id="profile-avatar-wrap">
            <img id="profile-avatar" src="" alt="" style="display:none;">
            <div id="profile-avatar-fallback">?</div>
            <div class="avatar-ring"></div>
        </div>
        <h2 id="profile-username" class="profile-name">-</h2>
        <div id="profile-role-badge"></div>
        <div class="profile-stats">
            <div class="stat-box"><div class="stat-val" id="profile-credits">0</div><div class="stat-lbl">CR√âDITS</div></div>
            <div class="stat-box stat-box-hs"><div class="stat-val" id="profile-hs">0</div><div class="stat-lbl">HIGH SCORE</div></div>
            <div class="stat-box"><div class="stat-val stat-val-sm" id="profile-level">-</div><div class="stat-lbl">NIVEAU MAX</div></div>
        </div>
        <button class="btn btn-red" onclick="Auth.logout()">D√âCONNEXION</button>
        <button class="btn back-btn" onclick="UI.show('layer-menu')">‚Üê RETOUR</button>
    </div>
    <div id="profile-guest" style="display:none;flex-direction:column;align-items:center;gap:16px;">
        <div class="guest-icon">‚óé</div>
        <h2>TERMINAL OS</h2>
        <p class="guest-desc">Connecte-toi pour sauvegarder tes scores.</p>
        <button class="btn btn-play" onclick="UI.show('layer-auth')">CONNEXION</button>
        <button class="btn back-btn" onclick="UI.show('layer-menu')">‚Üê RETOUR</button>
    </div>
</div>

<!-- ‚ïê‚ïê AUTH ‚ïê‚ïê -->
<div id="layer-auth" class="screen" style="display:none;">
    <h2 class="screen-title">ACC√àS R√âSEAU</h2>
    <div class="auth-tabs">
        <button id="tab-login" class="tab-btn tab-active" onclick="Auth.switchTab('login')">CONNEXION</button>
        <button id="tab-register" class="tab-btn" onclick="Auth.switchTab('register')">INSCRIPTION</button>
    </div>
    <div id="form-login" class="auth-form">
        <div class="input-wrap"><span class="input-icon">‚óé</span><input type="text" id="login-user" placeholder="Pseudo"></div>
        <div class="input-wrap"><span class="input-icon">‚óÜ</span><input type="password" id="login-pass" placeholder="Mot de passe"></div>
        <div id="login-error" class="form-error"></div>
        <button class="btn btn-play" onclick="Auth.login()">SE CONNECTER</button>
    </div>
    <div id="form-register" class="auth-form" style="display:none;">
        <div class="input-wrap"><span class="input-icon">‚óé</span><input type="text" id="reg-user" placeholder="Pseudo (3-20 caract√®res)"></div>
        <div class="input-wrap"><span class="input-icon">‚óÜ</span><input type="password" id="reg-pass" placeholder="Mot de passe (6+)"></div>
        <label class="file-label" for="reg-avatar">
            <span id="file-label-text">üì∑ Photo de profil (optionnel)</span>
            <input type="file" id="reg-avatar" accept="image/jpeg,image/png,image/webp" onchange="Auth.previewAvatar(this)">
        </label>
        <img id="avatar-preview" class="avatar-preview-img" style="display:none;" alt="">
        <div id="reg-error" class="form-error"></div>
        <button class="btn btn-play" onclick="Auth.register()">CR√âER LE COMPTE</button>
    </div>
    <button class="btn btn-red back-btn" onclick="UI.show('layer-menu')">‚Üê RETOUR</button>
</div>

<!-- ‚ïê‚ïê STATS ‚ïê‚ïê -->
<div id="layer-stats" class="screen" style="display:none;">
    <h2 class="screen-title">‚ñ£ STATISTIQUES</h2>
    <div id="stats-content" class="stats-grid"></div>
    <button class="btn btn-red back-btn" onclick="UI.show('layer-menu')">‚Üê RETOUR</button>
</div>

<!-- ‚ïê‚ïê JEU ‚ïê‚ïê -->
<div id="layer-game" style="display:none;position:relative;width:100%;height:100%;">
    <canvas id="gameCanvas"></canvas>
    <div id="hud">
        <div id="score-container">SCORE <span id="ui-score">0</span></div>
        <div id="level-hud">
            <span id="ui-level-name">TUTORIAL</span>
            <span id="ui-level-desc"></span>
        </div>
        <div id="ui-tier"></div>
        <div id="next-level-bar"><div id="next-level-fill"></div></div>
        <div id="next-level-label"></div>
    </div>
    <!-- Indicateurs de bonus actifs -->
    <div id="bonus-hud">
        <div id="bonus-shield"  class="bonus-indicator" style="display:none;">üõ° BOUCLIER</div>
        <div id="bonus-slow"    class="bonus-indicator" style="display:none;">‚ö° SLOW</div>
        <div id="bonus-magnet"  class="bonus-indicator" style="display:none;">üß≤ AIMANT</div>
    </div>
    <button id="btn-pause" onclick="Game.togglePause()">‚è∏</button>
    <div id="level-announce"></div>
    <div id="pause-menu" style="display:none;">
        <div class="pause-inner">
            <h2 class="pause-title">‚è∏ PAUSE</h2>
            <p id="pause-score-info"></p>
            <button class="btn btn-play" onclick="Game.togglePause()">‚ñ∂ REPRENDRE</button>
            <button class="btn btn-red" onclick="Game.quit()">‚úï QUITTER</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê GAME OVER ‚ïê‚ïê -->
<div id="layer-death" class="screen" style="display:none;">
    <div class="death-container">
        <div class="death-glitch" id="death-glitch-text">GAME OVER</div>
        <h2 class="death-title">GAME OVER</h2>
        <div id="death-stats" class="death-stats-wrap"></div>
        <div class="death-actions">
            <button class="btn btn-play" onclick="Game.start()">‚Ü∫ REJOUER</button>
            <button class="btn btn-blue" onclick="UI.show('layer-menu')">‚åÇ MENU</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê CONFIRM ‚ïê‚ïê -->
<div id="layer-confirm" class="screen" style="display:none;">
    <h2>QUITTER ?</h2>
    <button class="btn btn-red" onclick="window.close()">OUI</button>
    <button class="btn btn-blue" onclick="UI.show('layer-menu')">ANNULER</button>
</div>

<!-- ‚ïê‚ïê ADMIN BUTTON + SIDEBAR ‚ïê‚ïê -->
<div id="devtools-overlay" onclick="DevTools.closeSidebar()"></div>
<button id="admin-toggle-btn" onclick="DevTools.toggleSidebar()" style="display:none;">‚öô ADMIN</button>

<div id="devtools-sidebar">
    <div class="devtools-header">
        <div>
            <div style="font-size:13px;font-weight:700;color:#ffcc00;text-shadow:0 0 10px #ffcc00;">‚öô ADMIN PANEL</div>
            <div id="dev-admin-name" style="font-size:9px;color:#ffcc0066;margin-top:2px;"></div>
        </div>
        <button class="devtools-close" onclick="DevTools.closeSidebar()">‚úï</button>
    </div>
    <div class="dev-tabs">
        <button class="dev-tab active" onclick="DevTools.switchTab('tools')" id="dtab-tools">OUTILS</button>
        <button class="dev-tab" onclick="DevTools.switchTab('users')" id="dtab-users">JOUEURS</button>
        <button class="dev-tab" onclick="DevTools.switchTab('stats')" id="dtab-stats">STATS</button>
    </div>

    <!-- OUTILS -->
    <div id="devpanel-tools" class="devtools-body">
        <div class="dev-section-title">INFOS</div>
        <div id="dev-info" class="dev-info-block">‚Äî</div>
        <div class="dev-section-title">CR√âDITS</div>
        <div class="dev-row"><input type="number" id="dev-credits" value="0"><button class="dev-btn" onclick="DevTools.setCredits()">SET</button></div>
        <div class="dev-section-title">HIGH SCORE</div>
        <div class="dev-row"><input type="number" id="dev-hs" value="0"><button class="dev-btn" onclick="DevTools.setHS()">SET</button></div>
        <div class="dev-section-title">SCORE EN JEU</div>
        <div class="dev-row"><input type="number" id="dev-score" value="0"><button class="dev-btn" onclick="DevTools.setScore()">SET</button></div>
        <div class="dev-section-title">SKINS</div>
        <button class="dev-btn dev-btn-full" onclick="DevTools.unlockAll()">D√âBLOQUER TOUS</button>
        <div class="dev-section-title">INVINCIBILIT√â</div>
        <button class="dev-btn dev-btn-full" id="btn-god" onclick="DevTools.toggleGod()">MODE GOD : OFF</button>
        <div class="dev-section-title" style="color:#ff4444;">DANGER</div>
        <button class="dev-btn dev-btn-full dev-btn-red" onclick="DevTools.reset()">‚ö† RESET LOCAL</button>
    </div>

    <!-- JOUEURS -->
    <div id="devpanel-users" class="devtools-body" style="display:none;">
        <div style="display:flex;gap:6px;margin-bottom:8px;">
            <input type="text" id="admin-search" placeholder="Rechercher..." oninput="DevTools.filterUsers()">
            <button class="dev-btn" onclick="DevTools.loadUsers()">‚Ü∫</button>
        </div>
        <div id="admin-stats-bar" class="admin-stats-bar"></div>
        <div id="admin-user-list" class="admin-user-list">
            <div class="loading-text">Clique ‚Ü∫ pour charger</div>
        </div>
    </div>

    <!-- STATS GLOBALES -->
    <div id="devpanel-stats" class="devtools-body" style="display:none;">
        <div id="admin-global-stats" class="admin-global-stats"><div class="loading-text">Clique Actualiser</div></div>
        <button class="dev-btn dev-btn-full" onclick="DevTools.loadGlobalStats()" style="margin-top:8px;">‚Ü∫ ACTUALISER</button>
    </div>
</div>

<script src="levels.js"></script>
<script src="stats_manager.js"></script>
<script>

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BG CANVAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BgCanvas = {
    canvas: document.getElementById('bgCanvas'), ctx: null, particles: [], animFrame: null,
    init() {
        this.ctx = this.canvas.getContext('2d'); this.resize();
        window.addEventListener('resize', () => this.resize());
        for (let i=0;i<120;i++) this.particles.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,size:Math.random()*1.5+0.2,speed:Math.random()*0.5+0.1,opacity:Math.random()*0.5+0.1,color:Math.random()>0.7?'#ff3838':'#00f3ff'});
        this.loop();
    },
    resize() { this.canvas.width=window.innerWidth; this.canvas.height=window.innerHeight; },
    loop() {
        const C=this.ctx; C.clearRect(0,0,this.canvas.width,this.canvas.height);
        this.particles.forEach(p=>{p.y+=p.speed;if(p.y>this.canvas.height){p.y=0;p.x=Math.random()*this.canvas.width;}C.globalAlpha=p.opacity;C.fillStyle=p.color;C.shadowBlur=6;C.shadowColor=p.color;C.beginPath();C.arc(p.x,p.y,p.size,0,Math.PI*2);C.fill();});
        C.globalAlpha=1;C.shadowBlur=0;
        this.animFrame=requestAnimationFrame(()=>this.loop());
    },
    show() { this.canvas.style.display='block'; },
    hide() { this.canvas.style.display='none'; }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API = {
    BASE:'/api',
    _h(mp=false){const h={};if(Auth.token)h['Authorization']='Bearer '+Auth.token;if(!mp)h['Content-Type']='application/json';return h;},
    async post(p,b,mp=false){try{const r=await fetch(this.BASE+p,{method:'POST',headers:this._h(mp),body:mp?b:JSON.stringify(b)});return r.json();}catch(e){return{error:'Erreur r√©seau'};}},
    async get(p){try{const r=await fetch(this.BASE+p,{headers:this._h()});return r.json();}catch(e){return{error:'Erreur r√©seau'};}},
    async del(p,b){try{const r=await fetch(this.BASE+p,{method:'DELETE',headers:this._h(),body:JSON.stringify(b)});return r.json();}catch(e){return{error:'Erreur r√©seau'};}}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SKINS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SKINS_CATALOG = [
    {id:'neon_blue',name:'Neon Blue',color:'#00f3ff',price:0,    tier:'FREE'},
    {id:'emerald',  name:'Emerald',  color:'#00ff88',price:500,  tier:'COMMUN'},
    {id:'ruby',     name:'Ruby',     color:'#ff3838',price:1500, tier:'RARE'},
    {id:'gold',     name:'Gold',     color:'#ffcc00',price:3000, tier:'√âPIQUE'},
    {id:'violet',   name:'Violet',   color:'#cc00ff',price:5000, tier:'√âPIQUE'},
    {id:'white',    name:'White',    color:'#ffffff',price:8000, tier:'L√âGENDAIRE'},
    {id:'inferno',  name:'Inferno',  color:'#ff4400',price:12000,tier:'L√âGENDAIRE'},
    {id:'ghost',    name:'Ghost',    color:'#aaaaaa',price:20000,tier:'MYTHIQUE'}
];
const TIER_COLORS={'FREE':'#888','COMMUN':'#00ff88','RARE':'#0088ff','√âPIQUE':'#cc00ff','L√âGENDAIRE':'#ffcc00','MYTHIQUE':'#ff4400'};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Auth = {
    token: localStorage.getItem('nd_token')||null,
    user:  JSON.parse(localStorage.getItem('nd_user')||'null'),
    isAdmin(){ return this.user?.role==='admin'; },
    switchTab(t){
        const il=t==='login';
        document.getElementById('form-login').style.display=il?'flex':'none';
        document.getElementById('form-register').style.display=il?'none':'flex';
        document.getElementById('tab-login').classList.toggle('tab-active',il);
        document.getElementById('tab-register').classList.toggle('tab-active',!il);
        document.getElementById('login-error').innerText='';
        document.getElementById('reg-error').innerText='';
    },
    previewAvatar(input){
        const f=input.files[0];if(!f)return;
        document.getElementById('file-label-text').innerText='‚úÖ '+f.name;
        const p=document.getElementById('avatar-preview');p.src=URL.createObjectURL(f);p.style.display='block';
    },
    async login(){
        const u=document.getElementById('login-user').value.trim(),p=document.getElementById('login-pass').value;
        const err=document.getElementById('login-error');err.innerText='';
        if(!u||!p){err.innerText='Remplis tous les champs.';return;}
        const btn=document.querySelector('#form-login .btn-play');btn.innerText='‚ü≥...';btn.disabled=true;
        const d=await API.post('/auth/login',{username:u,password:p});
        btn.innerText='SE CONNECTER';btn.disabled=false;
        if(d.error){err.innerText=d.error;return;}
        this._save(d);UI.show('layer-menu');
    },
    async register(){
        const u=document.getElementById('reg-user').value.trim(),p=document.getElementById('reg-pass').value;
        const f=document.getElementById('reg-avatar').files[0];
        const err=document.getElementById('reg-error');err.innerText='';
        if(!u||!p){err.innerText='Remplis tous les champs.';return;}
        const btn=document.querySelector('#form-register .btn-play');btn.innerText='‚ü≥...';btn.disabled=true;
        const fd=new FormData();fd.append('username',u);fd.append('password',p);if(f)fd.append('profilePicture',f);
        const d=await API.post('/auth/register',fd,true);
        btn.innerText='CR√âER LE COMPTE';btn.disabled=false;
        if(d.error){err.innerText=d.error;return;}
        this._save(d);UI.show('layer-menu');
    },
    _save(d){
        this.token=d.token;this.user=d.user;
        localStorage.setItem('nd_token',d.token);localStorage.setItem('nd_user',JSON.stringify(d.user));
        const eq=SKINS_CATALOG.find(s=>s.color===StatsManager.data.equippedSkin&&(d.user.unlockedSkins||[]).includes(s.id));
        if(eq)Game.player.color=eq.color;
        this._ui();
        if(this.isAdmin())DevTools.showAdminPanel();
    },
    logout(){
        this.token=null;this.user=null;
        localStorage.removeItem('nd_token');localStorage.removeItem('nd_user');
        DevTools.hideAdminPanel();this._ui();UI.show('layer-menu');
    },
    async refresh(){
        if(!this.token)return;
        const d=await API.get('/auth/me');
        if(d.error){this.logout();return;}
        this.user=d;localStorage.setItem('nd_user',JSON.stringify(d));this._ui();
    },
    _ui(){
        const u=this.user;
        const tn=document.getElementById('user-tag-name'),ta=document.getElementById('user-tag-avatar'),hs=document.getElementById('hs-val');
        if(u){
            tn.innerText=u.role==='admin'?'‚öô '+u.displayName:u.displayName;
            tn.style.color=u.role==='admin'?'#ffcc00':'';
            if(u.profilePicture){ta.style.backgroundImage=`url(${u.profilePicture})`;ta.style.display='block';}else ta.style.display='none';
            if(hs)hs.innerText=u.highScore.toLocaleString();
        } else {
            tn.innerText='Non connect√©';tn.style.color='';ta.style.display='none';
            if(hs)hs.innerText=StatsManager.data.highScore.toLocaleString();
        }
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const UI = {
    show(id){
        document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
        const el=document.getElementById(id);
        if(el){el.style.display='flex';el.classList.add('screen-enter');setTimeout(()=>el.classList.remove('screen-enter'),400);}
        if(id==='layer-menu'){BgCanvas.show();Auth._ui();}else BgCanvas.hide();
        if(id==='layer-shop')this.renderShop();
        if(id==='layer-lead')this.renderLead();
        if(id==='layer-stats')this.renderStats();
        if(id==='layer-profile')this.renderProfile();
        if(id==='layer-auth')Auth.switchTab('login');
    },
    async renderShop(){
        const list=document.getElementById('skin-list'),credEl=document.getElementById('shop-credits');
        list.innerHTML='<div class="loading-text">‚ü≥ Chargement...</div>';
        let uids=['neon_blue'];
        if(Auth.token){await Auth.refresh();credEl.innerText=(Auth.user?.credits??0).toLocaleString();uids=Auth.user?.unlockedSkins??['neon_blue'];}
        else{uids=SKINS_CATALOG.filter(s=>(StatsManager.data.unlockedSkins||['#00f3ff']).includes(s.color)).map(s=>s.id);credEl.innerText=StatsManager.data.credits.toLocaleString();}
        list.innerHTML='';
        SKINS_CATALOG.forEach((s,i)=>{
            const owned=uids.includes(s.id),eq=Game.player.color===s.color;
            const card=document.createElement('div');
            card.className='skin-card'+(owned?' skin-unlocked':'')+(eq?' skin-equipped':'');
            card.style.setProperty('--skin-color',s.color);card.style.animationDelay=(i*0.05)+'s';
            const tc=TIER_COLORS[s.tier]||'#888';
            card.innerHTML=`<div class="skin-tier" style="color:${tc}">${s.tier}</div><div class="skin-preview-wrap"><div class="skin-preview" style="background:${s.color};box-shadow:0 0 25px ${s.color}88;"></div>${eq?'<div class="skin-equipped-badge">‚úì</div>':''}</div><div class="skin-name">${s.name}</div><div class="skin-price" style="color:${owned?'#00ff88':'#ffcc00'}">${owned?'‚úì D√âBLOQU√â':s.price===0?'GRATUIT':'‚óÜ '+s.price.toLocaleString()}</div><button class="btn-skin-action ${owned?'btn-equip':'btn-buy'}" ${eq?'disabled':''}>${eq?'‚úÖ √âQUIP√â':owned?'√âQUIPER':'ACHETER'}</button>`;
            card.querySelector('.btn-skin-action').addEventListener('click',async()=>{
                if(owned){Game.player.color=s.color;StatsManager.data.equippedSkin=s.color;StatsManager.save();this.renderShop();}
                else await this._buy(s);
            });
            list.appendChild(card);
        });
    },
    async _buy(s){
        if(!Auth.token){
            if(StatsManager.data.credits>=s.price){StatsManager.data.credits-=s.price;if(!StatsManager.data.unlockedSkins)StatsManager.data.unlockedSkins=['#00f3ff'];StatsManager.data.unlockedSkins.push(s.color);Game.player.color=s.color;StatsManager.data.equippedSkin=s.color;StatsManager.save();this.toast('Skin d√©verrouill√© !','success');this.renderShop();}
            else this.toast('Pas assez de cr√©dits !','error');return;
        }
        const d=await API.post('/shop/buy',{skinId:s.id});
        if(d.error){this.toast(d.error,'error');return;}
        Auth.user.credits=d.newCredits;Auth.user.unlockedSkins=d.unlockedSkins;localStorage.setItem('nd_user',JSON.stringify(Auth.user));
        Game.player.color=s.color;StatsManager.data.equippedSkin=s.color;StatsManager.save();
        this.toast(d.message,'success');this.renderShop();
    },
    async renderLead(){
        const c=document.getElementById('leaderboard-content');
        c.innerHTML='<div class="loading-text">‚ü≥ CONNEXION...</div>';
        const d=await API.get('/scores/leaderboard');
        if(d.error||!Array.isArray(d)){c.innerHTML='<p class="form-error">Impossible de charger.</p>';return;}
        if(!d.length){c.innerHTML='<div class="empty-lead">// AUCUN SCORE<br>Sois le premier !</div>';return;}
        c.innerHTML=d.map(e=>`<div class="lead-row" style="animation-delay:${e.rank*0.05}s"><span class="lead-rank ${e.rank<=3?'lead-rank-top':''}">${e.rank<=3?['ü•á','ü•à','ü•â'][e.rank-1]:e.rank}</span><div class="lead-avatar" style="${e.avatar?'background-image:url('+e.avatar+')':''}">${!e.avatar?e.displayName[0].toUpperCase():''}</div><div class="lead-info"><div class="lead-name">${e.displayName}</div><div class="lead-level">${e.level}</div></div><div class="lead-score">${e.score.toLocaleString()} <span style="font-size:9px;opacity:.5">pts</span></div></div>`).join('');
    },
    renderStats(){
        const d=StatsManager.data,u=Auth.user;
        const rows=[
            {label:'Joueur',          value:u?u.displayName:d.username},
            {label:'R√¥le',            value:u?(u.role==='admin'?'‚öô ADMIN':'JOUEUR'):'‚Äî'},
            {label:'Meilleur score',  value:(u?u.highScore:d.highScore).toLocaleString()+' pts'},
            {label:'Cr√©dits',         value:'‚óÜ '+(u?u.credits:d.credits).toLocaleString()},
            {label:'Parties jou√©es',  value:d.gamesPlayed||0},
            {label:'Morts totales',   value:d.deathCount},
            {label:'Temps de jeu',    value:StatsManager.getFormattedTime()},
            {label:'Meilleur niveau', value:d.bestLevel||'TUTORIAL'},
            {label:'Skins d√©bloqu√©s', value:(u?u.unlockedSkins?.length??1:d.unlockedSkins?.length??1)+' / '+SKINS_CATALOG.length}
        ];
        document.getElementById('stats-content').innerHTML=rows.map(r=>`<div class="stat-row"><span class="stat-row-label">${r.label}</span><span class="stat-row-value">${r.value}</span></div>`).join('');
    },
    renderProfile(){
        const conn=document.getElementById('profile-connected'),guest=document.getElementById('profile-guest'),u=Auth.user;
        if(u){
            conn.style.display='flex';guest.style.display='none';
            const av=document.getElementById('profile-avatar'),fb=document.getElementById('profile-avatar-fallback');
            if(u.profilePicture){av.src=u.profilePicture;av.style.display='block';fb.style.display='none';}
            else{av.style.display='none';fb.style.display='flex';fb.innerText=u.displayName[0].toUpperCase();}
            document.getElementById('profile-username').innerText=u.displayName;
            document.getElementById('profile-credits').innerText=u.credits.toLocaleString();
            document.getElementById('profile-hs').innerText=u.highScore.toLocaleString();
            document.getElementById('profile-level').innerText=u.highScoreLevel||'TUTORIAL';
            document.getElementById('profile-role-badge').innerHTML=u.role==='admin'?'<div class="role-badge role-admin">‚öô ADMINISTRATEUR</div>':'<div class="role-badge role-player">‚óé JOUEUR</div>';
        } else{conn.style.display='none';guest.style.display='flex';}
    },
    confirmQuit(){this.show('layer-confirm');},
    toast(msg,type='success'){
        const t=document.createElement('div');t.className='toast toast-'+type;t.innerText=msg;
        document.body.appendChild(t);setTimeout(()=>t.classList.add('toast-show'),10);
        setTimeout(()=>{t.classList.remove('toast-show');setTimeout(()=>t.remove(),400);},3000);
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEV TOOLS / ADMIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _allUsers=[];
const DevTools={
    godMode:false,_clicks:0,_ct:null,
    titleClick(){
        this._clicks++;const h=document.getElementById('dev-hint');h.style.display='block';
        document.getElementById('dev-hint-count').innerText=this._clicks;
        clearTimeout(this._ct);this._ct=setTimeout(()=>{this._clicks=0;h.style.display='none';},2000);
        if(this._clicks>=5){this._clicks=0;h.style.display='none';this.toggleSidebar();}
    },
    showAdminPanel(){document.getElementById('admin-toggle-btn').style.display='flex';document.getElementById('dev-admin-name').innerText=Auth.user?.displayName||'';this.refresh();},
    hideAdminPanel(){document.getElementById('admin-toggle-btn').style.display='none';this.closeSidebar();},
    toggleSidebar(){const s=document.getElementById('devtools-sidebar');s.classList.contains('open')?this.closeSidebar():this.openSidebar();},
    openSidebar(){this.refresh();document.getElementById('devtools-sidebar').classList.add('open');document.getElementById('devtools-overlay').classList.add('active');},
    closeSidebar(){document.getElementById('devtools-sidebar').classList.remove('open');document.getElementById('devtools-overlay').classList.remove('active');},
    switchTab(tab){
        ['tools','users','stats'].forEach(t=>{
            document.getElementById('dtab-'+t).classList.toggle('active',t===tab);
            document.getElementById('devpanel-'+t).style.display=t===tab?'flex':'none';
        });
        if(tab==='users')this.loadUsers();
        if(tab==='stats')this.loadGlobalStats();
    },
    refresh(){
        const d=StatsManager.data,u=Auth.user;
        const ce=document.getElementById('dev-credits'),he=document.getElementById('dev-hs'),se=document.getElementById('dev-score'),ge=document.getElementById('btn-god'),ie=document.getElementById('dev-info');
        if(ce)ce.value=u?u.credits:d.credits;
        if(he)he.value=u?u.highScore:d.highScore;
        if(se)se.value=Game.running?Game.score:0;
        if(ge)ge.innerText=this.godMode?'MODE GOD : ON ‚úì':'MODE GOD : OFF';
        if(ie)ie.innerHTML=`User: ${u?u.displayName:d.username}<br>R√¥le: ${u?u.role.toUpperCase():'‚Äî'}<br>Morts: ${d.deathCount}<br>Temps: ${StatsManager.getFormattedTime()}<br>Auth: ${Auth.token?'‚úÖ JWT':'‚ùå local'}`;
    },
    setCredits(){const v=parseInt(document.getElementById('dev-credits').value);if(isNaN(v))return;StatsManager.data.credits=v;StatsManager.save();if(Auth.user){Auth.user.credits=v;localStorage.setItem('nd_user',JSON.stringify(Auth.user));}UI.toast('Cr√©dits mis √† jour !','success');this.refresh();},
    setHS(){const v=parseInt(document.getElementById('dev-hs').value);if(isNaN(v))return;StatsManager.data.highScore=v;StatsManager.save();if(Auth.user){Auth.user.highScore=v;localStorage.setItem('nd_user',JSON.stringify(Auth.user));}UI.toast('High score mis √† jour !','success');this.refresh();},
    setScore(){const v=parseInt(document.getElementById('dev-score').value);if(!isNaN(v)&&Game.running)Game.score=v;else if(!Game.running)UI.toast("Lance une partie d'abord !","error");},
    unlockAll(){StatsManager.data.unlockedSkins=SKINS_CATALOG.map(s=>s.color);StatsManager.save();if(Auth.user){Auth.user.unlockedSkins=SKINS_CATALOG.map(s=>s.id);localStorage.setItem('nd_user',JSON.stringify(Auth.user));}UI.toast('Tous les skins d√©bloqu√©s !','success');},
    toggleGod(){this.godMode=!this.godMode;document.getElementById('btn-god').innerText=this.godMode?'MODE GOD : ON ‚úì':'MODE GOD : OFF';},
    reset(){if(!confirm('Vraiment tout r√©initialiser ?'))return;StatsManager.reset();this.godMode=false;Auth.logout();this.refresh();UI.toast('Donn√©es r√©initialis√©es.','success');this.closeSidebar();},

    // ‚îÄ‚îÄ ADMIN: Joueurs ‚îÄ‚îÄ
    async loadUsers(){
        const list=document.getElementById('admin-user-list');
        list.innerHTML='<div class="loading-text">‚ü≥ Chargement...</div>';
        const data=await API.get('/admin/users');
        if(data.error){list.innerHTML=`<div class="form-error">${data.error}</div>`;return;}
        _allUsers=data;
        this._renderUserStats(data);
        this._renderUserList(data);
    },
    filterUsers(){
        const q=document.getElementById('admin-search').value.toLowerCase();
        this._renderUserList(_allUsers.filter(u=>u.displayName.toLowerCase().includes(q)||u.username.includes(q)));
    },
    _renderUserStats(users){
        const bar=document.getElementById('admin-stats-bar');
        bar.innerHTML=`<div class="admin-stat-pill">${users.length}<span>joueurs</span></div><div class="admin-stat-pill pill-red">${users.filter(u=>u.banned).length}<span>bannis</span></div><div class="admin-stat-pill pill-gold">${users.filter(u=>u.role==='admin').length}<span>admins</span></div>`;
    },
    _renderUserList(users){
        const list=document.getElementById('admin-user-list');
        if(!users.length){list.innerHTML='<div class="loading-text">Aucun r√©sultat</div>';return;}
        list.innerHTML=users.map(u=>`
        <div class="admin-user-card ${u.banned?'user-banned':''} ${u.role==='admin'?'user-admin':''}">
            <div class="admin-user-header">
                <div class="admin-user-avatar" style="${u.avatar?'background-image:url('+u.avatar+')':''}">${!u.avatar?u.displayName[0].toUpperCase():''}</div>
                <div class="admin-user-info">
                    <div class="admin-user-name">${u.role==='admin'?'‚öô ':''}${u.displayName}${u.banned?'<span class="banned-tag">BANNI</span>':''}</div>
                    <div class="admin-user-sub">‚óÜ${u.credits.toLocaleString()} ¬∑ ${u.highScore.toLocaleString()}pts ¬∑ ${u.highScoreLevel}</div>
                    <div class="admin-user-sub" style="color:#333">${new Date(u.createdAt).toLocaleDateString('fr-FR')}</div>
                </div>
            </div>
            ${u.banned&&u.bannedReason?`<div class="admin-ban-reason">‚ö† ${u.bannedReason}</div>`:''}
            <div class="admin-user-actions">
                ${u.banned?`<button class="dev-btn" onclick="DevTools.unban('${u.id}')">D√âBANNIR</button>`:u.role!=='admin'?`<button class="dev-btn dev-btn-red" onclick="DevTools.banUser('${u.id}','${u.displayName}')">BAN</button>`:''}
                ${u.role!=='admin'?`<button class="dev-btn" onclick="DevTools.kickScore('${u.id}','${u.displayName}')">KICK</button>`:''}
                <button class="dev-btn" onclick="DevTools.editCredits('${u.id}','${u.displayName}',${u.credits})">CR√âDITS</button>
                ${u.role!=='admin'?`<button class="dev-btn pill-gold-btn" onclick="DevTools.promoteUser('${u.id}','${u.displayName}','admin')">ADMIN</button>`:(Auth.user?.id!==u.id?`<button class="dev-btn" onclick="DevTools.promoteUser('${u.id}','${u.displayName}','player')">R√âTROGRADER</button>`:'')}
                ${u.role!=='admin'?`<button class="dev-btn dev-btn-red" onclick="DevTools.deleteUser('${u.id}','${u.displayName}')">SUPPR</button>`:''}
            </div>
        </div>`).join('');
    },
    async banUser(id,name){const r=prompt(`Raison du ban de ${name}:`,'Violation des r√®gles');if(r===null)return;const d=await API.post('/admin/ban',{userId:id,reason:r});d.error?UI.toast(d.error,'error'):(UI.toast(d.message,'success'),this.loadUsers());},
    async unban(id){const d=await API.post('/admin/unban',{userId:id});d.error?UI.toast(d.error,'error'):(UI.toast(d.message,'success'),this.loadUsers());},
    async kickScore(id,name){if(!confirm(`Remettre le score de ${name} √† z√©ro ?`))return;const d=await API.post('/admin/kick-score',{userId:id});d.error?UI.toast(d.error,'error'):(UI.toast(d.message,'success'),this.loadUsers());},
    async editCredits(id,name,cur){const v=prompt(`Cr√©dits pour ${name} (actuel: ${cur}):`,cur);if(v===null)return;const c=parseInt(v);if(isNaN(c)||c<0){UI.toast('Valeur invalide.','error');return;}const d=await API.post('/admin/set-credits',{userId:id,credits:c});d.error?UI.toast(d.error,'error'):(UI.toast(d.message,'success'),this.loadUsers());},
    async promoteUser(id,name,role){if(!confirm(`${role==='admin'?'Promouvoir':'R√©trograder'} ${name} ?`))return;const d=await API.post('/admin/promote',{userId:id,role});d.error?UI.toast(d.error,'error'):(UI.toast(d.message,'success'),this.loadUsers());},
    async deleteUser(id,name){if(!confirm(`‚ö† Supprimer D√âFINITIVEMENT ${name} ?`))return;const d=await API.del('/admin/delete-user',{userId:id});d.error?UI.toast(d.error,'error'):(UI.toast(d.message,'success'),this.loadUsers());},
    async loadGlobalStats(){
        const el=document.getElementById('admin-global-stats');
        el.innerHTML='<div class="loading-text">‚ü≥ Chargement...</div>';
        const d=await API.get('/admin/stats');
        if(d.error){el.innerHTML=`<div class="form-error">${d.error}</div>`;return;}
        el.innerHTML=`<div class="global-stat"><div class="global-stat-val">${d.totalUsers}</div><div class="global-stat-lbl">JOUEURS</div></div><div class="global-stat"><div class="global-stat-val" style="color:#ff4444">${d.totalBanned}</div><div class="global-stat-lbl">BANNIS</div></div><div class="global-stat"><div class="global-stat-val" style="color:#ffcc00">${d.totalAdmins}</div><div class="global-stat-lbl">ADMINS</div></div>${d.topScore?`<div class="global-stat" style="grid-column:1/-1"><div class="global-stat-val" style="color:#ffd700">${d.topScore.score.toLocaleString()} pts</div><div class="global-stat-lbl">RECORD ¬∑ ${d.topScore.name}</div></div>`:''}`;
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BONUS SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BONUS_TYPES = [
    { type:'shield', label:'üõ°', color:'#00ff88', desc:'BOUCLIER' },
    { type:'slow',   label:'‚ö°', color:'#00f3ff', desc:'SLOW' },
    { type:'magnet', label:'üß≤', color:'#ff00ff', desc:'AIMANT' },
    { type:'credits',label:'‚óÜ',  color:'#ffcc00', desc:'CR√âDITS +50' }
];

const BonusSystem = {
    items: [],
    active: { shield:false, slow:false, magnet:false },
    timers: { shield:0, slow:0, magnet:0 },
    spawnTimer: 0,
    SPAWN_INTERVAL: 1800, // ~30s √† 60fps

    reset(){ this.items=[]; this.active={shield:false,slow:false,magnet:false}; this.timers={shield:0,slow:0,magnet:0}; this.spawnTimer=0; this._updateHUD(); },

    update(playerX, playerY, score, canvas){
        this.spawnTimer++;
        // Spawn al√©atoire entre 1800 et 2400 frames (~30-40s)
        if(this.spawnTimer >= this.SPAWN_INTERVAL + Math.floor(Math.random()*600)){
            this.spawnTimer=0;
            const t=BONUS_TYPES[Math.floor(Math.random()*BONUS_TYPES.length)];
            this.items.push({ x: 50+Math.random()*(canvas.width-100), y:-30, type:t.type, label:t.label, color:t.color, desc:t.desc, speed:2, pulse:0 });
        }

        // Update actifs
        ['shield','slow','magnet'].forEach(k=>{
            if(this.active[k]){
                this.timers[k]--;
                if(this.timers[k]<=0){ this.active[k]=false; this._updateHUD(); }
            }
        });

        // Aimant : attire les autres bonus vers le joueur
        if(this.active.magnet){
            this.items.forEach(b=>{
                const dx=(playerX+15)-b.x, dy=(playerY+15)-b.y;
                const dist=Math.hypot(dx,dy)||1;
                if(dist<300){ b.x+=dx/dist*4; b.y+=dy/dist*4; }
            });
        }

        for(let i=this.items.length-1;i>=0;i--){
            const b=this.items[i];
            b.y+=b.speed; b.pulse+=0.1;

            // Collision joueur
            if(Math.hypot(playerX+15-b.x, playerY+15-b.y)<28){
                this._collect(b, score);
                this.items.splice(i,1);
                continue;
            }
            // Hors √©cran
            if(b.y>canvas.height+50) this.items.splice(i,1);
        }
    },

    _collect(b, score){
        if(b.type==='shield'){ this.active.shield=true; this.timers.shield=300; }
        else if(b.type==='slow'){ this.active.slow=true; this.timers.slow=300; }
        else if(b.type==='magnet'){ this.active.magnet=true; this.timers.magnet=420; }
        else if(b.type==='credits'){
            const earned=50;
            StatsManager.data.credits+=earned; StatsManager.save();
            if(Auth.user){ Auth.user.credits+=earned; localStorage.setItem('nd_user',JSON.stringify(Auth.user)); }
        }
        UI.toast(b.desc+(b.type==='credits'?' +50':''),'success');
        this._updateHUD();
    },

    _updateHUD(){
        document.getElementById('bonus-shield').style.display=this.active.shield?'flex':'none';
        document.getElementById('bonus-slow').style.display=this.active.slow?'flex':'none';
        document.getElementById('bonus-magnet').style.display=this.active.magnet?'flex':'none';
    },

    draw(ctx){
        this.items.forEach(b=>{
            const glow=Math.sin(b.pulse)*8+12;
            ctx.save();
            ctx.shadowBlur=glow; ctx.shadowColor=b.color;
            // Cercle
            ctx.beginPath(); ctx.arc(b.x,b.y,14,0,Math.PI*2);
            ctx.fillStyle=b.color+'33'; ctx.fill();
            ctx.strokeStyle=b.color; ctx.lineWidth=1.5; ctx.stroke();
            // Emoji/label
            ctx.shadowBlur=0; ctx.font='14px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(b.label, b.x, b.y);
            ctx.restore();
        });
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Game = {
    canvas: document.getElementById('gameCanvas'),
    ctx:null, running:false, paused:false, score:0,
    player:{x:0,y:0,color:'#00f3ff'},
    enemies:[], trails:[],
    currentLevelName:'', burstTimer:0, glitchTimer:0, timeTimer:0,
    bgParticles:[], animFrame:null,

    init(){
        this.ctx=this.canvas.getContext('2d'); this.resize();
        StatsManager.init();
        if(StatsManager.data.equippedSkin) this.player.color=StatsManager.data.equippedSkin;
        for(let i=0;i<80;i++) this.bgParticles.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,size:Math.random()*1.5+0.3,speed:Math.random()*0.4+0.1});
        window.addEventListener('resize',()=>this.resize());
        window.addEventListener('keydown',(e)=>{if((e.key==='Escape'||e.key==='p'||e.key==='P')&&this.running)this.togglePause();});
        this.canvas.addEventListener('touchmove',(e)=>{e.preventDefault();this.player.x=e.touches[0].clientX-15;},{passive:false});
        if(Auth.token&&Auth.user&&Auth.isAdmin()) DevTools.showAdminPanel();
        Auth._ui(); BgCanvas.init();
    },

    resize(){ this.canvas.width=window.innerWidth; this.canvas.height=window.innerHeight; },

    start(){
        if(this.animFrame)cancelAnimationFrame(this.animFrame);
        this.running=true;this.paused=false;this.score=0;
        this.enemies=[];this.trails=[];
        this.burstTimer=0;this.glitchTimer=0;this.timeTimer=0;this.currentLevelName='';
        BonusSystem.reset();
        this.player.x=this.canvas.width/2-15; this.player.y=this.canvas.height-80;
        document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
        document.getElementById('layer-game').style.display='block';
        document.getElementById('pause-menu').style.display='none';
        BgCanvas.hide();
        StatsManager.data.gamesPlayed=(StatsManager.data.gamesPlayed||0)+1; StatsManager.save();
        window.onmousemove=(ev)=>{this.player.x=ev.clientX-15;};
        this.loop();
    },

    async stop(){
        if(!this.running)return;
        this.running=false;this.paused=false;window.onmousemove=null;
        if(this.animFrame)cancelAnimationFrame(this.animFrame);
        const fs=this.score, lvl=LevelSystem.getCurrentLevel(fs), lvlName=lvl.name;
        StatsManager.data.deathCount++;
        const isNew=fs>StatsManager.data.highScore;
        if(isNew){StatsManager.data.highScore=fs;StatsManager.data.bestLevel=lvlName;}
        StatsManager.save();
        let ce=Math.floor(fs/10),isNewHs=isNew;
        if(Auth.token){
            const r=await API.post('/scores/submit',{score:fs,level:lvlName});
            if(!r.error){ce=r.creditsEarned;isNewHs=r.isNewHighScore;Auth.user.credits=r.newCredits;Auth.user.highScore=r.highScore;if(isNewHs)Auth.user.highScoreLevel=lvlName;localStorage.setItem('nd_user',JSON.stringify(Auth.user));}
        } else{StatsManager.data.credits+=ce;StatsManager.save();}
        document.getElementById('layer-game').style.display='none';
        document.getElementById('layer-death').style.display='flex';
        BgCanvas.show();
        document.getElementById('death-stats').innerHTML=`<div class="death-score">${fs.toLocaleString()}</div><div class="death-score-label">POINTS</div><div class="death-info-grid"><div class="death-info-item"><div class="death-info-val" style="color:${lvl.color}">${lvlName}</div><div class="death-info-lbl">NIVEAU</div></div><div class="death-info-item"><div class="death-info-val" style="color:#ffcc00">+${ce.toLocaleString()}</div><div class="death-info-lbl">CR√âDITS</div></div><div class="death-info-item"><div class="death-info-val">${LevelSystem.getTierName(fs)}</div><div class="death-info-lbl">TIER</div></div></div>${isNewHs?'<div class="new-record">üèÜ NOUVEAU RECORD !</div>':''}${!Auth.token?'<div class="death-login-hint">Connecte-toi pour sauvegarder !</div>':''}`;
        const gl=document.getElementById('death-glitch-text');let c=0;
        const gi=setInterval(()=>{gl.style.transform=`translate(${(Math.random()-.5)*6}px,${(Math.random()-.5)*6}px)`;gl.style.opacity=Math.random()>.3?'.5':'0';if(++c>12){clearInterval(gi);gl.style.transform='';gl.style.opacity='.15';}},80);
    },

    quit(){
        if(this.running){StatsManager.data.credits+=Math.floor(this.score/10);if(this.score>StatsManager.data.highScore)StatsManager.data.highScore=this.score;StatsManager.save();}
        this.running=false;this.paused=false;if(this.animFrame)cancelAnimationFrame(this.animFrame);window.onmousemove=null;
        document.getElementById('layer-game').style.display='none';document.getElementById('pause-menu').style.display='none';
        UI.show('layer-menu');
    },

    togglePause(){
        if(!this.running&&!this.paused)return;
        this.paused=!this.paused;
        document.getElementById('pause-menu').style.display=this.paused?'flex':'none';
        document.getElementById('btn-pause').innerText=this.paused?'‚ñ∂':'‚è∏';
        document.getElementById('pause-score-info').innerText=`Score : ${this.score.toLocaleString()} pts`;
        if(!this.paused)this.loop();
    },

    loop(){if(!this.running||this.paused)return;this.update();this.draw();this.animFrame=requestAnimationFrame(()=>this.loop());},

    update(){
        const lvl=LevelSystem.getCurrentLevel(this.score);
        const slowFactor=BonusSystem.active.slow?0.4:1.0;

        if(lvl.name!==this.currentLevelName){
            this.currentLevelName=lvl.name;
            document.getElementById('ui-level-name').innerText=lvl.name;
            document.getElementById('ui-level-name').style.color=lvl.color||'#00f3ff';
            document.getElementById('ui-level-desc').innerText=lvl.description||'';
            document.getElementById('ui-tier').innerText=LevelSystem.getTierName(this.score);
            this._announce(lvl.name,lvl.color,lvl.description);
            if(this.score>0)StatsManager.data.bestLevel=lvl.name;
        }

        const next=LevelSystem.getNextLevel(this.score);
        if(next){const pct=Math.min(100,((this.score-lvl.scoreReq)/(next.scoreReq-lvl.scoreReq))*100);document.getElementById('next-level-fill').style.width=pct+'%';document.getElementById('next-level-fill').style.background=lvl.color||'#00f3ff';document.getElementById('next-level-label').innerText=`‚Üí ${next.name} dans ${(next.scoreReq-this.score).toLocaleString()} pts`;}
        else{document.getElementById('next-level-fill').style.width='100%';document.getElementById('next-level-label').innerText='‚àû MAX NIVEAU';}

        if(Math.random()<lvl.rate)this._spawn(lvl);

        // Burst : vague group√©e
        if(lvl.burst){
            this.burstTimer++;
            if(this.burstTimer>=90){
                this.burstTimer=0;
                const count=3+Math.floor(this.score/5000); // plus d'ennemis avec le score
                for(let i=0;i<count;i++)setTimeout(()=>{if(this.running&&!this.paused)this._spawn(lvl);},i*60);
            }
        }

        // Glitch : cercle d'ennemis
        if(lvl.glitch){
            this.glitchTimer++;
            if(this.glitchTimer>=160){
                this.glitchTimer=0;
                this.canvas.style.filter=`hue-rotate(${Math.random()*360}deg) brightness(2)`;
                setTimeout(()=>{this.canvas.style.filter='';},120);
                for(let a=0;a<6;a++){const angle=(a/6)*Math.PI*2;const e=this._mk(lvl);e.x=this.canvas.width/2+Math.cos(angle)*250;e.y=-30;e.vx=Math.cos(angle)*2;this.enemies.push(e);}
            }
        }

        this.timeTimer++;if(this.timeTimer>=60){this.timeTimer=0;StatsManager.incrementTime();}

        const W=this.canvas.width,H=this.canvas.height;
        this.bgParticles.forEach(p=>{p.y+=p.speed;if(p.y>H){p.y=0;p.x=Math.random()*W;}});
        this.trails.push({x:this.player.x+15,y:this.player.y+15,alpha:0.4,color:this.player.color});
        if(this.trails.length>8)this.trails.shift();
        this.trails.forEach(t=>{t.alpha-=0.04;});

        // Update bonus
        BonusSystem.update(this.player.x, this.player.y, this.score, this.canvas);

        for(let i=this.enemies.length-1;i>=0;i--){
            const e=this.enemies[i];
            const spd=e.speed*slowFactor;

            if(e.tracker){
                // ‚îÄ‚îÄ FIX TRACKER : vitesse limit√©e, ne peut pas rester coll√© ‚îÄ‚îÄ
                const dx=(this.player.x+15)-(e.x+12);
                const dy=(this.player.y+15)-(e.y+12);
                const dist=Math.hypot(dx,dy)||1;
                // Toujours descendre + tracking lat√©ral limit√©
                e.x+=((dx/dist)*e.trackSpeed)*slowFactor;
                e.y+=((Math.abs(dy/dist)*spd)+e.trackSpeed*slowFactor)*0.5+1;
            } else {
                if(e.zigzag)e.x+=Math.sin(e.y*0.05+e.phase)*3;
                e.x+=e.vx||0;
                e.y+=spd;
            }

            // Collision
            if(!DevTools.godMode&&!BonusSystem.active.shield){
                if(Math.hypot(this.player.x+15-(e.x+12),this.player.y+15-(e.y+12))<24){this.stop();return;}
            } else if(!DevTools.godMode&&BonusSystem.active.shield){
                if(Math.hypot(this.player.x+15-(e.x+12),this.player.y+15-(e.y+12))<24){
                    // Bouclier absorbe 1 collision
                    BonusSystem.active.shield=false;BonusSystem.timers.shield=0;BonusSystem._updateHUD();
                    this.enemies.splice(i,1);
                    UI.toast('Bouclier bris√© !','error');
                    continue;
                }
            }

            if(e.y>H+60||e.x<-100||e.x>W+100){this.enemies.splice(i,1);this.score+=10;}
        }
        document.getElementById('ui-score').innerText=this.score.toLocaleString();
    },

    // Cr√©er un ennemi avec le bon ratio tracker/normal
    _mk(lvl){
        const isTracker=lvl.tracker&&Math.random()<(lvl.trackRatio||0.3);
        const isZigzag=!isTracker&&lvl.zigzag&&Math.random()<0.5;
        return{
            x:Math.random()*this.canvas.width, y:-50,
            speed:lvl.speed+(Math.random()*1.5-0.75),
            tracker:isTracker,
            trackSpeed:lvl.speed*0.25, // vitesse de tracking r√©duite
            zigzag:isZigzag,
            phase:Math.random()*Math.PI*2,
            color:lvl.color||'#ff3838',
            vx:0,
            size:18+Math.random()*8
        };
    },
    _spawn(lvl){this.enemies.push(this._mk(lvl));},

    _announce(name,color,desc){
        const el=document.getElementById('level-announce');
        el.style.color=color||'#00f3ff';el.style.opacity='1';el.style.transform='scale(1.15)';
        el.innerHTML=name+(desc?`<div class="announce-sub">${desc}</div>`:'');
        clearTimeout(this._aTO);this._aTO=setTimeout(()=>{el.style.opacity='0';el.style.transform='scale(1)';},2200);
    },

    draw(){
        const lvl=LevelSystem.getCurrentLevel(this.score),C=this.ctx;
        // Fond
        C.fillStyle=lvl.bgColor||'#050505';C.fillRect(0,0,this.canvas.width,this.canvas.height);
        C.shadowBlur=0;
        // Particules fond
        this.bgParticles.forEach(p=>{C.fillStyle=(lvl.color||'#00f3ff')+'18';C.beginPath();C.arc(p.x,p.y,p.size,0,Math.PI*2);C.fill();});
        // Tra√Æn√©es
        this.trails.forEach(t=>{if(t.alpha<=0)return;C.globalAlpha=t.alpha;C.fillStyle=t.color;C.shadowBlur=8;C.shadowColor=t.color;C.fillRect(t.x-4,t.y-4,8,8);});
        C.globalAlpha=1;
        // Joueur
        C.shadowBlur=25;C.shadowColor=this.player.color;C.fillStyle=this.player.color;
        C.fillRect(this.player.x,this.player.y,30,30);
        C.fillStyle='#ffffff66';C.fillRect(this.player.x+6,this.player.y+6,10,10);
        // Bouclier visuel
        if(BonusSystem.active.shield){
            C.strokeStyle='#00ff88';C.lineWidth=2;C.shadowColor='#00ff88';C.shadowBlur=20;
            C.beginPath();C.arc(this.player.x+15,this.player.y+15,24,0,Math.PI*2);C.stroke();
        }
        if(DevTools.godMode){C.strokeStyle='#ffcc00';C.lineWidth=2;C.shadowColor='#ffcc00';C.shadowBlur=15;C.strokeRect(this.player.x-5,this.player.y-5,40,40);}
        // Ennemis
        this.enemies.forEach(e=>{
            const c=e.color||'#ff3838';C.shadowBlur=16;C.shadowColor=c;C.fillStyle=c;C.fillRect(e.x,e.y,e.size,e.size);
            if(e.tracker){
                // Indicateur visuel tracker : croix sur l'ennemi
                C.strokeStyle='#ffffff88';C.lineWidth=1;
                C.strokeRect(e.x-3,e.y-3,e.size+6,e.size+6);
                C.beginPath();C.moveTo(e.x+e.size/2,e.y-8);C.lineTo(e.x+e.size/2,e.y);C.stroke();
            }
        });
        // Bonus
        BonusSystem.draw(C);
        C.shadowBlur=0;
    }
};

window.onload=()=>Game.init();
</script>
</body>
</html>
