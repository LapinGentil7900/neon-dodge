<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON DODGE - PRO NETWORK</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MENU PRINCIPAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-menu" class="screen">
    <div id="user-tag" onclick="UI.show('layer-profile')">
        <div id="user-tag-avatar"></div>
        <span id="user-tag-name">Non connect√©</span>
    </div>

    <h1 class="neon-title" id="main-title" onclick="DevTools.titleClick()">NEON DODGE</h1>
    <p id="menu-highscore">MEILLEUR SCORE : <span id="hs-val">0</span></p>
    <p id="dev-hint" style="display:none; font-size:9px; color:#ffffff33; letter-spacing:2px; margin:0;">CLIQUEZ ENCORE...</p>

    <div class="menu-grid">
        <button class="btn"          onclick="Game.start()">JOUER</button>
        <button class="btn btn-blue" onclick="UI.show('layer-shop')">BOUTIQUE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-lead')">CLASSEMENT</button>
        <button class="btn btn-blue" onclick="UI.show('layer-profile')">COMPTE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-stats')">STATISTIQUES</button>
        <button class="btn btn-red"  onclick="UI.confirmQuit()">QUITTER</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOUTIQUE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-shop" class="screen" style="display:none;">
    <h2>BOUTIQUE DE SKINS</h2>
    <p class="credits-display">CR√âDITS : <span id="shop-credits">0</span></p>
    <div id="skin-list" class="skin-grid"></div>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CLASSEMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-lead" class="screen" style="display:none;">
    <h2>TOP JOUEURS</h2>
    <div id="leaderboard-content" class="leaderboard-list"></div>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPTE / TERMINAL OS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-profile" class="screen" style="display:none;">
    <div id="profile-connected" style="display:none; flex-direction:column; align-items:center; gap:16px;">
        <div id="profile-avatar-wrap">
            <img id="profile-avatar" src="" alt="Avatar" style="display:none;">
            <div id="profile-avatar-fallback">?</div>
        </div>
        <h2 id="profile-username">-</h2>
        <div class="profile-stats">
            <div class="stat-box"><div class="stat-val" id="profile-credits">0</div><div class="stat-lbl">CR√âDITS</div></div>
            <div class="stat-box"><div class="stat-val" id="profile-hs">0</div><div class="stat-lbl">HIGH SCORE</div></div>
            <div class="stat-box"><div class="stat-val" id="profile-level">-</div><div class="stat-lbl">NIVEAU MAX</div></div>
        </div>
        <button class="btn btn-red" onclick="Auth.logout()">D√âCONNEXION</button>
        <button class="btn" onclick="UI.show('layer-menu')">RETOUR</button>
    </div>
    <div id="profile-guest" style="display:none; flex-direction:column; align-items:center; gap:16px;">
        <h2>TERMINAL OS</h2>
        <p style="color:#888; font-size:12px; text-align:center; max-width:300px;">Connecte-toi pour sauvegarder tes scores, acc√©der √† la boutique et figurer au classement.</p>
        <button class="btn" onclick="UI.show('layer-auth')">CONNEXION</button>
        <button class="btn" onclick="UI.show('layer-menu')">RETOUR</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-auth" class="screen" style="display:none;">
    <h2>ACC√àS R√âSEAU</h2>
    <div class="auth-tabs">
        <button id="tab-login"    class="tab-btn tab-active" onclick="Auth.switchTab('login')">CONNEXION</button>
        <button id="tab-register" class="tab-btn"            onclick="Auth.switchTab('register')">INSCRIPTION</button>
    </div>

    <div id="form-login" style="display:flex; flex-direction:column; align-items:center; gap:10px; width:min(360px,90vw);">
        <input type="text"     id="login-user" placeholder="Pseudo" autocomplete="username">
        <input type="password" id="login-pass" placeholder="Mot de passe" autocomplete="current-password">
        <div id="login-error" class="form-error"></div>
        <button class="btn" onclick="Auth.login()">CONNEXION</button>
    </div>

    <div id="form-register" style="display:none; flex-direction:column; align-items:center; gap:10px; width:min(360px,90vw);">
        <input type="text"     id="reg-user" placeholder="Pseudo (3-20 caract√®res)" autocomplete="username">
        <input type="password" id="reg-pass" placeholder="Mot de passe (6+ caract√®res)" autocomplete="new-password">
        <label class="file-label" for="reg-avatar">
            <span id="file-label-text">üì∑ Photo de profil (optionnel, max 2 Mo)</span>
            <input type="file" id="reg-avatar" accept="image/jpeg,image/png,image/webp" onchange="Auth.previewAvatar(this)">
        </label>
        <img id="avatar-preview" style="display:none; width:70px; height:70px; border-radius:50%; object-fit:cover; border:2px solid var(--neon);" alt="Aper√ßu">
        <div id="reg-error" class="form-error"></div>
        <button class="btn" onclick="Auth.register()">CR√âER LE COMPTE</button>
    </div>

    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATISTIQUES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-stats" class="screen" style="display:none;">
    <h2>STATISTIQUES</h2>
    <div id="stats-content"></div>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JEU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-game" style="display:none; position:relative; width:100%; height:100%;">
    <canvas id="gameCanvas"></canvas>

    <div id="hud">
        <div id="score-container">SCORE: <span id="ui-score">0</span></div>
        <div id="level-hud">
            <span id="ui-level-name">TUTORIAL</span>
            <span id="ui-level-desc"></span>
        </div>
        <div id="ui-tier"></div>
        <div id="next-level-bar"><div id="next-level-fill"></div></div>
        <div id="next-level-label"></div>
    </div>

    <button id="btn-pause" onclick="Game.togglePause()">‚è∏</button>
    <div id="level-announce"></div>

    <div id="pause-menu" style="display:none;">
        <h2>EN PAUSE</h2>
        <p id="pause-score-info"></p>
        <button class="btn"         onclick="Game.togglePause()">REPRENDRE</button>
        <button class="btn btn-red" onclick="Game.quit()">QUITTER LA PARTIE</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME OVER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-death" class="screen" style="display:none;">
    <h2 class="death-title">GAME OVER</h2>
    <div id="death-stats"></div>
    <button class="btn"          onclick="Game.start()">REJOUER</button>
    <button class="btn btn-blue" onclick="UI.show('layer-menu')">MENU</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIRM QUIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="layer-confirm" class="screen" style="display:none;">
    <h2>QUITTER ?</h2>
    <p>Voulez-vous vraiment fermer le jeu ?</p>
    <button class="btn btn-red"  onclick="window.close()">OUI, QUITTER</button>
    <button class="btn btn-blue" onclick="UI.show('layer-menu')">ANNULER</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEV TOOLS ‚Äî SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="devtools-overlay" onclick="DevTools.closeSidebar()"></div>
<div id="devtools-sidebar">
    <div class="devtools-header">
        <span>‚öô DEV TOOLS</span>
        <button class="devtools-close" onclick="DevTools.closeSidebar()">‚úï</button>
    </div>
    <div class="devtools-body">
        <div class="dev-section-title">INFORMATIONS</div>
        <div id="dev-info" class="dev-info-block">‚Äî</div>

        <div class="dev-section-title">CR√âDITS</div>
        <div class="dev-row">
            <input type="number" id="dev-credits" value="0">
            <button class="dev-btn" onclick="DevTools.setCredits()">SET</button>
        </div>

        <div class="dev-section-title">HIGH SCORE</div>
        <div class="dev-row">
            <input type="number" id="dev-hs" value="0">
            <button class="dev-btn" onclick="DevTools.setHS()">SET</button>
        </div>

        <div class="dev-section-title">SCORE EN JEU</div>
        <div class="dev-row">
            <input type="number" id="dev-score" value="0">
            <button class="dev-btn" onclick="DevTools.setScore()">SET</button>
        </div>

        <div class="dev-section-title">SKINS</div>
        <button class="dev-btn dev-btn-full" onclick="DevTools.unlockAll()">D√âBLOQUER TOUS</button>

        <div class="dev-section-title">INVINCIBILIT√â</div>
        <button class="dev-btn dev-btn-full" id="btn-god" onclick="DevTools.toggleGod()">MODE GOD : OFF</button>

        <div class="dev-section-title" style="color:#ff4444;">DANGER</div>
        <button class="dev-btn dev-btn-full dev-btn-red" onclick="DevTools.reset()">‚ö† RESET COMPLET</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCRIPTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script src="levels.js"></script>
<script src="stats_manager.js"></script>
<script>

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  API CLIENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API = {
    BASE: '/api',
    _headers(multipart = false) {
        const h = {};
        if (Auth.token) h['Authorization'] = 'Bearer ' + Auth.token;
        if (!multipart) h['Content-Type'] = 'application/json';
        return h;
    },
    async post(path, body, multipart = false) {
        try {
            const r = await fetch(this.BASE + path, {
                method: 'POST',
                headers: this._headers(multipart),
                body: multipart ? body : JSON.stringify(body)
            });
            return r.json();
        } catch(e) { return { error: 'Erreur r√©seau.' }; }
    },
    async get(path) {
        try {
            const r = await fetch(this.BASE + path, { headers: this._headers() });
            return r.json();
        } catch(e) { return { error: 'Erreur r√©seau.' }; }
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CATALOGUE SKINS (miroir du serveur)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SKINS_CATALOG = [
    { id: 'neon_blue', name: 'Neon Blue', color: '#00f3ff', price: 0     },
    { id: 'emerald',   name: 'Emerald',   color: '#00ff88', price: 500   },
    { id: 'ruby',      name: 'Ruby',      color: '#ff3838', price: 1500  },
    { id: 'gold',      name: 'Gold',      color: '#ffcc00', price: 3000  },
    { id: 'violet',    name: 'Violet',    color: '#cc00ff', price: 5000  },
    { id: 'white',     name: 'White',     color: '#ffffff', price: 8000  },
    { id: 'inferno',   name: 'Inferno',   color: '#ff4400', price: 12000 },
    { id: 'ghost',     name: 'Ghost',     color: '#aaaaaa', price: 20000 }
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEV_USERS = ['dev', 'admin', 'root', 'devmode'];

const Auth = {
    token: localStorage.getItem('nd_token') || null,
    user:  JSON.parse(localStorage.getItem('nd_user') || 'null'),

    switchTab(tab) {
        const isLogin = tab === 'login';
        document.getElementById('form-login').style.display    = isLogin ? 'flex' : 'none';
        document.getElementById('form-register').style.display = isLogin ? 'none' : 'flex';
        document.getElementById('tab-login').classList.toggle('tab-active', isLogin);
        document.getElementById('tab-register').classList.toggle('tab-active', !isLogin);
        document.getElementById('login-error').innerText = '';
        document.getElementById('reg-error').innerText   = '';
    },

    previewAvatar(input) {
        const file = input.files[0];
        if (!file) return;
        document.getElementById('file-label-text').innerText = '‚úÖ ' + file.name;
        const preview = document.getElementById('avatar-preview');
        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';
    },

    async login() {
        const user  = document.getElementById('login-user').value.trim();
        const pass  = document.getElementById('login-pass').value;
        const errEl = document.getElementById('login-error');
        errEl.innerText = '';
        if (!user || !pass) { errEl.innerText = 'Remplis tous les champs.'; return; }

        const data = await API.post('/auth/login', { username: user, password: pass });
        if (data.error) { errEl.innerText = data.error; return; }
        this._saveSession(data);
        UI.show('layer-menu');
    },

    async register() {
        const username   = document.getElementById('reg-user').value.trim();
        const password   = document.getElementById('reg-pass').value;
        const avatarFile = document.getElementById('reg-avatar').files[0];
        const errEl      = document.getElementById('reg-error');
        errEl.innerText = '';
        if (!username || !password) { errEl.innerText = 'Remplis tous les champs.'; return; }

        const fd = new FormData();
        fd.append('username', username);
        fd.append('password', password);
        if (avatarFile) fd.append('profilePicture', avatarFile);

        const data = await API.post('/auth/register', fd, true);
        if (data.error) { errEl.innerText = data.error; return; }
        this._saveSession(data);
        UI.show('layer-menu');
    },

    _saveSession(data) {
        this.token = data.token;
        this.user  = data.user;
        localStorage.setItem('nd_token', data.token);
        localStorage.setItem('nd_user', JSON.stringify(data.user));
        // Restaurer le skin selon les skins d√©bloqu√©s
        const owned = data.user.unlockedSkins || [];
        const lastSkin = SKINS_CATALOG.filter(s => owned.includes(s.id)).pop();
        const equipped = StatsManager.data.equippedSkin;
        const equippedSkin = SKINS_CATALOG.find(s => s.color === equipped && owned.includes(s.id));
        if (equippedSkin) Game.player.color = equippedSkin.color;
        else if (lastSkin) Game.player.color = lastSkin.color;

        // Acc√®s devtools si compte dev
        if (DEV_USERS.includes(data.user.displayName?.toLowerCase())) {
            DevTools.openSidebar();
        }
        this._updateUI();
    },

    logout() {
        this.token = null;
        this.user  = null;
        localStorage.removeItem('nd_token');
        localStorage.removeItem('nd_user');
        this._updateUI();
        UI.show('layer-menu');
    },

    async refreshUser() {
        if (!this.token) return;
        const data = await API.get('/auth/me');
        if (data.error) { this.logout(); return; }
        this.user = data;
        localStorage.setItem('nd_user', JSON.stringify(data));
        this._updateUI();
    },

    _updateUI() {
        const u         = this.user;
        const tagName   = document.getElementById('user-tag-name');
        const tagAvatar = document.getElementById('user-tag-avatar');
        const hsEl      = document.getElementById('hs-val');

        if (u) {
            tagName.innerText = u.displayName;
            if (u.profilePicture) {
                tagAvatar.style.backgroundImage = `url(${u.profilePicture})`;
                tagAvatar.style.display = 'block';
            } else { tagAvatar.style.display = 'none'; }
            if (hsEl) hsEl.innerText = u.highScore;
        } else {
            tagName.innerText = 'Non connect√©';
            tagAvatar.style.display = 'none';
            if (hsEl) hsEl.innerText = StatsManager.data.highScore;
        }
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const UI = {
    show(id) {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        const el = document.getElementById(id);
        if (el) el.style.display = 'flex';

        if (id === 'layer-shop')    this.renderShop();
        if (id === 'layer-lead')    this.renderLead();
        if (id === 'layer-stats')   this.renderStats();
        if (id === 'layer-profile') this.renderProfile();
        if (id === 'layer-menu')    this.renderMenu();
        if (id === 'layer-auth')    Auth.switchTab('login');
    },

    renderMenu() {
        Auth._updateUI();
    },

    async renderShop() {
        const list   = document.getElementById('skin-list');
        const credEl = document.getElementById('shop-credits');
        list.innerHTML = '<p style="color:#888;font-size:11px;">Chargement...</p>';

        let unlockedIds = ['neon_blue'];
        if (Auth.token) {
            await Auth.refreshUser();
            credEl.innerText = Auth.user?.credits ?? 0;
            unlockedIds = Auth.user?.unlockedSkins ?? ['neon_blue'];
        } else {
            const localColors = StatsManager.data.unlockedSkins || ['#00f3ff'];
            unlockedIds = SKINS_CATALOG.filter(s => localColors.includes(s.color)).map(s => s.id);
            credEl.innerText = StatsManager.data.credits;
        }

        list.innerHTML = '';
        SKINS_CATALOG.forEach(s => {
            const owned    = unlockedIds.includes(s.id);
            const equipped = Game.player.color === s.color;
            const card = document.createElement('div');
            card.className = 'skin-card' + (owned ? ' skin-unlocked' : '');
            card.style.setProperty('--skin-color', s.color);
            const label    = equipped ? '‚úÖ √âQUIP√â' : owned ? '√âQUIPER' : (s.price === 0 ? 'GRATUIT' : s.price + ' cr');
            const btnClass = owned ? 'btn-equip' : 'btn-buy';
            card.innerHTML = `
                <div class="skin-preview" style="background:${s.color};box-shadow:0 0 18px ${s.color}66;"></div>
                <div class="skin-name">${s.name}</div>
                <div class="skin-price">${s.price === 0 ? 'GRATUIT' : s.price + ' cr√©dits'}</div>
                <button class="btn-skin-action ${btnClass}">${label}</button>`;
            card.querySelector('.btn-skin-action').addEventListener('click', async () => {
                if (owned) {
                    Game.player.color = s.color;
                    StatsManager.data.equippedSkin = s.color;
                    StatsManager.save();
                    this.renderShop();
                } else {
                    await this._buySkin(s);
                }
            });
            list.appendChild(card);
        });
    },

    async _buySkin(s) {
        if (!Auth.token) {
            if (StatsManager.data.credits >= s.price) {
                StatsManager.data.credits -= s.price;
                if (!StatsManager.data.unlockedSkins) StatsManager.data.unlockedSkins = ['#00f3ff'];
                StatsManager.data.unlockedSkins.push(s.color);
                Game.player.color = s.color;
                StatsManager.data.equippedSkin = s.color;
                StatsManager.save();
                alert('Skin d√©verrouill√© et √©quip√© !');
                this.renderShop();
            } else { alert('Pas assez de cr√©dits !'); }
            return;
        }
        const data = await API.post('/shop/buy', { skinId: s.id });
        if (data.error) { alert(data.error); return; }
        Auth.user.credits       = data.newCredits;
        Auth.user.unlockedSkins = data.unlockedSkins;
        localStorage.setItem('nd_user', JSON.stringify(Auth.user));
        Game.player.color = s.color;
        StatsManager.data.equippedSkin = s.color;
        StatsManager.save();
        alert(data.message);
        this.renderShop();
    },

    async renderLead() {
        const content = document.getElementById('leaderboard-content');
        content.innerHTML = '<p style="color:#ffffff44;font-size:11px;letter-spacing:3px;text-align:center">‚ü≥ CONNEXION AU R√âSEAU...</p>';

        const data = await API.get('/scores/leaderboard');
        if (data.error || !Array.isArray(data)) {
            content.innerHTML = '<p class="form-error">Impossible de charger le classement.</p>';
            return;
        }
        if (!data.length) {
            content.innerHTML = '<p style="color:#ffffff33;font-size:11px;letter-spacing:2px;text-align:center">// AUCUN SCORE ENREGISTR√â</p>';
            return;
        }
        content.innerHTML = data.map(e => `
            <div class="lead-row">
                <span class="lead-rank">${e.rank <= 3 ? ['ü•á','ü•à','ü•â'][e.rank-1] : e.rank}</span>
                <div class="lead-avatar" style="${e.avatar ? 'background-image:url('+e.avatar+')' : ''}">
                    ${!e.avatar ? e.displayName[0].toUpperCase() : ''}
                </div>
                <div class="lead-info">
                    <div class="lead-name">${e.displayName}</div>
                    <div class="lead-level">${e.level}</div>
                </div>
                <div class="lead-score">${e.score.toLocaleString()} pts</div>
            </div>`).join('');
    },

    renderStats() {
        const d  = StatsManager.data;
        const u  = Auth.user;
        const hs = u ? u.highScore : d.highScore;
        const cr = u ? u.credits   : d.credits;
        const skinCount = u
            ? (u.unlockedSkins?.length ?? 1)
            : (d.unlockedSkins?.length ?? 1);
        document.getElementById('stats-content').innerHTML = `
            <div class="stat-row"><span>Pseudo</span><span>${u ? u.displayName : d.username}</span></div>
            <div class="stat-row"><span>Meilleur score</span><span>${hs} pts</span></div>
            <div class="stat-row"><span>Cr√©dits</span><span>${cr}</span></div>
            <div class="stat-row"><span>Parties jou√©es</span><span>${d.gamesPlayed || 0}</span></div>
            <div class="stat-row"><span>Morts totales</span><span>${d.deathCount}</span></div>
            <div class="stat-row"><span>Temps de jeu</span><span>${StatsManager.getFormattedTime()}</span></div>
            <div class="stat-row"><span>Meilleur niveau</span><span>${d.bestLevel || 'TUTORIAL'}</span></div>
            <div class="stat-row"><span>Skins d√©bloqu√©s</span><span>${skinCount} / ${SKINS_CATALOG.length}</span></div>
        `;
    },

    renderProfile() {
        const connected = document.getElementById('profile-connected');
        const guest     = document.getElementById('profile-guest');
        const u = Auth.user;
        if (u) {
            connected.style.display = 'flex';
            guest.style.display     = 'none';
            const avatar   = document.getElementById('profile-avatar');
            const fallback = document.getElementById('profile-avatar-fallback');
            if (u.profilePicture) {
                avatar.src = u.profilePicture;
                avatar.style.display   = 'block';
                fallback.style.display = 'none';
            } else {
                avatar.style.display   = 'none';
                fallback.style.display = 'flex';
                fallback.innerText = u.displayName[0].toUpperCase();
            }
            document.getElementById('profile-username').innerText = u.displayName;
            document.getElementById('profile-credits').innerText  = u.credits;
            document.getElementById('profile-hs').innerText       = u.highScore;
            document.getElementById('profile-level').innerText    = u.highScoreLevel || 'TUTORIAL';
        } else {
            connected.style.display = 'none';
            guest.style.display     = 'flex';
        }
    },

    confirmQuit() { this.show('layer-confirm'); }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEV TOOLS ‚Äî Sidebar lat√©rale
//  Acc√®s : 5 clics sur le titre OU login avec compte dev/admin
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DevTools = {
    godMode: false,
    _clicks: 0,
    _clickTimer: null,

    titleClick() {
        this._clicks++;
        const hint = document.getElementById('dev-hint');
        hint.style.display = 'block';
        hint.innerText = `CLIQUEZ ENCORE... (${this._clicks}/5)`;
        clearTimeout(this._clickTimer);
        this._clickTimer = setTimeout(() => {
            this._clicks = 0;
            hint.style.display = 'none';
        }, 2000);
        if (this._clicks >= 5) {
            this._clicks = 0;
            hint.style.display = 'none';
            this.openSidebar();
        }
    },

    openSidebar() {
        this.refresh();
        document.getElementById('devtools-sidebar').classList.add('open');
        document.getElementById('devtools-overlay').classList.add('active');
    },

    closeSidebar() {
        document.getElementById('devtools-sidebar').classList.remove('open');
        document.getElementById('devtools-overlay').classList.remove('active');
    },

    refresh() {
        const d = StatsManager.data;
        const u = Auth.user;
        document.getElementById('dev-credits').value = u ? u.credits : d.credits;
        document.getElementById('dev-hs').value      = u ? u.highScore : d.highScore;
        document.getElementById('dev-score').value   = Game.running ? Game.score : 0;
        document.getElementById('btn-god').innerText = this.godMode ? 'MODE GOD : ON ‚úì' : 'MODE GOD : OFF';
        document.getElementById('dev-info').innerHTML =
            `User    : ${u ? u.displayName : d.username}<br>` +
            `Morts   : ${d.deathCount}<br>` +
            `Temps   : ${StatsManager.getFormattedTime()}<br>` +
            `Parties : ${d.gamesPlayed || 0}<br>` +
            `Auth    : ${Auth.token ? '‚úÖ JWT' : '‚ùå local'}`;
    },

    setCredits() {
        const v = parseInt(document.getElementById('dev-credits').value);
        if (isNaN(v)) return;
        StatsManager.data.credits = v; StatsManager.save();
        if (Auth.user) { Auth.user.credits = v; localStorage.setItem('nd_user', JSON.stringify(Auth.user)); }
        alert('Cr√©dits mis √† jour !'); this.refresh();
    },

    setHS() {
        const v = parseInt(document.getElementById('dev-hs').value);
        if (isNaN(v)) return;
        StatsManager.data.highScore = v; StatsManager.save();
        if (Auth.user) { Auth.user.highScore = v; localStorage.setItem('nd_user', JSON.stringify(Auth.user)); }
        alert('High score mis √† jour !'); this.refresh();
    },

    setScore() {
        const v = parseInt(document.getElementById('dev-score').value);
        if (!isNaN(v) && Game.running) { Game.score = v; alert('Score en jeu modifi√© !'); }
        else if (!Game.running) alert("Lance une partie d'abord !");
    },

    unlockAll() {
        const allColors = SKINS_CATALOG.map(s => s.color);
        const allIds    = SKINS_CATALOG.map(s => s.id);
        StatsManager.data.unlockedSkins = allColors; StatsManager.save();
        if (Auth.user) { Auth.user.unlockedSkins = allIds; localStorage.setItem('nd_user', JSON.stringify(Auth.user)); }
        alert('Tous les skins d√©bloqu√©s !');
    },

    toggleGod() {
        this.godMode = !this.godMode;
        document.getElementById('btn-god').innerText = this.godMode ? 'MODE GOD : ON ‚úì' : 'MODE GOD : OFF';
    },

    reset() {
        if (!confirm('Vraiment tout r√©initialiser ?')) return;
        StatsManager.reset();
        this.godMode = false;
        Auth.logout();
        this.refresh();
        alert('Donn√©es r√©initialis√©es.');
        this.closeSidebar();
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOTEUR DE JEU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Game = {
    canvas: document.getElementById('gameCanvas'),
    ctx: null,
    running: false,
    paused: false,
    score: 0,
    player: { x: 0, y: 0, color: '#00f3ff' },
    enemies: [],
    currentLevelName: '',
    burstTimer: 0,
    glitchTimer: 0,
    timeTimer: 0,
    bgParticles: [],
    animFrame: null,

    init() {
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        StatsManager.init();

        if (StatsManager.data.equippedSkin) this.player.color = StatsManager.data.equippedSkin;

        for (let i = 0; i < 80; i++) {
            this.bgParticles.push({
                x: Math.random() * window.innerWidth,
                y: Math.random() * window.innerHeight,
                size: Math.random() * 1.5 + 0.3,
                speed: Math.random() * 0.4 + 0.1
            });
        }

        window.addEventListener('resize', () => this.resize());
        window.addEventListener('keydown', (e) => {
            if ((e.key === 'Escape' || e.key === 'p' || e.key === 'P') && this.running) this.togglePause();
        });
        this.canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            this.player.x = e.touches[0].clientX - 15;
        }, { passive: false });

        Auth._updateUI();
    },

    resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },

    start() {
        if (this.animFrame) cancelAnimationFrame(this.animFrame);
        this.running = true; this.paused = false; this.score = 0;
        this.enemies = []; this.burstTimer = 0; this.glitchTimer = 0;
        this.timeTimer = 0; this.currentLevelName = '';
        this.player.x = this.canvas.width / 2 - 15;
        this.player.y = this.canvas.height - 80;

        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.getElementById('layer-game').style.display = 'block';
        document.getElementById('pause-menu').style.display = 'none';

        StatsManager.data.gamesPlayed = (StatsManager.data.gamesPlayed || 0) + 1;
        StatsManager.save();

        window.onmousemove = (ev) => { this.player.x = ev.clientX - 15; };
        this.loop();
    },

    async stop() {
        if (!this.running) return;
        this.running = false; this.paused = false;
        window.onmousemove = null;
        if (this.animFrame) cancelAnimationFrame(this.animFrame);

        const finalScore = this.score;
        const lvl        = LevelSystem.getCurrentLevel(finalScore);
        const lvlName    = lvl.name;

        // Stats locales
        StatsManager.data.deathCount++;
        const isNewLocal = finalScore > StatsManager.data.highScore;
        if (isNewLocal) { StatsManager.data.highScore = finalScore; StatsManager.data.bestLevel = lvlName; }
        StatsManager.save();

        let creditsEarned = Math.floor(finalScore / 10);
        let isNewHs = isNewLocal;

        if (Auth.token) {
            const res = await API.post('/scores/submit', { score: finalScore, level: lvlName });
            if (!res.error) {
                creditsEarned = res.creditsEarned;
                isNewHs = res.isNewHighScore;
                Auth.user.credits   = res.newCredits;
                Auth.user.highScore = res.highScore;
                if (isNewHs) Auth.user.highScoreLevel = lvlName;
                localStorage.setItem('nd_user', JSON.stringify(Auth.user));
            }
        } else {
            StatsManager.data.credits += creditsEarned;
            StatsManager.save();
        }

        document.getElementById('layer-game').style.display  = 'none';
        document.getElementById('layer-death').style.display = 'flex';
        document.getElementById('death-stats').innerHTML = `
            <div class="stat-row"><span>Score</span><span>${finalScore} pts</span></div>
            <div class="stat-row"><span>Niveau atteint</span><span>${lvlName}</span></div>
            <div class="stat-row"><span>Cr√©dits gagn√©s</span><span>+${creditsEarned}</span></div>
            ${isNewHs ? '<p class="new-record">üèÜ NOUVEAU RECORD !</p>' : ''}
        `;
    },

    quit() {
        if (this.running) {
            StatsManager.data.credits += Math.floor(this.score / 10);
            if (this.score > StatsManager.data.highScore) StatsManager.data.highScore = this.score;
            StatsManager.save();
        }
        this.running = false; this.paused = false;
        if (this.animFrame) cancelAnimationFrame(this.animFrame);
        window.onmousemove = null;
        document.getElementById('layer-game').style.display  = 'none';
        document.getElementById('pause-menu').style.display  = 'none';
        UI.show('layer-menu');
    },

    togglePause() {
        if (!this.running && !this.paused) return;
        this.paused = !this.paused;
        document.getElementById('pause-menu').style.display = this.paused ? 'flex' : 'none';
        document.getElementById('btn-pause').innerText = this.paused ? '‚ñ∂' : '‚è∏';
        document.getElementById('pause-score-info').innerText = `Score actuel : ${this.score} pts`;
        if (!this.paused) this.loop();
    },

    loop() {
        if (!this.running || this.paused) return;
        this.update(); this.draw();
        this.animFrame = requestAnimationFrame(() => this.loop());
    },

    update() {
        const lvl = LevelSystem.getCurrentLevel(this.score);

        if (lvl.name !== this.currentLevelName) {
            this.currentLevelName = lvl.name;
            document.getElementById('ui-level-name').innerText       = lvl.name;
            document.getElementById('ui-level-name').style.color     = lvl.color || '#00f3ff';
            document.getElementById('ui-level-desc').innerText       = lvl.description || '';
            document.getElementById('ui-tier').innerText             = LevelSystem.getTierName(this.score);
            this._announceLevel(lvl.name, lvl.color, lvl.description);
            if (this.score > 0) StatsManager.data.bestLevel = lvl.name;
        }

        const next = LevelSystem.getNextLevel(this.score);
        if (next) {
            const pct = Math.min(100, ((this.score - lvl.scoreReq) / (next.scoreReq - lvl.scoreReq)) * 100);
            document.getElementById('next-level-fill').style.width      = pct + '%';
            document.getElementById('next-level-fill').style.background = lvl.color || '#00f3ff';
            document.getElementById('next-level-label').innerText = `‚Üí ${next.name} dans ${next.scoreReq - this.score} pts`;
        } else {
            document.getElementById('next-level-fill').style.width = '100%';
            document.getElementById('next-level-label').innerText  = '‚àû MAX NIVEAU';
        }

        if (Math.random() < lvl.rate) this._spawnEnemy(lvl);

        if (lvl.burst) {
            this.burstTimer++;
            if (this.burstTimer >= 90) {
                this.burstTimer = 0;
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => { if (this.running && !this.paused) this._spawnEnemy(lvl); }, i * 80);
                }
            }
        }

        if (lvl.glitch) {
            this.glitchTimer++;
            if (this.glitchTimer >= 160) {
                this.glitchTimer = 0;
                this.canvas.style.filter = `hue-rotate(${Math.random()*360}deg) brightness(2)`;
                setTimeout(() => { this.canvas.style.filter = ''; }, 120);
                for (let a = 0; a < 6; a++) {
                    const angle = (a / 6) * Math.PI * 2;
                    const e = this._createEnemy(lvl);
                    e.x  = this.canvas.width / 2 + Math.cos(angle) * 250;
                    e.y  = -30;
                    e.vx = Math.cos(angle) * 2;
                    this.enemies.push(e);
                }
            }
        }

        this.timeTimer++;
        if (this.timeTimer >= 60) { this.timeTimer = 0; StatsManager.incrementTime(); }

        const W = this.canvas.width, H = this.canvas.height;
        this.bgParticles.forEach(p => { p.y += p.speed; if (p.y > H) { p.y = 0; p.x = Math.random() * W; } });

        for (let i = this.enemies.length - 1; i >= 0; i--) {
            const e = this.enemies[i];
            if (e.tracker) {
                const dx = (this.player.x + 15) - (e.x + 12);
                const dy = (this.player.y + 15) - (e.y + 12);
                const d  = Math.hypot(dx, dy) || 1;
                e.x += (dx / d) * e.trackSpeed;
                e.y += (dy / d) * e.trackSpeed;
            } else {
                if (e.zigzag) e.x += Math.sin(e.y * 0.05 + e.phase) * 3;
                e.x += e.vx || 0;
                e.y += e.speed;
            }

            if (!DevTools.godMode) {
                if (Math.hypot(this.player.x + 15 - (e.x + 12), this.player.y + 15 - (e.y + 12)) < 26) {
                    this.stop(); return;
                }
            }

            if (e.y > this.canvas.height + 60 || e.x < -100 || e.x > this.canvas.width + 100) {
                this.enemies.splice(i, 1);
                this.score += 10;
            }
        }
        document.getElementById('ui-score').innerText = this.score;
    },

    _createEnemy(lvl) {
        return {
            x: Math.random() * this.canvas.width, y: -50,
            speed:      lvl.speed + (Math.random() * 2 - 1),
            tracker:    lvl.tracker && Math.random() < 0.4,
            trackSpeed: lvl.speed * 0.35,
            zigzag:     lvl.zigzag && Math.random() < 0.5,
            phase:      Math.random() * Math.PI * 2,
            color:      lvl.color || '#ff3838',
            vx: 0,
            size: 20 + Math.random() * 10
        };
    },

    _spawnEnemy(lvl) { this.enemies.push(this._createEnemy(lvl)); },

    _announceLevel(name, color, desc) {
        const el = document.getElementById('level-announce');
        el.style.color = color || '#00f3ff';
        el.style.opacity = '1';
        el.style.transform = 'scale(1.2)';
        el.innerHTML = name + (desc ? `<div class="announce-sub">${desc}</div>` : '');
        clearTimeout(this._announceTO);
        this._announceTO = setTimeout(() => {
            el.style.opacity = '0'; el.style.transform = 'scale(1)';
        }, 2200);
    },

    draw() {
        const lvl = LevelSystem.getCurrentLevel(this.score);
        const C   = this.ctx;

        C.fillStyle = lvl.bgColor || '#050505';
        C.fillRect(0, 0, this.canvas.width, this.canvas.height);

        C.shadowBlur = 0;
        this.bgParticles.forEach(p => {
            C.fillStyle = (lvl.color || '#00f3ff') + '18';
            C.beginPath(); C.arc(p.x, p.y, p.size, 0, Math.PI * 2); C.fill();
        });

        C.shadowBlur = 20; C.shadowColor = this.player.color; C.fillStyle = this.player.color;
        C.fillRect(this.player.x, this.player.y, 30, 30);
        C.fillStyle = '#ffffff55';
        C.fillRect(this.player.x + 6, this.player.y + 6, 10, 10);

        if (DevTools.godMode) {
            C.strokeStyle = '#ffcc00'; C.lineWidth = 2;
            C.shadowColor = '#ffcc00'; C.shadowBlur = 10;
            C.strokeRect(this.player.x - 4, this.player.y - 4, 38, 38);
        }

        this.enemies.forEach(e => {
            const c = e.color || '#ff3838';
            C.shadowBlur = 14; C.shadowColor = c; C.fillStyle = c;
            C.fillRect(e.x, e.y, e.size, e.size);
            if (e.tracker) {
                C.strokeStyle = '#ffffff88'; C.lineWidth = 1;
                C.strokeRect(e.x - 3, e.y - 3, e.size + 6, e.size + 6);
            }
        });
        C.shadowBlur = 0;
    }
};

window.onload = () => Game.init();
</script>
</body>
</html>
