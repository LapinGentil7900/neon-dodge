<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON DODGE - PRO NETWORK</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  MENU PRINCIPAL                               -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-menu" class="screen">
    <div id="user-tag">Non connectÃ©</div>
    <h1 class="neon-title">NEON DODGE</h1>
    <p id="menu-highscore">MEILLEUR SCORE : <span id="hs-val">0</span></p>

    <div class="menu-grid">
        <button class="btn"          onclick="Game.start()">JOUER</button>
        <button class="btn btn-blue" onclick="UI.show('layer-shop')">BOUTIQUE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-lead')">CLASSEMENT</button>
        <button class="btn btn-blue" onclick="UI.show('layer-auth')">COMPTE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-stats')">STATISTIQUES</button>
        <button class="btn btn-red"  onclick="UI.confirmQuit()">QUITTER</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  BOUTIQUE DE SKINS                            -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-shop" class="screen" style="display:none;">
    <h2>BOUTIQUE DE SKINS</h2>
    <p>CRÃ‰DITS : <span id="shop-credits">0</span></p>
    <div id="skin-list"></div>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  CLASSEMENT                                   -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-lead" class="screen" style="display:none;">
    <h2>TOP JOUEURS</h2>
    <div id="leaderboard-content"></div>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  CONNEXION / INSCRIPTION                      -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-auth" class="screen" style="display:none;">
    <h2 id="auth-title">CONNEXION</h2>
    <input type="text"     id="auth-user" placeholder="Pseudo (min. 3 caractÃ¨res)">
    <input type="password" id="auth-pass" placeholder="Mot de passe (min. 4 car.)">
    <div class="auth-tabs">
        <button class="btn"         id="btn-login"    onclick="Auth.login()">SE CONNECTER</button>
        <button class="btn btn-blue" id="btn-register" onclick="Auth.register()">S'INSCRIRE</button>
    </div>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
    <p id="auth-msg"></p>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  STATISTIQUES                                 -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-stats" class="screen" style="display:none;">
    <h2>STATISTIQUES</h2>
    <div id="stats-content"></div>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  DEV TOOLS (visible seulement si dev/admin)   -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-devtools" class="screen" style="display:none;">
    <h2 class="dev-title">âš™ DEV TOOLS âš™</h2>
    <div class="dev-panel">
        <div class="dev-row">
            <label>CRÃ‰DITS</label>
            <input type="number" id="dev-credits" value="0">
            <button class="btn btn-blue" onclick="DevTools.setCredits()">SET</button>
        </div>
        <div class="dev-row">
            <label>HIGH SCORE</label>
            <input type="number" id="dev-hs" value="0">
            <button class="btn btn-blue" onclick="DevTools.setHS()">SET</button>
        </div>
        <div class="dev-row">
            <label>SPAWN SCORE</label>
            <input type="number" id="dev-score" value="0">
            <button class="btn btn-blue" onclick="DevTools.setScore()">SET (en jeu)</button>
        </div>
        <div class="dev-row">
            <label>DÃ‰BLOQUER SKINS</label>
            <button class="btn btn-blue" onclick="DevTools.unlockAll()">TOUT DÃ‰VERROUILLER</button>
        </div>
        <div class="dev-row">
            <label>INVINCIBILITÃ‰</label>
            <button class="btn btn-blue" id="btn-god" onclick="DevTools.toggleGod()">OFF</button>
        </div>
        <div class="dev-row">
            <label>RESET DONNÃ‰ES</label>
            <button class="btn btn-red" onclick="DevTools.reset()">RESET COMPLET</button>
        </div>
        <div id="dev-info"></div>
    </div>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  Ã‰CRAN DE JEU                                 -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-game" style="display:none; position:relative; width:100%; height:100%;">
    <canvas id="gameCanvas"></canvas>

    <!-- HUD principal -->
    <div id="hud">
        <div id="score-container">SCORE: <span id="ui-score">0</span></div>
        <div id="level-hud">
            <span id="ui-level-name">TUTORIAL</span>
            <span id="ui-level-desc"></span>
        </div>
        <div id="ui-tier"></div>
        <div id="next-level-bar">
            <div id="next-level-fill"></div>
        </div>
        <div id="next-level-label"></div>
    </div>

    <!-- Bouton pause -->
    <button id="btn-pause" onclick="Game.togglePause()">â¸</button>

    <!-- Annonce de niveau -->
    <div id="level-announce"></div>

    <!-- Menu PAUSE -->
    <div id="pause-menu" style="display:none;">
        <h2>EN PAUSE</h2>
        <p id="pause-score-info"></p>
        <button class="btn"         onclick="Game.togglePause()">REPRENDRE</button>
        <button class="btn btn-red" onclick="Game.quit()">QUITTER LA PARTIE</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  Ã‰CRAN DE MORT / GAME OVER                    -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-death" class="screen" style="display:none;">
    <h2 class="death-title">GAME OVER</h2>
    <div id="death-stats"></div>
    <button class="btn"          onclick="Game.start()">REJOUER</button>
    <button class="btn btn-blue" onclick="UI.show('layer-menu')">MENU</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  CONFIRM QUIT                                 -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layer-confirm" class="screen" style="display:none;">
    <h2>QUITTER ?</h2>
    <p>Voulez-vous vraiment fermer le jeu ?</p>
    <button class="btn btn-red"  onclick="window.close()">OUI, QUITTER</button>
    <button class="btn btn-blue" onclick="UI.show('layer-menu')">ANNULER</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  SCRIPTS                                      -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="levels.js"></script>
<script src="stats_manager.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH â€” Connexion & Inscription sÃ©parÃ©es
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEV_USERS = ["dev", "admin", "root", "devmode"];

const Auth = {
    currentUser: null,
    accounts: JSON.parse(localStorage.getItem('neon_accounts') || '{}'),

    saveAccounts() {
        localStorage.setItem('neon_accounts', JSON.stringify(this.accounts));
    },

    _validate() {
        const user = document.getElementById('auth-user').value.trim();
        const pass = document.getElementById('auth-pass').value.trim();
        const msg  = document.getElementById('auth-msg');
        msg.style.color = '#ff3838';
        if (user.length < 3) { msg.innerText = "Pseudo trop court (min. 3 car.)"; return null; }
        if (pass.length < 4) { msg.innerText = "Mot de passe trop court (min. 4 car.)"; return null; }
        return { user, pass };
    },

    login() {
        const v = this._validate(); if (!v) return;
        const { user, pass } = v;
        const msg = document.getElementById('auth-msg');
        if (!this.accounts[user]) {
            msg.innerText = "Compte introuvable. Inscrivez-vous d'abord.";
            return;
        }
        if (this.accounts[user] !== pass) {
            msg.innerText = "Mot de passe incorrect.";
            return;
        }
        this._connectUser(user);
    },

    register() {
        const v = this._validate(); if (!v) return;
        const { user, pass } = v;
        const msg = document.getElementById('auth-msg');
        if (this.accounts[user]) {
            msg.innerText = "Ce pseudo est dÃ©jÃ  pris.";
            return;
        }
        this.accounts[user] = pass;
        this.saveAccounts();
        msg.style.color = '#00ff88';
        msg.innerText = "Compte crÃ©Ã© ! Connexion...";
        setTimeout(() => this._connectUser(user), 800);
    },

    // Ancienne mÃ©thode originale conservÃ©e
    sign() {
        const user = document.getElementById('auth-user').value.trim();
        if (user.length < 3) return alert("Pseudo trop court");
        this._connectUser(user);
    },

    _connectUser(user) {
        this.currentUser = user;
        document.getElementById('user-tag').innerText = "ConnectÃ©: " + user;
        StatsManager.data.username = user;
        StatsManager.save();

        // AccÃ¨s dev tools si compte dev/admin
        if (DEV_USERS.includes(user.toLowerCase())) {
            document.getElementById('btn-devtools') && 
                (document.getElementById('btn-devtools').style.display = 'block');
        }
        UI.show('layer-menu');
    },

    logout() {
        this.currentUser = null;
        document.getElementById('user-tag').innerText = "Non connectÃ©";
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const UI = {
    show(id) {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        const el = document.getElementById(id);
        if (el) el.style.display = 'flex';

        if (id === 'layer-shop')  this.renderShop();
        if (id === 'layer-lead')  this.renderLead();
        if (id === 'layer-stats') this.renderStats();
        if (id === 'layer-menu')  this.renderMenu();
        if (id === 'layer-devtools') DevTools.refresh();
        if (id === 'layer-auth') {
            document.getElementById('auth-msg').innerText = '';
        }
    },

    renderMenu() {
        document.getElementById('hs-val').innerText = StatsManager.data.highScore;
        // Afficher btn devtools si user dev
        const devBtn = document.getElementById('btn-devtools');
        if (devBtn) {
            devBtn.style.display = Auth.currentUser && DEV_USERS.includes(Auth.currentUser.toLowerCase())
                ? 'block' : 'none';
        }
    },

    renderShop() {
        const list = document.getElementById('skin-list');
        list.innerHTML = "";
        const skins = [
            { name: "Neon Blue",  color: "#00f3ff", price: 0     },
            { name: "Emerald",    color: "#00ff88", price: 500    },
            { name: "Ruby",       color: "#ff3838", price: 1500   },
            { name: "Gold",       color: "#ffcc00", price: 3000   },
            { name: "Violet",     color: "#cc00ff", price: 5000   },
            { name: "White",      color: "#ffffff", price: 8000   },
            { name: "Inferno",    color: "#ff4400", price: 12000  },
            { name: "Ghost",      color: "#aaaaaa", price: 20000  }
        ];
        document.getElementById('shop-credits').innerText = StatsManager.data.credits;
        const unlocked = StatsManager.data.unlockedSkins || ["#00f3ff"];

        skins.forEach(s => {
            const btn = document.createElement('button');
            btn.className = "btn-skin";
            btn.style.borderColor = s.color;
            btn.style.color = s.color;

            const owned    = unlocked.includes(s.color);
            const equipped = StatsManager.data.equippedSkin === s.color;
            const label    = equipped ? "Ã‰QUIPÃ‰" : owned ? "Ã‰QUIPER" : (s.price === 0 ? "GRATUIT" : s.price + " cr");

            btn.innerHTML = `<span style="font-size:18px;display:block;margin-bottom:4px">â– </span>${s.name}<br><small>${label}</small>`;

            btn.onclick = () => {
                if (owned) {
                    Game.player.color = s.color;
                    StatsManager.data.equippedSkin = s.color;
                    StatsManager.save();
                    this.renderShop();
                } else if (StatsManager.data.credits >= s.price) {
                    StatsManager.data.credits -= s.price;
                    if (!StatsManager.data.unlockedSkins) StatsManager.data.unlockedSkins = ["#00f3ff"];
                    StatsManager.data.unlockedSkins.push(s.color);
                    Game.player.color = s.color;
                    StatsManager.data.equippedSkin = s.color;
                    StatsManager.save();
                    alert("Skin dÃ©verrouillÃ© et Ã©quipÃ© !");
                    this.renderShop();
                } else {
                    alert("Pas assez de crÃ©dits !");
                }
            };
            list.appendChild(btn);
        });
    },

    renderLead() {
        const content = document.getElementById('leaderboard-content');
        // Classement local (plusieurs comptes possibles)
        const scores = JSON.parse(localStorage.getItem('neon_scores') || '[]');
        if (!scores.length) {
            scores.push({ user: Auth.currentUser || 'Joueur', score: StatsManager.data.highScore });
        }
        scores.sort((a, b) => b.score - a.score);
        content.innerHTML = scores.slice(0, 10).map((s, i) =>
            `<div class="lead-row">
                <span class="lead-rank">${i+1}.</span>
                <span class="lead-user">${s.user}</span>
                <span class="lead-score">${s.score} pts</span>
            </div>`
        ).join('');
    },

    renderStats() {
        const d = StatsManager.data;
        document.getElementById('stats-content').innerHTML = `
            <div class="stat-row"><span>Pseudo</span><span>${d.username}</span></div>
            <div class="stat-row"><span>Meilleur score</span><span>${d.highScore} pts</span></div>
            <div class="stat-row"><span>CrÃ©dits</span><span>${d.credits}</span></div>
            <div class="stat-row"><span>Parties jouÃ©es</span><span>${d.gamesPlayed || 0}</span></div>
            <div class="stat-row"><span>Morts totales</span><span>${d.deathCount}</span></div>
            <div class="stat-row"><span>Temps de jeu</span><span>${StatsManager.getFormattedTime()}</span></div>
            <div class="stat-row"><span>Meilleur niveau atteint</span><span>${d.bestLevel || 'TUTORIAL'}</span></div>
            <div class="stat-row"><span>Skins dÃ©bloquÃ©s</span><span>${(d.unlockedSkins||[]).length} / 8</span></div>
        `;
    },

    confirmQuit() {
        this.show('layer-confirm');
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEV TOOLS (accÃ¨s rÃ©servÃ© aux comptes dev/admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DevTools = {
    godMode: false,

    refresh() {
        document.getElementById('dev-credits').value = StatsManager.data.credits;
        document.getElementById('dev-hs').value      = StatsManager.data.highScore;
        document.getElementById('dev-score').value   = 0;
        document.getElementById('btn-god').innerText = this.godMode ? 'ON âœ“' : 'OFF';
        document.getElementById('dev-info').innerHTML = `
            <div class="dev-info-block">
                Username : ${StatsManager.data.username}<br>
                Morts    : ${StatsManager.data.deathCount}<br>
                Temps    : ${StatsManager.getFormattedTime()}<br>
                Parties  : ${StatsManager.data.gamesPlayed || 0}
            </div>`;
    },

    setCredits() {
        const v = parseInt(document.getElementById('dev-credits').value);
        if (!isNaN(v)) { StatsManager.data.credits = v; StatsManager.save(); alert("CrÃ©dits mis Ã  jour !"); }
    },

    setHS() {
        const v = parseInt(document.getElementById('dev-hs').value);
        if (!isNaN(v)) { StatsManager.data.highScore = v; StatsManager.save(); alert("High score mis Ã  jour !"); }
    },

    setScore() {
        const v = parseInt(document.getElementById('dev-score').value);
        if (!isNaN(v) && Game.running) { Game.score = v; alert("Score en jeu modifiÃ© !"); }
        else if (!Game.running) alert("Lance une partie d'abord !");
    },

    unlockAll() {
        const skins = ["#00f3ff","#00ff88","#ff3838","#ffcc00","#cc00ff","#ffffff","#ff4400","#aaaaaa"];
        StatsManager.data.unlockedSkins = skins;
        StatsManager.save();
        alert("Tous les skins dÃ©bloquÃ©s !");
    },

    toggleGod() {
        this.godMode = !this.godMode;
        document.getElementById('btn-god').innerText = this.godMode ? 'ON âœ“' : 'OFF';
    },

    reset() {
        if (confirm("Vraiment tout rÃ©initialiser ?")) {
            StatsManager.reset();
            this.godMode = false;
            this.refresh();
            alert("DonnÃ©es rÃ©initialisÃ©es.");
        }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOTEUR DE JEU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Game = {
    canvas: document.getElementById('gameCanvas'),
    ctx: null,
    running: false,
    paused: false,
    score: 0,
    player: { x: 0, y: 0, color: '#00f3ff' },
    enemies: [],
    currentLevelName: '',
    burstTimer: 0,
    glitchTimer: 0,
    timeTimer: 0,
    bgParticles: [],

    init() {
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        StatsManager.init();

        // Restaurer skin Ã©quipÃ©
        if (StatsManager.data.equippedSkin) {
            this.player.color = StatsManager.data.equippedSkin;
        }

        // Init particules de fond
        for (let i = 0; i < 80; i++) {
            this.bgParticles.push({
                x: Math.random() * window.innerWidth,
                y: Math.random() * window.innerHeight,
                size: Math.random() * 1.5 + 0.3,
                speed: Math.random() * 0.4 + 0.1,
                opacity: Math.random() * 0.5 + 0.1
            });
        }

        window.addEventListener('resize', () => this.resize());

        // Touches clavier : ESC = pause, P = pause
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.key === 'p' || e.key === 'P') {
                if (this.running) this.togglePause();
            }
        });

        // ContrÃ´le tactile
        this.canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            this.player.x = e.touches[0].clientX - 15;
        }, { passive: false });

        UI.renderMenu();
    },

    resize() {
        this.canvas.width  = window.innerWidth;
        this.canvas.height = window.innerHeight;
    },

    start() {
        this.running = true;
        this.paused  = false;
        this.score   = 0;
        this.enemies = [];
        this.burstTimer = 0;
        this.glitchTimer = 0;
        this.timeTimer  = 0;
        this.currentLevelName = '';

        this.player.x = this.canvas.width / 2 - 15;
        this.player.y = this.canvas.height - 80;

        // Masquer tous les Ã©crans
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.getElementById('layer-game').style.display = 'block';
        document.getElementById('pause-menu').style.display = 'none';

        this.loop();
    },

    stop() {
        if (!this.running) return;
        this.running = false;
        this.paused  = false;

        // CrÃ©dits gagnÃ©s
        StatsManager.data.credits += Math.floor(this.score / 10);

        // High score
        const isNew = this.score > StatsManager.data.highScore;
        if (isNew) StatsManager.data.highScore = this.score;

        // Meilleur niveau
        const lvl = LevelSystem.getCurrentLevel(this.score);
        if (!StatsManager.data.bestLevel || this.score > (StatsManager.data.highScore - 1)) {
            StatsManager.data.bestLevel = lvl.name;
        }

        StatsManager.recordDeath();

        // Sauvegarder dans le classement local
        const scores = JSON.parse(localStorage.getItem('neon_scores') || '[]');
        scores.push({ user: Auth.currentUser || StatsManager.data.username, score: this.score });
        scores.sort((a, b) => b.score - a.score);
        localStorage.setItem('neon_scores', JSON.stringify(scores.slice(0, 50)));

        // Afficher Ã©cran de mort
        document.getElementById('layer-game').style.display = 'none';
        document.getElementById('layer-death').style.display = 'flex';
        document.getElementById('death-stats').innerHTML = `
            <div class="stat-row"><span>Score</span><span>${this.score} pts</span></div>
            <div class="stat-row"><span>Niveau atteint</span><span>${lvl.name}</span></div>
            <div class="stat-row"><span>CrÃ©dits gagnÃ©s</span><span>+${Math.floor(this.score/10)}</span></div>
            ${isNew ? '<p class="new-record">ğŸ† NOUVEAU RECORD !</p>' : ''}
        `;
    },

    quit() {
        this.running = false;
        this.paused  = false;
        StatsManager.data.credits += Math.floor(this.score / 10);
        if (this.score > StatsManager.data.highScore) StatsManager.data.highScore = this.score;
        StatsManager.save();
        document.getElementById('layer-game').style.display = 'none';
        document.getElementById('pause-menu').style.display = 'none';
        UI.show('layer-menu');
    },

    togglePause() {
        if (!this.running && !this.paused) return;
        this.paused = !this.paused;
        const pm = document.getElementById('pause-menu');
        pm.style.display = this.paused ? 'flex' : 'none';
        document.getElementById('btn-pause').innerText = this.paused ? 'â–¶' : 'â¸';
        document.getElementById('pause-score-info').innerText = `Score actuel : ${this.score} pts`;
        if (!this.paused) this.loop();
    },

    loop() {
        if (!this.running || this.paused) return;
        this.update();
        this.draw();
        requestAnimationFrame(() => this.loop());
    },

    update() {
        const lvl = LevelSystem.getCurrentLevel(this.score);

        // â”€â”€ Changement de niveau
        if (lvl.name !== this.currentLevelName) {
            this.currentLevelName = lvl.name;
            document.getElementById('ui-level-name').innerText = lvl.name;
            document.getElementById('ui-level-name').style.color = lvl.color || '#00f3ff';
            document.getElementById('ui-level-desc').innerText = lvl.description || '';
            document.getElementById('ui-tier').innerText = LevelSystem.getTierName(this.score);
            this._announceLevel(lvl.name, lvl.color, lvl.description);
            if (this.score > 0) StatsManager.data.bestLevel = lvl.name;
        }

        // â”€â”€ Barre de progression
        const next = LevelSystem.getNextLevel(this.score);
        if (next) {
            const pct = Math.min(100, ((this.score - lvl.scoreReq) / (next.scoreReq - lvl.scoreReq)) * 100);
            document.getElementById('next-level-fill').style.width = pct + '%';
            document.getElementById('next-level-fill').style.background = lvl.color || '#00f3ff';
            document.getElementById('next-level-label').innerText = `â†’ ${next.name} dans ${next.scoreReq - this.score} pts`;
        } else {
            document.getElementById('next-level-fill').style.width = '100%';
            document.getElementById('next-level-label').innerText = 'âˆ MAX NIVEAU';
        }

        // â”€â”€ Spawn standard
        if (Math.random() < lvl.rate) this._spawnEnemy(lvl);

        // â”€â”€ Mode Burst (volÃ©e de 5)
        if (lvl.burst) {
            this.burstTimer++;
            if (this.burstTimer >= 90) {
                this.burstTimer = 0;
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => { if (this.running && !this.paused) this._spawnEnemy(lvl); }, i * 80);
                }
            }
        }

        // â”€â”€ Mode Glitch (flash + apparition en cercle)
        if (lvl.glitch) {
            this.glitchTimer++;
            if (this.glitchTimer >= 160) {
                this.glitchTimer = 0;
                this.canvas.style.filter = `hue-rotate(${Math.random()*360}deg) brightness(2)`;
                setTimeout(() => { this.canvas.style.filter = ''; }, 120);
                for (let a = 0; a < 6; a++) {
                    const angle = (a / 6) * Math.PI * 2;
                    const e = this._createEnemy(lvl);
                    e.x  = this.canvas.width / 2 + Math.cos(angle) * 250;
                    e.y  = -30;
                    e.vx = Math.cos(angle) * 2;
                    this.enemies.push(e);
                }
            }
        }

        // â”€â”€ Timer temps de jeu (chaque ~60 frames â‰ˆ 1s)
        this.timeTimer++;
        if (this.timeTimer >= 60) { this.timeTimer = 0; StatsManager.incrementTime(); }

        // â”€â”€ DÃ©placement & collision ennemis
        for (let i = this.enemies.length - 1; i >= 0; i--) {
            const e = this.enemies[i];

            if (e.tracker) {
                const dx = (this.player.x + 15) - (e.x + 12);
                const dy = (this.player.y + 15) - (e.y + 12);
                const d  = Math.hypot(dx, dy) || 1;
                e.x += (dx / d) * e.trackSpeed;
                e.y += (dy / d) * e.trackSpeed;
            } else {
                if (e.zigzag) e.x += Math.sin(e.y * 0.05 + e.phase) * 3;
                e.x += e.vx || 0;
                e.y += e.speed;
            }

            // Collision (sauf god mode)
            if (!DevTools.godMode) {
                if (Math.hypot(this.player.x + 15 - (e.x + 12), this.player.y + 15 - (e.y + 12)) < 26) {
                    this.stop(); return;
                }
            }

            // Sortie d'Ã©cran
            if (e.y > this.canvas.height + 60 || e.x < -100 || e.x > this.canvas.width + 100) {
                this.enemies.splice(i, 1);
                this.score += 10;
            }
        }

        // â”€â”€ ContrÃ´le souris
        window.onmousemove = (ev) => { this.player.x = ev.clientX - 15; };

        // â”€â”€ Score display
        document.getElementById('ui-score').innerText = this.score;

        // â”€â”€ Particules de fond
        const W = this.canvas.width, H = this.canvas.height;
        this.bgParticles.forEach(p => { p.y += p.speed; if (p.y > H) { p.y = 0; p.x = Math.random() * W; } });
    },

    _createEnemy(lvl) {
        return {
            x: Math.random() * this.canvas.width,
            y: -50,
            speed: lvl.speed + (Math.random() * 2 - 1),
            tracker: lvl.tracker && Math.random() < 0.4,
            trackSpeed: lvl.speed * 0.35,
            zigzag: lvl.zigzag && Math.random() < 0.5,
            phase: Math.random() * Math.PI * 2,
            color: lvl.color || '#ff3838',
            vx: 0,
            size: 20 + Math.random() * 10
        };
    },

    _spawnEnemy(lvl) {
        this.enemies.push(this._createEnemy(lvl));
    },

    _announceLevel(name, color, desc) {
        const el = document.getElementById('level-announce');
        el.style.color   = color || '#00f3ff';
        el.style.opacity = '1';
        el.style.transform = 'scale(1.2)';
        el.innerHTML = name + (desc ? `<div class="announce-sub">${desc}</div>` : '');
        clearTimeout(this._announceTO);
        this._announceTO = setTimeout(() => {
            el.style.opacity   = '0';
            el.style.transform = 'scale(1)';
        }, 2200);
    },

    draw() {
        const lvl = LevelSystem.getCurrentLevel(this.score);
        const C   = this.ctx;

        // Fond
        C.fillStyle = lvl.bgColor || '#050505';
        C.fillRect(0, 0, this.canvas.width, this.canvas.height);

        // Particules de fond
        C.shadowBlur = 0;
        this.bgParticles.forEach(p => {
            C.fillStyle = (lvl.color || '#00f3ff') + '18';
            C.beginPath();
            C.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            C.fill();
        });

        // Joueur
        C.shadowBlur  = 20;
        C.shadowColor = this.player.color;
        C.fillStyle   = this.player.color;
        C.fillRect(this.player.x, this.player.y, 30, 30);
        C.fillStyle = '#ffffff55';
        C.fillRect(this.player.x + 6, this.player.y + 6, 10, 10);

        // God mode indicator
        if (DevTools.godMode) {
            C.strokeStyle = '#ffcc00';
            C.lineWidth   = 2;
            C.shadowColor = '#ffcc00';
            C.shadowBlur  = 10;
            C.strokeRect(this.player.x - 4, this.player.y - 4, 38, 38);
        }

        // Ennemis
        this.enemies.forEach(e => {
            const c = e.color || '#ff3838';
            C.shadowBlur  = 14;
            C.shadowColor = c;
            C.fillStyle   = c;
            C.fillRect(e.x, e.y, e.size, e.size);
            // Contour tracker
            if (e.tracker) {
                C.strokeStyle = '#ffffff88';
                C.lineWidth   = 1;
                C.strokeRect(e.x - 3, e.y - 3, e.size + 6, e.size + 6);
            }
        });

        C.shadowBlur = 0;
    }
};

window.onload = () => Game.init();
</script>
</body>
</html>
