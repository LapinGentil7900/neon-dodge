<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON DODGE - PRO NETWORK</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>

<div id="layer-menu" class="screen">
    <div id="user-tag">Non connecté</div>
    <h1 class="neon-title">NEON DODGE</h1>
    <div class="menu-grid">
        <button class="btn" onclick="Game.start()">JOUER</button>
        <button class="btn btn-blue" onclick="UI.show('layer-shop')">BOUTIQUE</button>
        <button class="btn btn-blue" onclick="UI.show('layer-lead')">CLASSEMENT</button>
        <button class="btn btn-blue" onclick="UI.show('layer-auth')">COMPTE</button>
    </div>
    <div id="highscore-display">MEILLEUR : <span id="hs-val">0</span> pts</div>
</div>

<div id="layer-shop" class="screen" style="display:none;">
    <h2>BOUTIQUE DE SKINS</h2>
    <p>CRÉDITS : <span id="shop-credits">0</span></p>
    <div id="skin-list"></div>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<div id="layer-lead" class="screen" style="display:none;">
    <h2>TOP JOUEURS</h2>
    <div id="leaderboard-content"></div>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<div id="layer-auth" class="screen" style="display:none;">
    <h2>CONNEXION / INSCRIPTION</h2>
    <input type="text" id="auth-user" placeholder="Pseudo">
    <input type="password" id="auth-pass" placeholder="Mot de passe">
    <button class="btn" onclick="Auth.sign()">VALIDER</button>
    <button class="btn btn-red" onclick="UI.show('layer-menu')">RETOUR</button>
</div>

<div id="layer-game" style="display:none;">
    <canvas id="gameCanvas"></canvas>
    <div id="hud">
        <div id="score-container">SCORE: <span id="ui-score">0</span></div>
        <div id="level-container">
            <span id="ui-level-name">TUTORIAL</span>
            <div id="level-desc"></div>
        </div>
        <div id="tier-container"><span id="ui-tier"></span></div>
        <div id="next-level-bar">
            <div id="next-level-fill"></div>
            <span id="next-level-label"></span>
        </div>
    </div>
    <div id="level-announce"></div>
</div>

<script src="levels.js"></script>
<script src="stats_manager.js"></script>
<script>
    // --- AUTH ---
    const Auth = {
        currentUser: null,
        sign() {
            const user = document.getElementById('auth-user').value;
            if(user.length < 3) return alert("Pseudo trop court");
            this.currentUser = user;
            document.getElementById('user-tag').innerText = "Connecté: " + user;
            StatsManager.data.username = user;
            StatsManager.save();
            UI.show('layer-menu');
        }
    };

    // --- UI ---
    const UI = {
        show(id) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            const el = document.getElementById(id);
            if(el) el.style.display = 'flex';
            if(id === 'layer-shop') this.renderShop();
            if(id === 'layer-lead') this.renderLead();
            if(id === 'layer-menu') {
                document.getElementById('hs-val').innerText = StatsManager.data.highScore;
            }
        },
        renderShop() {
            const list = document.getElementById('skin-list');
            list.innerHTML = "";
            const skins = [
                {name: "Neon Blue", color: "#00f3ff", price: 0},
                {name: "Emerald", color: "#00ff88", price: 500},
                {name: "Ruby", color: "#ff3838", price: 1500},
                {name: "Gold", color: "#ffcc00", price: 3000},
                {name: "Violet", color: "#cc00ff", price: 5000},
                {name: "White", color: "#ffffff", price: 8000}
            ];
            document.getElementById('shop-credits').innerText = StatsManager.data.credits;
            skins.forEach(s => {
                const btn = document.createElement('button');
                btn.className = "btn-skin";
                btn.style.borderColor = s.color;
                btn.style.color = s.color;
                btn.innerText = `${s.name}\n${s.price > 0 ? s.price + ' cr' : 'GRATUIT'}`;
                btn.onclick = () => {
                    if(StatsManager.data.credits >= s.price) {
                        Game.player.color = s.color;
                        alert("Skin équipé !");
                    } else { alert("Pas assez de crédits"); }
                };
                list.appendChild(btn);
            });
        },
        renderLead() {
            const content = document.getElementById('leaderboard-content');
            content.innerHTML = `<p>1. ${Auth.currentUser || 'Joueur'} — ${StatsManager.data.highScore} pts</p>`;
        }
    };

    // --- GAME ENGINE ---
    const Game = {
        canvas: document.getElementById('gameCanvas'),
        ctx: null, running: false, score: 0,
        player: { x: 0, y: 0, size: 30, color: '#00f3ff' },
        enemies: [],
        currentLevelName: '',
        burstTimer: 0,
        glitchTimer: 0,
        bgParticles: [],

        init() {
            this.ctx = this.canvas.getContext('2d');
            this.resize();
            StatsManager.init();
            document.getElementById('hs-val').innerText = StatsManager.data.highScore;
            window.addEventListener('resize', () => this.resize());

            // Init bg particles
            for(let i = 0; i < 60; i++) {
                this.bgParticles.push({
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight,
                    size: Math.random() * 1.5 + 0.3,
                    speed: Math.random() * 0.4 + 0.1
                });
            }
        },

        resize() {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
        },

        start() {
            this.running = true; this.score = 0; this.enemies = [];
            this.burstTimer = 0; this.glitchTimer = 0;
            this.player.x = this.canvas.width / 2 - 15;
            this.player.y = this.canvas.height - 80;
            this.currentLevelName = '';

            document.getElementById('layer-menu').style.display = 'none';
            document.getElementById('layer-game').style.display = 'block';
            this.loop();
        },

        stop() {
            this.running = false;
            StatsManager.data.credits += Math.floor(this.score / 10);
            if(this.score > StatsManager.data.highScore) StatsManager.data.highScore = this.score;
            StatsManager.recordDeath();
            // Flash red on death
            this.canvas.style.filter = 'brightness(3) saturate(0)';
            setTimeout(() => {
                this.canvas.style.filter = '';
                UI.show('layer-menu');
            }, 300);
        },

        announceLevel(name, color, desc) {
            const el = document.getElementById('level-announce');
            el.innerText = name;
            el.style.color = color;
            el.style.opacity = '1';
            el.style.transform = 'scale(1.3)';
            if(desc) {
                const sub = document.createElement('div');
                sub.style.fontSize = '14px';
                sub.style.marginTop = '8px';
                sub.innerText = desc;
                el.appendChild(sub);
            }
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'scale(1)';
                setTimeout(() => el.innerHTML = el.innerText = name, 600);
            }, 2000);
        },

        loop() {
            if(!this.running) return;
            this.update(); this.draw();
            requestAnimationFrame(() => this.loop());
        },

        update() {
            const lvl = LevelSystem.getCurrentLevel(this.score);

            // Level change announce
            if(lvl.name !== this.currentLevelName) {
                this.currentLevelName = lvl.name;
                document.getElementById('ui-level-name').innerText = lvl.name;
                document.getElementById('ui-level-name').style.color = lvl.color || '#00f3ff';
                document.getElementById('level-desc').innerText = lvl.description || '';
                document.getElementById('ui-tier').innerText = LevelSystem.getTierName(this.score);
                this.announceLevel(lvl.name, lvl.color, lvl.description);
            }

            // Progress bar to next level
            const next = LevelSystem.getNextLevel(this.score);
            if(next) {
                const from = lvl.scoreReq;
                const to = next.scoreReq;
                const pct = Math.min(100, ((this.score - from) / (to - from)) * 100);
                document.getElementById('next-level-fill').style.width = pct + '%';
                document.getElementById('next-level-fill').style.background = lvl.color || '#00f3ff';
                document.getElementById('next-level-label').innerText = `→ ${next.name} (${next.scoreReq})`;
            } else {
                document.getElementById('next-level-fill').style.width = '100%';
                document.getElementById('next-level-label').innerText = '∞ MAX';
            }

            // Spawn standard
            if(Math.random() < lvl.rate) {
                this.spawnEnemy(lvl);
            }

            // Burst mode: volée de 5 ennemis
            if(lvl.burst) {
                this.burstTimer++;
                if(this.burstTimer >= 90) {
                    this.burstTimer = 0;
                    for(let i = 0; i < 5; i++) {
                        setTimeout(() => this.spawnEnemy(lvl), i * 80);
                    }
                }
            }

            // Glitch: flash + spawn surprise
            if(lvl.glitch) {
                this.glitchTimer++;
                if(this.glitchTimer >= 150) {
                    this.glitchTimer = 0;
                    this.canvas.style.filter = `hue-rotate(${Math.random()*360}deg) brightness(2)`;
                    setTimeout(() => this.canvas.style.filter = '', 120);
                    // Spawn surprise en cercle
                    for(let a = 0; a < 6; a++) {
                        const angle = (a / 6) * Math.PI * 2;
                        const e = this.createEnemy(lvl);
                        e.x = this.canvas.width/2 + Math.cos(angle) * 200;
                        e.y = -20;
                        e.vx = Math.cos(angle) * 2;
                        this.enemies.push(e);
                    }
                }
            }

            // Move + collide enemies
            for(let i = this.enemies.length - 1; i >= 0; i--) {
                const e = this.enemies[i];

                // Tracker
                if(e.tracker && this.running) {
                    const dx = this.player.x - e.x;
                    const dy = this.player.y - e.y;
                    const dist = Math.hypot(dx, dy) || 1;
                    e.x += (dx / dist) * e.trackSpeed;
                    e.y += (dy / dist) * e.trackSpeed;
                } else {
                    // Zigzag
                    if(e.zigzag) e.x += Math.sin(e.y * 0.05 + e.phase) * 3;
                    e.x += e.vx || 0;
                    e.y += e.speed;
                }

                // Collision
                if(Math.hypot(this.player.x + 15 - (e.x + 12), this.player.y + 15 - (e.y + 12)) < 28) {
                    this.stop(); return;
                }

                if(e.y > this.canvas.height + 50 || e.x < -100 || e.x > this.canvas.width + 100) {
                    this.enemies.splice(i, 1);
                    this.score += 10;
                }
            }

            // Update score display
            document.getElementById('ui-score').innerText = this.score;

            // Mouse control
            window.onmousemove = (ev) => { this.player.x = ev.clientX - 15; };

            // Bg particles
            this.bgParticles.forEach(p => {
                p.y += p.speed;
                if(p.y > this.canvas.height) p.y = 0;
            });
        },

        createEnemy(lvl) {
            return {
                x: Math.random() * this.canvas.width,
                y: -50,
                speed: lvl.speed + (Math.random() * 2 - 1),
                tracker: lvl.tracker && Math.random() < 0.4,
                trackSpeed: lvl.speed * 0.35,
                zigzag: lvl.zigzag && Math.random() < 0.5,
                phase: Math.random() * Math.PI * 2,
                color: lvl.color || '#ff3838',
                vx: 0,
                size: 20 + Math.random() * 10
            };
        },

        spawnEnemy(lvl) {
            this.enemies.push(this.createEnemy(lvl));
        },

        draw() {
            const lvl = LevelSystem.getCurrentLevel(this.score);
            const bg = lvl.bgColor || '#050505';

            // Background
            this.ctx.fillStyle = bg;
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

            // BG particles
            this.ctx.fillStyle = (lvl.color || '#00f3ff') + '22';
            this.bgParticles.forEach(p => {
                this.ctx.beginPath();
                this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                this.ctx.fill();
            });

            // Player
            this.ctx.shadowBlur = 20;
            this.ctx.shadowColor = this.player.color;
            this.ctx.fillStyle = this.player.color;
            this.ctx.fillRect(this.player.x, this.player.y, 30, 30);
            // Player core highlight
            this.ctx.fillStyle = '#ffffff66';
            this.ctx.fillRect(this.player.x + 5, this.player.y + 5, 10, 10);

            // Enemies
            this.enemies.forEach(e => {
                const c = e.color || '#ff3838';
                this.ctx.shadowBlur = 12;
                this.ctx.shadowColor = c;
                this.ctx.fillStyle = c;
                this.ctx.fillRect(e.x, e.y, e.size || 25, e.size || 25);
                // Tracker marker
                if(e.tracker) {
                    this.ctx.strokeStyle = '#ffffff';
                    this.ctx.lineWidth = 1;
                    this.ctx.strokeRect(e.x - 3, e.y - 3, (e.size||25) + 6, (e.size||25) + 6);
                }
            });

            this.ctx.shadowBlur = 0;
        }
    };

    window.onload = () => Game.init();
</script>
</body>
</html>
